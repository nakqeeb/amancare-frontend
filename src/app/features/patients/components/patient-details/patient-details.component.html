<!-- ===================================================================
// src/app/features/patients/components/patient-details/patient-details.component.html
// Patient Details Template
// =================================================================== -->
<app-header></app-header>

<app-sidebar>
  <div class="patient-details-container">
    <!-- Loading Spinner -->
    <div *ngIf="loading()" class="loading-container">
      <mat-spinner></mat-spinner>
      <p>جاري تحميل بيانات المريض...</p>
    </div>

    <!-- Patient Details -->
    <div *ngIf="!loading() && patient()" class="patient-content">
      <!-- Header with Patient Info -->
      <div class="patient-header">
        <div class="header-actions">
          <button
            mat-icon-button
            (click)="onBackToPatients()"
            matTooltip="العودة إلى قائمة المرضى"
          >
            <mat-icon>arrow_back</mat-icon>
          </button>
        </div>

        <mat-card class="patient-summary-card">
          <mat-card-content>
            <div class="patient-summary">
              <!-- Patient Avatar -->
              <div class="patient-avatar">
                <div
                  class="avatar-circle"
                  [class]="'avatar-' + patient()!.gender.toLowerCase()"
                >
                  {{ getInitials() }}
                </div>
                <div class="status-badge">
                  <mat-icon
                    [color]="getPatientStatus().color"
                    [matTooltip]="getPatientStatus().label"
                  >
                    {{ getPatientStatus().icon }}
                  </mat-icon>
                </div>
              </div>

              <!-- Patient Basic Info -->
              <div class="patient-basic-info">
                <h1 class="patient-name">{{ patient()!.fullName }}</h1>
                <p class="patient-number">
                  رقم المريض: {{ patient()!.patientNumber }}
                </p>

                <div class="patient-details-row">
                  <div class="detail-item">
                    <mat-icon>cake</mat-icon>
                    <span>{{ getPatientAge() }}</span>
                  </div>
                  <div class="detail-item">
                    <mat-icon>person</mat-icon>
                    <span>{{ getGenderLabel() }}</span>
                  </div>
                  <div class="detail-item">
                    <mat-icon>colorize</mat-icon>
                    <span>{{ getBloodTypeLabel() }}</span>
                  </div>
                  <div class="detail-item">
                    <mat-icon>phone</mat-icon>
                    <span>{{ formatPhone(patient()!.phone) }}</span>
                  </div>
                </div>

                <div class="patient-stats">
                  <div class="stat-item">
                    <span class="stat-number">{{ appointmentsCount() }}</span>
                    <span class="stat-label">المواعيد</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-number">{{ medicalRecordsCount() }}</span>
                    <span class="stat-label">السجلات الطبية</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-number">{{ invoicesCount() }}</span>
                    <span class="stat-label">الفواتير</span>
                  </div>
                  <div class="stat-item" *ngIf="outstandingBalance() > 0">
                    <span
                      class="stat-number"
                      [class.balance-warning]="outstandingBalance() > 0"
                    ></span>
                    <span class="stat-label">المتبقي</span>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="patient-actions">
                <button
                  mat-raised-button
                  color="primary"
                  *ngIf="canEditPatient()"
                  (click)="onEditPatient()"
                >
                  <mat-icon>edit</mat-icon>
                  تعديل البيانات
                </button>

                <button
                  mat-raised-button
                  color="accent"
                  *ngIf="canCreateAppointment()"
                  (click)="onCreateAppointment()"
                >
                  <mat-icon>event_note</mat-icon>
                  موعد جديد
                </button>

                <button mat-button [matMenuTriggerFor]="moreMenu">
                  <mat-icon>more_vert</mat-icon>
                  المزيد
                </button>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Tabs Section -->
      <mat-card class="tabs-card">
        <mat-tab-group
          [(selectedIndex)]="activeTabIndex"
          (selectedTabChange)="onTabChange($event.index)"
          animationDuration="300ms"
        >
          <!-- Overview Tab -->
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon>person</mat-icon>
              <span>معلومات عامة</span>
            </ng-template>

            <div class="tab-content overview-tab">
              <div class="overview-grid">
                <!-- Personal Information -->
                <mat-card class="info-card">
                  <mat-card-header>
                    <mat-card-title>
                      <mat-icon>person</mat-icon>
                      المعلومات الشخصية
                    </mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <div class="info-grid">
                      <div class="info-item">
                        <label>الاسم الأول:</label>
                        <span>{{ patient()!.firstName }}</span>
                      </div>
                      <div class="info-item">
                        <label>الاسم الأخير:</label>
                        <span>{{ patient()!.lastName }}</span>
                      </div>
                      <div class="info-item">
                        <label>تاريخ الميلاد:</label>
                        <span>{{ formatDate(patient()!.dateOfBirth) }}</span>
                      </div>
                      <div class="info-item">
                        <label>العمر:</label>
                        <span>{{ getPatientAge() }}</span>
                      </div>
                      <div class="info-item">
                        <label>الجنس:</label>
                        <span>{{ getGenderLabel() }}</span>
                      </div>
                      <div class="info-item">
                        <label>فصيلة الدم:</label>
                        <span>{{ getBloodTypeLabel() }}</span>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>

                <!-- Contact Information -->
                <mat-card class="info-card">
                  <mat-card-header>
                    <mat-card-title>
                      <mat-icon>contact_phone</mat-icon>
                      معلومات الاتصال
                    </mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <div class="info-grid">
                      <div class="info-item">
                        <label>رقم الهاتف:</label>
                        <span>{{ formatPhone(patient()!.phone) }}</span>
                      </div>
                      <div class="info-item" *ngIf="patient()!.email">
                        <label>البريد الإلكتروني:</label>
                        <span>{{ patient()!.email }}</span>
                      </div>
                      <div
                        class="info-item full-width"
                        *ngIf="patient()!.address"
                      >
                        <label>العنوان:</label>
                        <span>{{ patient()!.address }}</span>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>

                <!-- Emergency Contact -->
                <mat-card
                  class="info-card"
                  *ngIf="
                    patient()!.emergencyContactName ||
                    patient()!.emergencyContactPhone
                  "
                >
                  <mat-card-header>
                    <mat-card-title>
                      <mat-icon>emergency</mat-icon>
                      جهة الاتصال في الطوارئ
                    </mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <div class="info-grid">
                      <div
                        class="info-item"
                        *ngIf="patient()!.emergencyContactName"
                      >
                        <label>الاسم:</label>
                        <span>{{ patient()!.emergencyContactName }}</span>
                      </div>
                      <div
                        class="info-item"
                        *ngIf="patient()!.emergencyContactPhone"
                      >
                        <label>رقم الهاتف:</label>
                        <span>{{
                          formatPhone(patient()!.emergencyContactPhone!)
                        }}</span>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>

                <!-- Medical Information -->
                <mat-card class="info-card">
                  <mat-card-header>
                    <mat-card-title>
                      <mat-icon>local_hospital</mat-icon>
                      المعلومات الطبية
                    </mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <div class="info-grid">
                      <div
                        class="info-item full-width"
                        *ngIf="patient()!.allergies"
                      >
                        <label>الحساسية:</label>
                        <span>{{ patient()!.allergies }}</span>
                      </div>
                      <div
                        class="info-item full-width"
                        *ngIf="patient()!.chronicDiseases"
                      >
                        <label>الأمراض المزمنة:</label>
                        <span>{{ patient()!.chronicDiseases }}</span>
                      </div>
                      <div
                        class="info-item full-width"
                        *ngIf="patient()!.notes"
                      >
                        <label>ملاحظات:</label>
                        <span>{{ patient()!.notes }}</span>
                      </div>
                      <div
                        class="info-item"
                        *ngIf="
                          !patient()!.allergies &&
                          !patient()!.chronicDiseases &&
                          !patient()!.notes
                        "
                      >
                        <span class="no-data">لا توجد معلومات طبية مسجلة</span>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>

                <!-- Registration Information -->
                <mat-card class="info-card">
                  <mat-card-header>
                    <mat-card-title>
                      <mat-icon>info</mat-icon>
                      معلومات التسجيل
                    </mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <div class="info-grid">
                      <div class="info-item">
                        <label>تاريخ التسجيل:</label>
                        <span>{{ formatDate(patient()!.createdAt) }}</span>
                      </div>
                      <div class="info-item" *ngIf="patient()!.updatedAt">
                        <label>آخر تحديث:</label>
                        <span>{{ formatDate(patient()!.updatedAt!) }}</span>
                      </div>
                      <div class="info-item">
                        <label>آخر زيارة:</label>
                        <span>{{ getLastVisitText() }}</span>
                      </div>
                      <div class="info-item">
                        <label>الحالة:</label>
                        <mat-chip [color]="getPatientStatus().color">
                          {{ getPatientStatus().label }}
                        </mat-chip>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>

                <!-- Quick Actions -->
                <mat-card class="info-card">
                  <mat-card-header>
                    <mat-card-title>
                      <mat-icon>flash_on</mat-icon>
                      إجراءات سريعة
                    </mat-card-title>
                  </mat-card-header>
                  <mat-card-content>
                    <div class="quick-actions">
                      <button
                        mat-raised-button
                        color="primary"
                        *ngIf="canCreateAppointment()"
                        (click)="onCreateAppointment()"
                      >
                        <mat-icon>event_note</mat-icon>
                        موعد جديد
                      </button>

                      <button
                        mat-raised-button
                        color="accent"
                        *ngIf="canViewMedicalRecords()"
                        (click)="onViewMedicalHistory()"
                      >
                        <mat-icon>local_hospital</mat-icon>
                        السجلات الطبية
                      </button>

                      <button
                        mat-raised-button
                        *ngIf="canCreateInvoice()"
                        (click)="onCreateInvoice()"
                      >
                        <mat-icon>receipt</mat-icon>
                        فاتورة جديدة
                      </button>

                      <button mat-stroked-button (click)="onPrintPatientCard()">
                        <mat-icon>print</mat-icon>
                        بطاقة المريض
                      </button>
                    </div>
                  </mat-card-content>
                </mat-card>
              </div>
            </div>
          </mat-tab>

         <!-- Appointments Tab -->
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon>event</mat-icon>
              <span>المواعيد</span>
              <span *ngIf="appointmentsCount() > 0" class="tab-badge">{{
                appointmentsCount()
              }}</span>
            </ng-template>

            <div class="tab-content">
              <mat-card class="appointments-card">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon>event</mat-icon>
                    المواعيد القادمة
                  </mat-card-title>
                  <button mat-icon-button (click)="refreshAppointments()" matTooltip="تحديث">
                    <mat-icon>refresh</mat-icon>
                  </button>
                </mat-card-header>

                <mat-card-content>
                  <!-- Loading State -->
                  <div *ngIf="loadingAppointments()" class="loading-state">
                    <mat-spinner diameter="40"></mat-spinner>
                    <p>جاري تحميل المواعيد...</p>
                  </div>

                  <!-- No Appointments State -->
                  <div *ngIf="!loadingAppointments() && upcomingAppointments().length === 0" class="empty-state">
                    <mat-icon>event_busy</mat-icon>
                    <h3>لا توجد مواعيد قادمة</h3>
                    <p>لا يوجد مواعيد مجدولة لهذا المريض</p>
                    <button mat-raised-button color="primary" (click)="onNewAppointment()">
                      <mat-icon>add</mat-icon>
                      حجز موعد جديد
                    </button>
                  </div>

                  <!-- Appointments Table -->
                  <div *ngIf="!loadingAppointments() && upcomingAppointments().length > 0" class="appointments-table-container">
                    <table mat-table [dataSource]="upcomingAppointments()" class="appointments-table">

                      <!-- Date Column -->
                      <ng-container matColumnDef="appointmentDate">
                        <th mat-header-cell *matHeaderCellDef>التاريخ</th>
                        <td mat-cell *matCellDef="let appointment">
                          {{ formatAppointmentDate(appointment.appointmentDate) }}
                        </td>
                      </ng-container>

                      <!-- Time Column -->
                      <ng-container matColumnDef="appointmentTime">
                        <th mat-header-cell *matHeaderCellDef>الوقت</th>
                        <td mat-cell *matCellDef="let appointment">
                          {{ formatAppointmentTime(appointment.appointmentTime) }}
                        </td>
                      </ng-container>

                      <!-- Doctor Column -->
                      <ng-container matColumnDef="doctor">
                        <th mat-header-cell *matHeaderCellDef>الطبيب</th>
                        <td mat-cell *matCellDef="let appointment">
                          {{ appointment.doctorName }}
                        </td>
                      </ng-container>

                      <!-- Type Column -->
                      <ng-container matColumnDef="type">
                        <th mat-header-cell *matHeaderCellDef>النوع</th>
                        <td mat-cell *matCellDef="let appointment">
                          <mat-chip>
                            {{ getAppointmentTypeLabel(appointment.appointmentType) }}
                          </mat-chip>
                        </td>
                      </ng-container>

                      <!-- Status Column -->
                      <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef>الحالة</th>
                        <td mat-cell *matCellDef="let appointment">
                          <mat-chip [color]="getAppointmentStatusColor(appointment.status)">
                            {{ getAppointmentStatusLabel(appointment.status) }}
                          </mat-chip>
                        </td>
                      </ng-container>

                      <!-- Actions Column -->
                      <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef>الإجراءات</th>
                        <td mat-cell *matCellDef="let appointment">
                          <button mat-icon-button
                                  [matMenuTriggerFor]="appointmentMenu"
                                  matTooltip="خيارات">
                            <mat-icon>more_vert</mat-icon>
                          </button>
                          <mat-menu #appointmentMenu="matMenu">
                            <button mat-menu-item (click)="onViewAppointment(appointment.id)">
                              <mat-icon>visibility</mat-icon>
                              <span>عرض التفاصيل</span>
                            </button>
                            <button mat-menu-item (click)="onRescheduleAppointment(appointment.id)">
                              <mat-icon>schedule</mat-icon>
                              <span>إعادة جدولة</span>
                            </button>
                            <button mat-menu-item
                                    (click)="onCancelAppointment(appointment)"
                                    class="cancel-button">
                              <mat-icon>cancel</mat-icon>
                              <span>إلغاء الموعد</span>
                            </button>
                          </mat-menu>
                        </td>
                      </ng-container>

                      <tr mat-header-row *matHeaderRowDef="appointmentsDisplayedColumns"></tr>
                      <tr mat-row *matRowDef="let row; columns: appointmentsDisplayedColumns;"></tr>
                    </table>

                    <!-- Add New Appointment Button -->
                    <div class="table-footer">
                      <button mat-raised-button color="primary" (click)="onNewAppointment()">
                        <mat-icon>add</mat-icon>
                        حجز موعد جديد
                      </button>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </mat-tab>


          <!-- Medical Records Tab -->
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon>local_hospital</mat-icon>
              <span>السجلات الطبية</span>
              <span *ngIf="medicalRecordsCount() > 0" class="tab-badge">{{
                medicalRecordsCount()
              }}</span>
            </ng-template>

            <div class="tab-content">
              <div class="coming-soon">
                <mat-icon>local_hospital</mat-icon>
                <h3>قريباً: السجلات الطبية</h3>
                <p>ستتمكن هنا من عرض السجلات الطبية للمريض</p>
              </div>
            </div>
          </mat-tab>

          <!-- Invoices Tab -->
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon>receipt</mat-icon>
              <span>الفواتير</span>
              <span *ngIf="invoicesCount() > 0" class="tab-badge">{{
                invoicesCount()
              }}</span>
            </ng-template>

            <div class="tab-content">
              <div class="coming-soon">
                <mat-icon>receipt</mat-icon>
                <h3>قريباً: عرض الفواتير</h3>
                <p>ستتمكن هنا من عرض فواتير المريض</p>
              </div>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card>
    </div>

    <!-- More Actions Menu -->
    <mat-menu #moreMenu="matMenu">
      <button mat-menu-item (click)="onPrintPatientCard()">
        <mat-icon>print</mat-icon>
        <span>طباعة بطاقة المريض</span>
      </button>

      <button mat-menu-item (click)="onExportPatientData()">
        <mat-icon>file_download</mat-icon>
        <span>تصدير البيانات</span>
      </button>

      <mat-divider></mat-divider>

      <button
        mat-menu-item
        *ngIf="canReactivatePatient() && !patient()!.active"
        (click)="onReactivatePatient()"
      >
        <mat-icon color="primary">restore</mat-icon>
        <span>إعادة تفعيل المريض</span>
      </button>

      <!-- <button
        mat-menu-item
        *ngIf="canDeletePatient() && patient()!.isActive"
        (click)="onDeletePatient()"
      >
        <mat-icon color="warn">delete</mat-icon>
        <span>حذف المريض</span>
      </button> -->

      <!-- Soft Delete -->
      <button
        mat-menu-item
        *ngIf="canDeletePatient() && patient()!.active"
        (click)="onDeletePatient()"
        class="danger-menu-item"
      >
        <mat-icon color="warn">delete</mat-icon>
        <span>إلغاء التفعيل</span>
      </button>

      <!-- Permanent Delete - SYSTEM_ADMIN Only -->
      <button
        mat-menu-item
        *ngIf="canPermanentlyDelete()"
        (click)="onDeletePatient(true)"
        class="permanent-delete-menu-item"
      >
        <mat-icon class="danger-icon">delete_forever</mat-icon>
        <span class="danger-text">حذف نهائي (لا يمكن التراجع)</span>
      </button>
    </mat-menu>
  </div>
</app-sidebar>
