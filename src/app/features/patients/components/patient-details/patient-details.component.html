<app-header></app-header>

<app-sidebar>
  <div class="patient-details-container">
    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading()">
      <mat-card class="loading-card">
        <mat-card-content>
          <div class="loading-content">
            <mat-spinner diameter="40"></mat-spinner>
            <p>جاري تحميل بيانات المريض...</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Patient Details -->
    <div class="patient-content" *ngIf="!loading() && patient()">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-navigation">
          <button mat-icon-button routerLink="/patients" class="back-button">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <div class="breadcrumb">
            <a routerLink="/patients" class="breadcrumb-link">المرضى</a>
            <mat-icon class="breadcrumb-separator">chevron_left</mat-icon>
            <span class="breadcrumb-current">{{ patient()?.fullName }}</span>
          </div>
        </div>

        <div class="header-actions">
          <button
            mat-raised-button
            color="primary"
            routerLink="/appointments/new"
            [queryParams]="{ patientId: patient()?.id }"
          >
            <mat-icon>event_available</mat-icon>
            حجز موعد
          </button>

          <button mat-stroked-button [matMenuTriggerFor]="actionsMenu">
            <mat-icon>more_vert</mat-icon>
            المزيد
          </button>
        </div>
      </div>

      <!-- Patient Profile Card -->
      <mat-card class="profile-card">
        <mat-card-content>
          <div class="profile-header">
            <div
              class="patient-avatar"
              [class.male]="patient()?.gender === 'MALE'"
            >
              <mat-icon>{{
                patient()?.gender === "MALE" ? "face" : "face_3"
              }}</mat-icon>
            </div>

            <div class="patient-info">
              <div class="patient-name-section">
                <h1 class="patient-name">{{ patient()?.fullName }}</h1>
                <div class="patient-status">
                  <mat-chip
                    [class]="
                      patient()?.isActive ? 'status-active' : 'status-inactive'
                    "
                  >
                    {{ patient()?.isActive ? "نشط" : "غير نشط" }}
                  </mat-chip>
                </div>
              </div>

              <div class="patient-meta">
                <div class="meta-item">
                  <mat-icon>tag</mat-icon>
                  <span class="meta-label">رقم المريض:</span>
                  <span class="meta-value">{{ patient()?.patientNumber }}</span>
                </div>

                <div class="meta-item" *ngIf="patient()?.age">
                  <mat-icon>cake</mat-icon>
                  <span class="meta-label">العمر:</span>
                  <span class="meta-value">{{ patient()?.age }} سنة</span>
                </div>

                <div class="meta-item">
                  <mat-icon>person</mat-icon>
                  <span class="meta-label">الجنس:</span>
                  <span class="meta-value">{{
                    getGenderText(patient()?.gender)
                  }}</span>
                </div>

                <div class="meta-item" *ngIf="patient()?.bloodType">
                  <mat-icon>colorize</mat-icon>
                  <span class="meta-label">فصيلة الدم:</span>
                  <span class="meta-value">{{
                    getBloodTypeLabel(patient()?.bloodType)
                  }}</span>
                </div>
              </div>
            </div>

            <div class="patient-stats">
              <div class="stat-item">
                <span class="stat-number">{{
                  patient()?.appointmentsCount || 0
                }}</span>
                <span class="stat-label">المواعيد</span>
              </div>
              <div class="stat-item">
                <span class="stat-number">{{
                  patient()?.totalInvoices || 0
                }}</span>
                <span class="stat-label">الفواتير</span>
              </div>
              <div
                class="stat-item"
                [class.warning]="(patient()?.outstandingBalance || 0) > 0"
              >
                <span class="stat-number">{{
                  patient()?.outstandingBalance || 0
                }}</span>
                <span class="stat-label">المستحق</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <button
          mat-stroked-button
          class="quick-action"
          routerLink="/appointments/new"
          [queryParams]="{ patientId: patient()?.id }"
        >
          <mat-icon>event_available</mat-icon>
          حجز موعد
        </button>

        <button
          mat-stroked-button
          class="quick-action"
          routerLink="/medical-records/new"
          [queryParams]="{ patientId: patient()?.id }"
        >
          <mat-icon>note_add</mat-icon>
          سجل طبي
        </button>

        <button
          mat-stroked-button
          class="quick-action"
          routerLink="/invoices/new"
          [queryParams]="{ patientId: patient()?.id }"
        >
          <mat-icon>receipt_long</mat-icon>
          فاتورة جديدة
        </button>

        <button
          mat-stroked-button
          class="quick-action"
          (click)="onEditPatient()"
        >
          <mat-icon>edit</mat-icon>
          تعديل البيانات
        </button>
      </div>

      <!-- Tabs Content -->
      <mat-card class="tabs-card">
        <mat-tab-group class="patient-tabs" animationDuration="300ms">
          <!-- Personal Information Tab -->
          <mat-tab label="المعلومات الشخصية">
            <div class="tab-content">
              <div class="info-sections">
                <!-- Contact Information -->
                <div class="info-section">
                  <h3 class="section-title">
                    <mat-icon>contact_phone</mat-icon>
                    معلومات الاتصال
                  </h3>

                  <div class="info-grid">
                    <div class="info-item">
                      <mat-icon class="info-icon">phone</mat-icon>
                      <div class="info-content">
                        <span class="info-label">رقم الهاتف</span>
                        <span class="info-value">{{
                          patient()?.phone || "-"
                        }}</span>
                      </div>
                      <button
                        mat-icon-button
                        *ngIf="patient()?.phone"
                        (click)="callPatient(patient()?.phone!)"
                      >
                        <mat-icon>call</mat-icon>
                      </button>
                    </div>

                    <div class="info-item">
                      <mat-icon class="info-icon">email</mat-icon>
                      <div class="info-content">
                        <span class="info-label">البريد الإلكتروني</span>
                        <span class="info-value">{{
                          patient()?.email || "-"
                        }}</span>
                      </div>
                      <button
                        mat-icon-button
                        *ngIf="patient()?.email"
                        (click)="emailPatient(patient()?.email!)"
                      >
                        <mat-icon>mail</mat-icon>
                      </button>
                    </div>

                    <div
                      class="info-item full-width"
                      *ngIf="patient()?.address"
                    >
                      <mat-icon class="info-icon">location_on</mat-icon>
                      <div class="info-content">
                        <span class="info-label">العنوان</span>
                        <span class="info-value">{{ patient()?.address }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Emergency Contact -->
                <div
                  class="info-section"
                  *ngIf="
                    patient()?.emergencyContactName ||
                    patient()?.emergencyContactPhone
                  "
                >
                  <h3 class="section-title">
                    <mat-icon>emergency</mat-icon>
                    جهة اتصال الطوارئ
                  </h3>

                  <div class="info-grid">
                    <div
                      class="info-item"
                      *ngIf="patient()?.emergencyContactName"
                    >
                      <mat-icon class="info-icon">person</mat-icon>
                      <div class="info-content">
                        <span class="info-label">اسم جهة الاتصال</span>
                        <span class="info-value">{{
                          patient()?.emergencyContactName
                        }}</span>
                      </div>
                    </div>

                    <div
                      class="info-item"
                      *ngIf="patient()?.emergencyContactPhone"
                    >
                      <mat-icon class="info-icon">phone</mat-icon>
                      <div class="info-content">
                        <span class="info-label">رقم الهاتف</span>
                        <span class="info-value">{{
                          patient()?.emergencyContactPhone
                        }}</span>
                      </div>
                      <button
                        mat-icon-button
                        (click)="callPatient(patient()?.emergencyContactPhone!)"
                      >
                        <mat-icon>call</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Additional Information -->
                <div
                  class="info-section"
                  *ngIf="patient()?.dateOfBirth || patient()?.notes"
                >
                  <h3 class="section-title">
                    <mat-icon>info</mat-icon>
                    معلومات إضافية
                  </h3>

                  <div class="info-grid">
                    <div class="info-item" *ngIf="patient()?.dateOfBirth">
                      <mat-icon class="info-icon">cake</mat-icon>
                      <div class="info-content">
                        <span class="info-label">تاريخ الميلاد</span>
                        <span class="info-value">{{
                          formatDate(patient()?.dateOfBirth!)
                        }}</span>
                      </div>
                    </div>

                    <div class="info-item full-width" *ngIf="patient()?.notes">
                      <mat-icon class="info-icon">note</mat-icon>
                      <div class="info-content">
                        <span class="info-label">ملاحظات</span>
                        <span class="info-value notes-text">{{
                          patient()?.notes
                        }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </mat-tab>

          <!-- Medical Information Tab -->
          <mat-tab label="المعلومات الطبية">
            <div class="tab-content">
              <div class="info-sections">
                <!-- Medical Details -->
                <div class="info-section">
                  <h3 class="section-title">
                    <mat-icon>medical_information</mat-icon>
                    المعلومات الطبية الأساسية
                  </h3>

                  <div class="info-grid">
                    <div class="info-item" *ngIf="patient()?.bloodType">
                      <mat-icon class="info-icon medical">colorize</mat-icon>
                      <div class="info-content">
                        <span class="info-label">فصيلة الدم</span>
                        <span class="info-value medical-value">{{
                          getBloodTypeLabel(patient()?.bloodType)
                        }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Allergies -->
                <div class="info-section" *ngIf="patient()?.allergies">
                  <h3 class="section-title warning">
                    <mat-icon>warning</mat-icon>
                    الحساسيات
                  </h3>

                  <div class="medical-content">
                    <div class="allergies-list">
                      <mat-chip-set>
                        <mat-chip
                          *ngFor="
                            let allergy of getAllergiesList(
                              patient()?.allergies!
                            )
                          "
                          class="allergy-chip"
                        >
                          <mat-icon matChipLeading>warning</mat-icon>
                          {{ allergy }}
                        </mat-chip>
                      </mat-chip-set>
                    </div>
                  </div>
                </div>

                <!-- Chronic Diseases -->
                <div class="info-section" *ngIf="patient()?.chronicDiseases">
                  <h3 class="section-title medical">
                    <mat-icon>medical_services</mat-icon>
                    الأمراض المزمنة
                  </h3>

                  <div class="medical-content">
                    <div class="diseases-list">
                      <mat-chip-set>
                        <mat-chip
                          *ngFor="
                            let disease of getDiseasesList(
                              patient()?.chronicDiseases!
                            )
                          "
                          class="disease-chip"
                        >
                          <mat-icon matChipLeading>medical_services</mat-icon>
                          {{ disease }}
                        </mat-chip>
                      </mat-chip-set>
                    </div>
                  </div>
                </div>

                <!-- Empty State -->
                <div
                  class="empty-medical"
                  *ngIf="
                    !patient()?.bloodType &&
                    !patient()?.allergies &&
                    !patient()?.chronicDiseases
                  "
                >
                  <mat-icon class="empty-icon">medical_information</mat-icon>
                  <p>لا توجد معلومات طبية مسجلة</p>
                  <button
                    mat-raised-button
                    color="primary"
                    (click)="onEditPatient()"
                  >
                    <mat-icon>edit</mat-icon>
                    إضافة معلومات طبية
                  </button>
                </div>
              </div>
            </div>
          </mat-tab>

          <!-- Appointments History Tab -->
          <mat-tab
            label="تاريخ المواعيد"
            [matBadge]="patient()?.appointmentsCount || 0"
          >
            <div class="tab-content">
              <div class="appointments-header">
                <h3>تاريخ المواعيد</h3>
                <button
                  mat-raised-button
                  color="primary"
                  routerLink="/appointments/new"
                  [queryParams]="{ patientId: patient()?.id }"
                >
                  <mat-icon>add</mat-icon>
                  حجز موعد جديد
                </button>
              </div>

              <!-- Mock Appointments List -->
              <div class="appointments-list">
                <mat-card
                  *ngFor="let appointment of mockAppointments"
                  class="appointment-card"
                  [class]="'status-' + appointment.status.toLowerCase()"
                >
                  <mat-card-content>
                    <div class="appointment-header">
                      <div class="appointment-date">
                        <mat-icon>event</mat-icon>
                        <span>{{ appointment.date }}</span>
                        <span class="appointment-time">{{
                          appointment.time
                        }}</span>
                      </div>
                      <mat-chip
                        [class]="'status-' + appointment.status.toLowerCase()"
                      >
                        {{ getAppointmentStatusText(appointment.status) }}
                      </mat-chip>
                    </div>

                    <div class="appointment-details">
                      <p class="appointment-type">
                        <mat-icon>medical_services</mat-icon>
                        {{ appointment.type }}
                      </p>
                      <p class="appointment-doctor" *ngIf="appointment.doctor">
                        <mat-icon>person</mat-icon>
                        د. {{ appointment.doctor }}
                      </p>
                      <p class="appointment-notes" *ngIf="appointment.notes">
                        <mat-icon>note</mat-icon>
                        {{ appointment.notes }}
                      </p>
                    </div>
                  </mat-card-content>
                </mat-card>

                <!-- Empty State -->
                <div
                  class="empty-appointments"
                  *ngIf="mockAppointments.length === 0"
                >
                  <mat-icon class="empty-icon">event_busy</mat-icon>
                  <p>لا توجد مواعيد مسجلة</p>
                  <button
                    mat-raised-button
                    color="primary"
                    routerLink="/appointments/new"
                    [queryParams]="{ patientId: patient()?.id }"
                  >
                    <mat-icon>add</mat-icon>
                    حجز أول موعد
                  </button>
                </div>
              </div>
            </div>
          </mat-tab>

          <!-- Financial Tab -->
          <mat-tab
            label="المالية"
            [matBadge]="patient()?.outstandingBalance ? '!' : ''"
          >
            <div class="tab-content">
              <div class="financial-summary">
                <div class="summary-cards">
                  <mat-card class="summary-card">
                    <mat-card-content>
                      <div class="summary-header">
                        <mat-icon>receipt_long</mat-icon>
                        <h4>إجمالي الفواتير</h4>
                      </div>
                      <div class="summary-value">
                        {{ patient()?.totalInvoices || 0 }}
                      </div>
                    </mat-card-content>
                  </mat-card>

                  <mat-card class="summary-card">
                    <mat-card-content>
                      <div class="summary-header">
                        <mat-icon>attach_money</mat-icon>
                        <h4>إجمالي المبلغ</h4>
                      </div>
                      <div class="summary-value">12,450 ريال</div>
                    </mat-card-content>
                  </mat-card>

                  <mat-card
                    class="summary-card"
                    [class.warning]="(patient()?.outstandingBalance || 0) > 0"
                  >
                    <mat-card-content>
                      <div class="summary-header">
                        <mat-icon>warning</mat-icon>
                        <h4>المبلغ المستحق</h4>
                      </div>
                      <div class="summary-value">
                        {{ patient()?.outstandingBalance || 0 }} ريال
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>

              <!-- Mock Invoices -->
              <div class="invoices-section">
                <div class="section-header">
                  <h3>الفواتير الأخيرة</h3>
                  <button
                    mat-stroked-button
                    routerLink="/invoices"
                    [queryParams]="{ patientId: patient()?.id }"
                  >
                    عرض جميع الفواتير
                  </button>
                </div>

                <div class="invoices-list">
                  <!-- Mock invoice items -->
                  <mat-card class="invoice-card">
                    <mat-card-content>
                      <div class="invoice-header">
                        <span class="invoice-number">INV-2024-001</span>
                        <mat-chip class="status-paid">مدفوع</mat-chip>
                      </div>
                      <div class="invoice-details">
                        <span class="invoice-date">2024-08-20</span>
                        <span class="invoice-amount">350 ريال</span>
                      </div>
                    </mat-card-content>
                  </mat-card>

                  <mat-card class="invoice-card">
                    <mat-card-content>
                      <div class="invoice-header">
                        <span class="invoice-number">INV-2024-002</span>
                        <mat-chip class="status-pending">معلق</mat-chip>
                      </div>
                      <div class="invoice-details">
                        <span class="invoice-date">2024-08-25</span>
                        <span class="invoice-amount">150 ريال</span>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="!loading() && !patient()">
      <mat-card class="error-card">
        <mat-card-content>
          <div class="error-content">
            <mat-icon class="error-icon">error</mat-icon>
            <h2>المريض غير موجود</h2>
            <p>لم يتم العثور على المريض المطلوب</p>
            <button mat-raised-button color="primary" routerLink="/patients">
              <mat-icon>people</mat-icon>
              العودة لقائمة المرضى
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</app-sidebar>

<!-- Actions Menu -->
<mat-menu #actionsMenu="matMenu">
  <button mat-menu-item (click)="onEditPatient()">
    <mat-icon>edit</mat-icon>
    تعديل البيانات
  </button>
  <button mat-menu-item (click)="onPrintProfile()">
    <mat-icon>print</mat-icon>
    طباعة الملف
  </button>
  <button mat-menu-item (click)="onExportProfile()">
    <mat-icon>file_download</mat-icon>
    تصدير البيانات
  </button>
  <mat-divider></mat-divider>
  <button mat-menu-item (click)="onDeletePatient()" *ngIf="patient()?.isActive">
    <mat-icon color="warn">delete</mat-icon>
    <span class="text-warn">حذف المريض</span>
  </button>
  <button
    mat-menu-item
    (click)="onRestorePatient()"
    *ngIf="!patient()?.isActive"
  >
    <mat-icon color="primary">restore</mat-icon>
    إعادة تفعيل
  </button>
</mat-menu>
