<!-- ===================================================================
// src/app/features/patients/components/patient-list/patient-list.component.html
// Updated Patient List Template - Fixed with @if/@for and corrected errors
// =================================================================== -->
<app-header></app-header>

<app-sidebar>
  <div class="patients-container">

    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <h1 class="page-title">
          <mat-icon class="page-icon">people</mat-icon>
          إدارة المرضى
        </h1>
        <p class="page-subtitle">عرض وإدارة جميع مرضى العيادة</p>

        <!-- Statistics Summary -->
        @if (statistics()) {
          <div class="statistics-summary">
            <mat-chip-listbox class="stats-chips">
              <mat-chip-option disabled>
                <mat-icon>people</mat-icon>
                إجمالي: {{ statistics()!.totalPatients }}
              </mat-chip-option>
              <mat-chip-option disabled>
                <mat-icon>check_circle</mat-icon>
                نشط: {{ statistics()!.activePatients }}
              </mat-chip-option>
              <mat-chip-option disabled>
                <mat-icon>new_releases</mat-icon>
                جديد: {{ statistics()!.newPatientsThisMonth }}
              </mat-chip-option>
              @if (statistics()!.patientsWithAppointmentsToday > 0) {
                <mat-chip-option disabled>
                  <mat-icon>event</mat-icon>
                  اليوم: {{ statistics()!.patientsWithAppointmentsToday }}
                </mat-chip-option>
              }
            </mat-chip-listbox>
          </div>
        }
      </div>

      <div class="header-actions">
        <button
          mat-raised-button
          color="primary"
          (click)="onAddPatient()"
          class="add-button"
        >
          <mat-icon>person_add</mat-icon>
          إضافة مريض جديد
        </button>

        <button
          mat-stroked-button
          [matMenuTriggerFor]="exportMenu"
          class="export-button"
        >
          <mat-icon>file_download</mat-icon>
          تصدير
        </button>

        <button
          mat-icon-button
          (click)="onRefresh()"
          [disabled]="loading()"
          matTooltip="تحديث البيانات"
        >
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
    </div>

    <!-- Search & Filter Section -->
    <mat-card class="search-card">
      <mat-card-content>
        <form [formGroup]="searchForm" class="search-form">
          <div class="search-row">

            <!-- Main Search Input -->
            <mat-form-field appearance="outline" class="search-field">
              <mat-label>البحث</mat-label>
              <input
                matInput
                formControlName="searchTerm"
                placeholder="البحث بالاسم، رقم المريض، أو الهاتف..."
                (keyup.enter)="onSearch()"
              />
              <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <!-- Quick Filters -->
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>الجنس</mat-label>
              <mat-select formControlName="gender">
                <mat-option value="">الكل</mat-option>
                @for (gender of genders; track gender.value) {
                  <mat-option [value]="gender.value">
                    <mat-icon>{{ gender.value }}</mat-icon>
                    {{ gender.label }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>فصيلة الدم</mat-label>
              <mat-select formControlName="bloodType">
                <mat-option value="">الكل</mat-option>
                @for (bloodType of bloodTypes; track bloodType.value) {
                  <mat-option [value]="bloodType.value">
                    {{ bloodType.label }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>

            <!-- Age Range -->
            <div class="age-range-group">
              <mat-form-field appearance="outline" class="age-field">
                <mat-label>من العمر</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="ageFrom"
                  placeholder="0"
                  min="0"
                  max="150"
                />
              </mat-form-field>
              <span class="age-separator">-</span>
              <mat-form-field appearance="outline" class="age-field">
                <mat-label>إلى</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="ageTo"
                  placeholder="150"
                  min="0"
                  max="150"
                />
              </mat-form-field>
            </div>

            <!-- Status Checkbox -->
            <div class="status-checkbox">
              <mat-checkbox formControlName="showInactive">
                عرض غير النشطين
              </mat-checkbox>
            </div>

            <!-- Search Actions -->
            <div class="search-actions">
              <button
                mat-raised-button
                color="primary"
                type="button"
                (click)="onSearch()"
                [disabled]="loading()"
              >
                <mat-icon>search</mat-icon>
                بحث
              </button>

              <button
                mat-stroked-button
                type="button"
                (click)="onClearSearch()"
                [disabled]="loading()"
              >
                <mat-icon>clear</mat-icon>
                مسح
              </button>

              <button
                mat-icon-button
                type="button"
                (click)="onToggleAdvancedSearch()"
                [matTooltip]="showAdvancedSearch() ? 'إخفاء البحث المتقدم' : 'إظهار البحث المتقدم'"
              >
                <mat-icon>{{ showAdvancedSearch() ? 'expand_less' : 'tune' }}</mat-icon>
              </button>
            </div>
          </div>

          <!-- Advanced Search Panel -->
          @if (showAdvancedSearch()) {
            <div class="advanced-search">
              <mat-divider></mat-divider>
              <div class="advanced-row">
                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>المدينة</mat-label>
                  <input
                    matInput
                    formControlName="city"
                    placeholder="اسم المدينة"
                  />
                  <mat-icon matSuffix>location_city</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>آخر زيارة من</mat-label>
                  <input
                    matInput
                    [matDatepicker]="fromDatePicker"
                    formControlName="lastVisitFrom"
                    readonly
                  />
                  <mat-datepicker-toggle matSuffix [for]="fromDatePicker"></mat-datepicker-toggle>
                  <mat-datepicker #fromDatePicker></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>آخر زيارة إلى</mat-label>
                  <input
                    matInput
                    [matDatepicker]="toDatePicker"
                    formControlName="lastVisitTo"
                    readonly
                  />
                  <mat-datepicker-toggle matSuffix [for]="toDatePicker"></mat-datepicker-toggle>
                  <mat-datepicker #toDatePicker></mat-datepicker>
                </mat-form-field>
              </div>
            </div>
          }
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Results Summary -->
    @if (!loading()) {
      <div class="results-summary">
        <div class="summary-info">
          <mat-icon [color]="totalPatients() > 0 ? 'primary' : 'warn'">
            {{ totalPatients() > 0 ? 'check_circle' : 'info' }}
          </mat-icon>
          <span>{{ getSearchSummary() }}</span>
        </div>

        <div class="view-controls">
          <button
            mat-icon-button
            [color]="viewMode() === 'table' ? 'primary' : ''"
            (click)="onToggleViewMode()"
            matTooltip="تغيير العرض"
          >
            <mat-icon>{{ viewMode() === 'table' ? 'view_module' : 'table_rows' }}</mat-icon>
          </button>
        </div>
      </div>
    }

    <!-- Loading Indicator -->
    @if (loading()) {
      <div class="loading-container">
        <mat-spinner></mat-spinner>
        <p>جاري تحميل بيانات المرضى...</p>
      </div>
    }

    <!-- Table View -->
    @if (!loading() && viewMode() === 'table') {
      <div class="table-container">
        <mat-card class="table-card">
          <div class="table-wrapper">
            <table mat-table [dataSource]="patients()" class="patients-table" matSort>

              <!-- Patient Number Column -->
              <ng-container matColumnDef="patientNumber">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>رقم المريض</th>
                <td mat-cell *matCellDef="let patient">{{ patient.patientNumber || '-' }}</td>
              </ng-container>

              <!-- Full Name Column -->
              <ng-container matColumnDef="fullName">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>اسم المريض</th>
                <td mat-cell *matCellDef="let patient">
                  <div class="patient-name-cell">
                    <!-- <div class="patient-avatar" [class]="'avatar-' + patient.gender.toLowerCase()">
                      {{ patient.firstName.charAt(0) }}{{ patient.lastName.charAt(0) }}
                    </div> -->
                    <span>{{ patient.fullName }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Age Column -->
              <ng-container matColumnDef="age">
                <th mat-header-cell *matHeaderCellDef>العمر</th>
                <td mat-cell *matCellDef="let patient">{{ getPatientAge(patient) }} سنة</td>
              </ng-container>

              <!-- Gender Column -->
              <ng-container matColumnDef="gender">
                <th mat-header-cell *matHeaderCellDef>الجنس</th>
                <td mat-cell *matCellDef="let patient">
                  <mat-icon class="gender-icon">{{ patient.gender === 'MALE' ? 'person' : 'person_outline' }}</mat-icon>
                  {{ formatGender(patient.gender) }}
                </td>
              </ng-container>

              <!-- Phone Column -->
              <ng-container matColumnDef="phone">
                <th mat-header-cell *matHeaderCellDef>رقم الهاتف</th>
                <td mat-cell *matCellDef="let patient">{{ patient.phone }}</td>
              </ng-container>

              <!-- Blood Type Column -->
              <ng-container matColumnDef="bloodType">
                <th mat-header-cell *matHeaderCellDef>فصيلة الدم</th>
                <td mat-cell *matCellDef="let patient">
                  {{ patient.bloodType ? formatBloodType(patient.bloodType) : '-' }}
                </td>
              </ng-container>

              <!-- Last Visit Column -->
              <ng-container matColumnDef="lastVisit">
                <th mat-header-cell *matHeaderCellDef>آخر زيارة</th>
                <td mat-cell *matCellDef="let patient">
                  {{ patient.lastVisit ? formatDate(patient.lastVisit) : '-' }}
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="isActive">
                <th mat-header-cell *matHeaderCellDef>الحالة</th>
                <td mat-cell *matCellDef="let patient">
                  <mat-chip [color]="patient.isActive ? 'primary' : 'warn'">
                    <mat-icon>{{ patient.isActive ? 'check_circle' : 'cancel' }}</mat-icon>
                    {{ patient.isActive ? 'نشط' : 'غير نشط' }}
                  </mat-chip>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>الإجراءات</th>
                <td mat-cell *matCellDef="let patient">
                  <button
                    mat-icon-button
                    color="primary"
                    (click)="onViewPatient(patient)"
                    matTooltip="عرض التفاصيل"
                  >
                    <mat-icon>visibility</mat-icon>
                  </button>

                  <button
                    mat-icon-button
                    (click)="onEditPatient(patient)"
                    matTooltip="تعديل"
                  >
                    <mat-icon>edit</mat-icon>
                  </button>

                  <button
                    mat-icon-button
                    [matMenuTriggerFor]="actionMenu"
                    matTooltip="المزيد"
                    #menuTrigger="matMenuTrigger"
                  >
                    <mat-icon>more_vert</mat-icon>
                  </button>

                  <!-- Action Menu -->
                  <mat-menu #actionMenu="matMenu">
                    @if (patient.isActive && canDeletePatients()) {
                      <button mat-menu-item (click)="onDeletePatient(patient)">
                        <mat-icon color="warn">delete</mat-icon>
                        <span>حذف المريض</span>
                      </button>
                    }

                    @if (!patient.isActive && canReactivatePatients()) {
                      <button mat-menu-item (click)="onReactivatePatient(patient)">
                        <mat-icon color="primary">restore</mat-icon>
                        <span>إعادة تفعيل</span>
                      </button>
                    }
                  </mat-menu>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['patientNumber', 'fullName', 'age', 'gender', 'phone', 'bloodType', 'lastVisit', 'isActive', 'actions']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['patientNumber', 'fullName', 'age', 'gender', 'phone', 'bloodType', 'lastVisit', 'isActive', 'actions'];"></tr>
            </table>
          </div>

          <!-- Table Pagination -->
          @if (totalPatients() > 0) {
            <mat-paginator
              [length]="totalPatients()"
              [pageSize]="pageSize()"
              [pageIndex]="currentPage()"
              [pageSizeOptions]="[5, 10, 25, 50]"
              (page)="onPageChange($event)"
              showFirstLastButtons
            ></mat-paginator>
          }
        </mat-card>
      </div>
    }

    <!-- Cards View -->
    @if (!loading() && viewMode() === 'cards') {
      <div class="cards-container">
        <div class="cards-grid">
          @for (patient of patients(); track patient.id) {
            <mat-card class="patient-card">
              <mat-card-header>
                <div mat-card-avatar class="patient-avatar" [class]="'avatar-' + patient.gender.toLowerCase()">
                  {{ patient.firstName.charAt(0) }}{{ patient.lastName.charAt(0) }}
                </div>
                <mat-card-title>{{ patient.fullName }}</mat-card-title>
                <mat-card-subtitle>{{ patient.patientNumber }}</mat-card-subtitle>

                <!-- Status Badge -->
                <div class="card-status">
                  <mat-icon
                    [color]="patient.isActive ? 'primary' : 'warn'"
                    [matTooltip]="patient.isActive ? 'نشط' : 'غير نشط'"
                  >
                    {{ patient.isActive ? 'check_circle' : 'cancel' }}
                  </mat-icon>
                </div>
              </mat-card-header>

              <mat-card-content>
                <div class="patient-details">
                  <div class="detail-row">
                    <mat-icon>cake</mat-icon>
                    <span>{{ getPatientAge(patient) }} سنة</span>
                  </div>
                  <div class="detail-row">
                    <mat-icon>{{ patient.gender === 'MALE' ? 'person' : 'person_outline' }}</mat-icon>
                    <span>{{ formatGender(patient.gender) }}</span>
                  </div>
                  <div class="detail-row">
                    <mat-icon>phone</mat-icon>
                    <span>{{ patient.phone }}</span>
                  </div>
                  @if (patient.bloodType) {
                    <div class="detail-row">
                      <mat-icon>colorize</mat-icon>
                      <span>{{ formatBloodType(patient.bloodType) }}</span>
                    </div>
                  }
                  @if (patient.lastVisit) {
                    <div class="detail-row">
                      <mat-icon>event</mat-icon>
                      <span>آخر زيارة: {{ formatDate(patient.lastVisit) }}</span>
                    </div>
                  }
                </div>
              </mat-card-content>

              <mat-card-actions align="end">
                <button
                  mat-icon-button
                  color="primary"
                  (click)="onViewPatient(patient)"
                  matTooltip="عرض التفاصيل"
                >
                  <mat-icon>visibility</mat-icon>
                </button>

                <button
                  mat-icon-button
                  (click)="onEditPatient(patient)"
                  matTooltip="تعديل"
                >
                  <mat-icon>edit</mat-icon>
                </button>

                <button
                  mat-icon-button
                  [matMenuTriggerFor]="cardMenu"
                  matTooltip="المزيد"
                  #cardMenuTrigger="matMenuTrigger"
                >
                  <mat-icon>more_vert</mat-icon>
                </button>

                <!-- Card Menu -->
                <mat-menu #cardMenu="matMenu">
                  @if (patient.isActive && canDeletePatients()) {
                    <button mat-menu-item (click)="onDeletePatient(patient)">
                      <mat-icon color="warn">delete</mat-icon>
                      <span>حذف المريض</span>
                    </button>
                  }

                  @if (!patient.isActive && canReactivatePatients()) {
                    <button mat-menu-item (click)="onReactivatePatient(patient)">
                      <mat-icon color="primary">restore</mat-icon>
                      <span>إعادة تفعيل</span>
                    </button>
                  }
                </mat-menu>
              </mat-card-actions>
            </mat-card>
          }
        </div>

        <!-- Cards Pagination -->
        @if (totalPatients() > 0) {
          <mat-paginator
            [length]="totalPatients()"
            [pageSize]="pageSize()"
            [pageIndex]="currentPage()"
            [pageSizeOptions]="[5, 10, 25, 50]"
            (page)="onPageChange($event)"
            showFirstLastButtons
            class="cards-paginator"
          ></mat-paginator>
        }
      </div>
    }

    <!-- No Results -->
    @if (!loading() && totalPatients() === 0) {
      <div class="no-results">
        <mat-icon>search_off</mat-icon>
        <h3>{{ searchPerformed() ? 'لم يتم العثور على نتائج' : 'لا توجد مرضى مسجلين' }}</h3>
        <p>{{ searchPerformed() ? 'حاول تغيير معايير البحث' : 'ابدأ بإضافة مريض جديد' }}</p>
        <button
          mat-raised-button
          color="primary"
          (click)="searchPerformed() ? onClearSearch() : onAddPatient()"
        >
          <mat-icon>{{ searchPerformed() ? 'clear' : 'person_add' }}</mat-icon>
          {{ searchPerformed() ? 'مسح البحث' : 'إضافة مريض جديد' }}
        </button>
      </div>
    }
  </div>

  <!-- Export Menu -->
  <mat-menu #exportMenu="matMenu">
    <button mat-menu-item (click)="onExportPatients('excel')">
      <mat-icon>description</mat-icon>
      <span>تصدير Excel</span>
    </button>

    <button mat-menu-item (click)="onExportPatients('pdf')">
      <mat-icon>picture_as_pdf</mat-icon>
      <span>تصدير PDF</span>
    </button>

    <button mat-menu-item (click)="onExportPatients('csv')">
      <mat-icon>table_chart</mat-icon>
      <span>تصدير CSV</span>
    </button>

    <mat-divider></mat-divider>

    <button mat-menu-item (click)="onImportPatients()">
      <mat-icon>upload_file</mat-icon>
      <span>استيراد بيانات</span>
    </button>
  </mat-menu>
</app-sidebar>
