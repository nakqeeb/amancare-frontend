<!-- src/app/features/appointments/components/appointment-details/appointment-details.component.html -->
<div class="appointment-details-container">
  <app-header></app-header>

  <app-sidebar>
    <div class="main-content">
      <div class="content-area">
        @if (loading()) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
        </div>
        } @else if (appointment()) {
        <!-- Page Header -->
        <div class="page-header">
          <div class="header-content">
            <button
              mat-icon-button
              routerLink="/appointments"
              class="back-button"
            >
              <mat-icon>arrow_back</mat-icon>
            </button>
            <div>
              <h1 class="page-title">تفاصيل الموعد</h1>
              <p class="page-description">موعد #{{ appointment()!.id }}</p>
            </div>
          </div>

          <div class="header-actions">
            @if (appointment()!.status !== 'CANCELLED' && appointment()!.status
            !== 'COMPLETED') {
            <button
              mat-raised-button
              color="primary"
              (click)="editAppointment()"
            >
              <mat-icon>edit</mat-icon>
              تعديل
            </button>
            }
            <button mat-button (click)="printAppointment()">
              <mat-icon>print</mat-icon>
              طباعة
            </button>
          </div>
        </div>

        <!-- Main Content -->
        <div class="details-grid">
          <!-- Appointment Information Card -->
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>event</mat-icon>
                معلومات الموعد
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-section">
                <!-- Token Number Display -->
                <app-token-badge
                  [tokenNumber]="appointment()!.tokenNumber"
                  size="large"
                  tooltipText="رقمك في قائمة انتظار الطبيب"
                ></app-token-badge>

                <div class="info-row">
                  <span class="info-label">الحالة:</span>
                  <mat-chip [color]="getStatusColor(appointment()!.status)">
                    {{ statusLabels[appointment()!.status] }}
                  </mat-chip>
                </div>

                <div class="info-row">
                  <span class="info-label">النوع:</span>
                  <span>{{ typeLabels[appointment()!.appointmentType] }}</span>
                </div>

                <div class="info-row">
                  <span class="info-label">التاريخ:</span>
                  <span>{{ appointment()!.appointmentDate }}</span>
                </div>

                <div class="info-row">
                  <span class="info-label">الوقت:</span>
                  <span>
                    {{ appointment()!.appointmentTime }}
                    @if (appointment()!.tokenNumber) {
                    <span class="token-inline"
                      >(رمز #{{ appointment()!.tokenNumber }})</span
                    >
                    }
                  </span>
                </div>

                <!-- Duration Section with Override Badge -->
                <div class="info-row">
                  <span class="info-label">
                    <mat-icon>schedule</mat-icon>
                    المدة
                  </span>
                  <span class="info-value">
                    <span>{{ appointment()!.durationMinutes }} دقيقة</span>
                    @if (appointment()!.isDurationOverridden) {
                    <mat-chip class="override-badge" color="warn">
                      <mat-icon>warning</mat-icon>
                      مجاوزة
                    </mat-chip>
                    }
                  </span>
                </div>

                <!-- Override Information (if overridden) -->
                @if (appointment()!.isDurationOverridden) {
                <div class="info-row highlight-override">
                  <span class="info-label">
                    <mat-icon>info</mat-icon>
                    معلومات التجاوز
                  </span>
                  <span class="info-value override-info">
                    <p>
                      <strong>المدة الأصلية:</strong>
                      {{ appointment()!.originalDurationMinutes }} دقيقة
                    </p>
                    <p>
                      <strong>سبب التجاوز:</strong>
                      {{ appointment()!.overrideReason }}
                    </p>
                  </span>
                </div>
                } @if (appointment()!.chiefComplaint) {
                <mat-divider></mat-divider>
                <div class="info-row full-width">
                  <span class="info-label">الشكوى الرئيسية:</span>
                  <p>{{ appointment()!.chiefComplaint }}</p>
                </div>
                } @if (appointment()!.notes) {
                <div class="info-row full-width">
                  <span class="info-label">ملاحظات:</span>
                  <p>{{ appointment()!.notes }}</p>
                </div>
                } @if (appointment()!.cancellationReason) {
                <mat-divider></mat-divider>
                <div class="info-row full-width danger">
                  <span class="info-label">سبب الإلغاء:</span>
                  <p>{{ appointment()!.cancellationReason }}</p>
                </div>
                }
              </div>
            </mat-card-content>

            <!-- Action Buttons -->
            @if (appointment()!.status !== 'CANCELLED' && appointment()!.status
            !== 'COMPLETED') {
            <mat-card-actions>
              @switch (appointment()!.status) { @case ('SCHEDULED') {
              <button
                mat-raised-button
                color="accent"
                (click)="confirmAppointment()"
              >
                <mat-icon>check_circle</mat-icon>
                تأكيد الموعد
              </button>
              } @case ('CONFIRMED') {
              <button
                mat-raised-button
                color="primary"
                (click)="startAppointment()"
              >
                <mat-icon>play_arrow</mat-icon>
                بدء الموعد
              </button>
              } @case ('IN_PROGRESS') {
              <button
                mat-raised-button
                color="success"
                (click)="completeAppointment()"
              >
                <mat-icon>done_all</mat-icon>
                إكمال الموعد
              </button>
              } }

              <!-- Override Duration Button -->
              @if (appointment()!.status === 'SCHEDULED' ||
              appointment()!.status === 'CONFIRMED') {
              <button
                mat-stroked-button
                color="accent"
                (click)="openOverrideDurationDialog()"
              >
                <mat-icon>schedule</mat-icon>
                تجاوز المدة
              </button>
              }

              <button mat-button color="warn" (click)="cancelAppointment()">
                <mat-icon>cancel</mat-icon>
                إلغاء الموعد
              </button>
            </mat-card-actions>
            }
          </mat-card>

          <!-- Rest of your existing cards (Patient, Doctor, Metadata) remain the same -->
          <!-- Patient Information Card -->
          <mat-card class="patient-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>person</mat-icon>
                معلومات المريض
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-section">
                <div class="info-row">
                  <span class="info-label">الاسم:</span>
                  <span>{{ appointment()!.patient.fullName }}</span>
                </div>

                <div class="info-row">
                  <span class="info-label">رقم المريض:</span>
                  <span>{{ appointment()!.patient.patientNumber }}</span>
                </div>

                @if (appointment()!.patient.phone) {
                <div class="info-row">
                  <span class="info-label">الهاتف:</span>
                  <span dir="ltr">{{ appointment()!.patient.phone }}</span>
                </div>
                }
              </div>

              <mat-divider></mat-divider>

              <!-- Patient History -->
              <div class="history-section">
                <h4>المواعيد القادمة</h4>
                @if (loadingHistory()) {
                <mat-spinner diameter="30"></mat-spinner>
                } @else if (patientHistory().length > 0) {
                <mat-list>
                  @for (apt of patientHistory(); track apt.id) {
                  <mat-list-item>
                    <mat-icon matListItemIcon>event</mat-icon>
                    <div matListItemTitle>
                      {{ apt.appointmentDate }} - {{ apt.appointmentTime }}
                    </div>
                    <div matListItemLine>
                      {{ getTypeLabel(apt.appointmentType) }}
                    </div>
                  </mat-list-item>
                  }
                </mat-list>
                } @else {
                <p class="no-history">لا توجد مواعيد قادمة</p>
                }
              </div>
            </mat-card-content>
            <mat-card-actions>
              <button mat-button (click)="navigateToPatient()">
                <mat-icon>visibility</mat-icon>
                عرض ملف المريض
              </button>
            </mat-card-actions>
          </mat-card>

          <!-- Doctor Information Card -->
          <mat-card class="doctor-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>medical_services</mat-icon>
                معلومات الطبيب
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-section">
                <div class="info-row">
                  <span class="info-label">الاسم:</span>
                  <span>{{ appointment()!.doctor.fullName }}</span>
                </div>

                @if (appointment()!.doctor.specialization) {
                <div class="info-row">
                  <span class="info-label">التخصص:</span>
                  <span>{{ appointment()!.doctor.specialization }}</span>
                </div>
                }
              </div>
            </mat-card-content>
            <mat-card-actions>
              <button mat-button (click)="navigateToDoctor()">
                <mat-icon>visibility</mat-icon>
                عرض ملف الطبيب
              </button>
            </mat-card-actions>
          </mat-card>

          <!-- Metadata Card -->
          <mat-card class="metadata-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>info</mat-icon>
                معلومات إضافية
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-section">
                <div class="info-row">
                  <span class="info-label">تاريخ الإنشاء:</span>
                  <span>{{ appointment()!.createdAt }}</span>
                </div>

                @if (appointment()!.createdBy) {
                <div class="info-row">
                  <span class="info-label">تم الإنشاء بواسطة:</span>
                  <span>{{ appointment()!.createdBy }}</span>
                </div>
                } @if (appointment()!.updatedAt) {
                <div class="info-row">
                  <span class="info-label">آخر تحديث:</span>
                  <span>{{ appointment()!.updatedAt }}</span>
                </div>
                }
              </div>
            </mat-card-content>
          </mat-card>
        </div>
        }
      </div>
    </div>
  </app-sidebar>
</div>
