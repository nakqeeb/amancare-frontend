<div class="appointment-details-container">
  <app-header></app-header>
  <app-sidebar></app-sidebar>

  <main class="main-content">
    @if (loading()) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>جاري تحميل بيانات الموعد...</p>
    </div>
    } @else if (appointment()) {
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <button mat-icon-button routerLink="/appointments" class="back-btn">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div>
          <h1>تفاصيل الموعد</h1>
          <p class="subtitle">موعد #{{ appointment()!.id }}</p>
        </div>
      </div>
      <div class="header-actions">
        @if (canEdit()) {
        <button mat-stroked-button (click)="onEdit()">
          <mat-icon>edit</mat-icon>
          تعديل
        </button>
        }
        <button mat-stroked-button (click)="onPrint()">
          <mat-icon>print</mat-icon>
          طباعة
        </button>
        <button mat-stroked-button [matMenuTriggerFor]="actionsMenu">
          <mat-icon>more_vert</mat-icon>
          المزيد
        </button>
        <mat-menu #actionsMenu="matMenu">
          <button mat-menu-item (click)="onSendReminder()">
            <mat-icon>notifications</mat-icon>
            إرسال تذكير
          </button>
          <button mat-menu-item (click)="onReschedule()">
            <mat-icon>event_repeat</mat-icon>
            إعادة جدولة
          </button>
          <button mat-menu-item (click)="onCreateInvoice()">
            <mat-icon>receipt</mat-icon>
            إنشاء فاتورة
          </button>
          @if (canCancel()) {
          <mat-divider></mat-divider>
          <button mat-menu-item (click)="onCancel()" class="danger-item">
            <mat-icon>cancel</mat-icon>
            إلغاء الموعد
          </button>
          }
        </mat-menu>
      </div>
    </div>

    <!-- Status Card -->
    <mat-card class="status-card">
      <mat-card-content>
        <div class="status-content">
          <div class="status-info">
            <h3>حالة الموعد</h3>
            <mat-chip
              [class]="getStatusClass(appointment()!.status)"
              class="status-chip"
            >
              {{ getStatusLabel(appointment()!.status) }}
            </mat-chip>
          </div>
          <div class="status-actions">
            @if (canConfirm()) {
            <button mat-raised-button color="primary" (click)="onConfirm()">
              <mat-icon>check_circle</mat-icon>
              تأكيد الموعد
            </button>
            } @if (canCheckIn()) {
            <button mat-raised-button color="accent" (click)="onCheckIn()">
              <mat-icon>how_to_reg</mat-icon>
              تسجيل الحضور
            </button>
            } @if (canStartConsultation()) {
            <button
              mat-raised-button
              color="primary"
              (click)="onStartConsultation()"
            >
              <mat-icon>play_arrow</mat-icon>
              بدء الاستشارة
            </button>
            } @if (canComplete()) {
            <button mat-raised-button color="success" (click)="onComplete()">
              <mat-icon>task_alt</mat-icon>
              إكمال الموعد
            </button>
            }
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Main Content -->
    <div class="details-grid">
      <!-- Appointment Information -->
      <mat-card>
        <mat-card-header>
          <mat-card-title>
            <mat-icon>event</mat-icon>
            معلومات الموعد
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-list">
            <div class="info-item">
              <span class="info-label">التاريخ</span>
              <span class="info-value">{{
                formatDate(appointment()!.appointmentDate)
              }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">الوقت</span>
              <span class="info-value">{{
                formatTime(appointment()!.appointmentTime)
              }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">المدة</span>
              <span class="info-value"
                >{{ appointment()!.duration }} دقيقة</span
              >
            </div>
            <div class="info-item">
              <span class="info-label">نوع الموعد</span>
              <span class="info-value">
                <mat-icon>{{ getTypeIcon(appointment()!.type) }}</mat-icon>
                {{ getTypeLabel(appointment()!.type) }}
              </span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Patient Information -->
      <mat-card>
        <mat-card-header>
          <mat-card-title>
            <mat-icon>person</mat-icon>
            معلومات المريض
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-list">
            <div class="info-item">
              <span class="info-label">اسم المريض</span>
              <span class="info-value">{{ appointment()!.patientName }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">رقم الهاتف</span>
              <span class="info-value">{{ appointment()!.patientPhone }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">رقم الملف</span>
              <span class="info-value">#{{ appointment()!.patientId }}</span>
            </div>
            <button
              mat-stroked-button
              (click)="onViewPatient()"
              class="view-patient-btn"
            >
              <mat-icon>visibility</mat-icon>
              عرض ملف المريض
            </button>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Doctor Information -->
      <mat-card>
        <mat-card-header>
          <mat-card-title>
            <mat-icon>medical_services</mat-icon>
            معلومات الطبيب
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-list">
            <div class="info-item">
              <span class="info-label">الطبيب المعالج</span>
              <span class="info-value">{{ appointment()!.doctorName }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">التخصص</span>
              <span class="info-value">طب عام</span>
            </div>
            <div class="info-item">
              <span class="info-label">العيادة</span>
              <span class="info-value">العيادة الرئيسية</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Medical Information -->
    <mat-card class="medical-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>description</mat-icon>
          المعلومات الطبية
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="medical-info">
          <div class="complaint-section">
            <h4>الشكوى الرئيسية</h4>
            <p class="complaint-text">
              {{ appointment()!.chiefComplaint || "لم يتم تحديد" }}
            </p>
          </div>
          @if (appointment()!.notes) {
          <mat-divider></mat-divider>
          <div class="notes-section">
            <h4>ملاحظات</h4>
            <p class="notes-text">{{ appointment()!.notes }}</p>
          </div>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Activity Timeline -->
    <mat-card class="timeline-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>timeline</mat-icon>
          سجل النشاط
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="timeline">
          <div class="timeline-item">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <span class="timeline-time">{{
                appointment()!.createdAt | date : "short"
              }}</span>
              <span class="timeline-action">تم إنشاء الموعد</span>
              <span class="timeline-user"
                >بواسطة {{ appointment()!.createdBy }}</span
              >
            </div>
          </div>
          @if (appointment()!.updatedAt) {
          <div class="timeline-item">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <span class="timeline-time">{{
                appointment()!.updatedAt | date : "short"
              }}</span>
              <span class="timeline-action">تم تحديث الموعد</span>
            </div>
          </div>
          }
        </div>
      </mat-card-content>
    </mat-card>
    }
  </main>
</div>
