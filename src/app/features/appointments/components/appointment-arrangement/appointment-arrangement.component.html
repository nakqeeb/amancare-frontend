<!-- src/app/features/appointments/components/appointment-arrangement/appointment-arrangement.component.html -->
<div class="layout-wrapper">
  <app-header />
  <app-sidebar>
    <div class="content-wrapper">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-content">
          <div class="header-text">
            <h1 class="page-title">
              <mat-icon>event_available</mat-icon>
              ترتيب مواعيد اليوم
            </h1>
            <p class="page-description">
              إدارة وترتيب مواعيد اليوم حسب الطبيب ورقم الدور
            </p>
          </div>
          <div class="header-actions">
            <button
              mat-raised-button
              color="primary"
              (click)="refreshAppointments()"
              [disabled]="loadingAppointments() || !selectedDoctorControl.value"
            >
              <mat-icon>refresh</mat-icon>
              تحديث
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="content-container">
        <mat-card class="arrangement-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>person</mat-icon>
              اختيار الطبيب
            </mat-card-title>
          </mat-card-header>

          <mat-card-content>
            <!-- Enhanced Doctor Selection -->
            <div class="doctor-selection">
              @if (loading()) {
              <div class="loading-container">
                <mat-spinner diameter="40"></mat-spinner>
                <p>جاري تحميل الأطباء...</p>
              </div>
              } @else {
              <div class="doctor-selector-wrapper">
                <div class="selector-label">
                  <mat-icon>medical_services</mat-icon>
                  <span>اختر الطبيب لعرض مواعيده</span>
                </div>

                <mat-form-field appearance="outline" class="doctor-field">
                  <mat-label>
                    <mat-icon>person_search</mat-icon>
                    <span>البحث عن طبيب</span>
                  </mat-label>
                  <mat-select
                    [formControl]="selectedDoctorControl"
                    (selectionChange)="onDoctorChange()"
                    placeholder="اختر طبيب من القائمة"
                    panelClass="doctor-select-panel"
                  >
                    <mat-option [value]="null" class="empty-option">
                      <div class="empty-doctor-option">
                        <mat-icon>remove_circle_outline</mat-icon>
                        <span>-- إلغاء الاختيار --</span>
                      </div>
                    </mat-option>

                    <mat-divider></mat-divider>

                    @for (doctor of doctors(); track doctor.id) {
                    <mat-option [value]="doctor.id" class="doctor-option-item">
                      <div class="doctor-option">
                        <!-- <div class="doctor-avatar">
                          <mat-icon>person</mat-icon>
                        </div> -->
                        <div class="doctor-info">
                          <span class="doctor-name">{{ doctor.fullName }}</span>
                          @if (doctor.specialization) {
                          <span class="doctor-specialization">
                            <!-- <mat-icon>local_hospital</mat-icon> -->
                            {{ " - " }}
                            {{ doctor.specialization }}
                          </span>
                          }
                        </div>
                      </div>
                    </mat-option>
                    }
                  </mat-select>
                  <mat-icon matPrefix class="select-prefix-icon"
                    >person</mat-icon
                  >
                  @if (selectedDoctorControl.value) {
                  <button
                    mat-icon-button
                    matSuffix
                    (click)="clearDoctorSelection($event)"
                    class="clear-button"
                    type="button"
                  >
                    <mat-icon>close</mat-icon>
                  </button>
                  }
                </mat-form-field>

                <!-- Selected Doctor Card -->
                @if (selectedDoctorControl.value) {
                <div class="selected-doctor-card">
                  <div class="card-header">
                    <mat-icon>check_circle</mat-icon>
                    <span>الطبيب المختار</span>
                  </div>
                  <div class="card-content">
                    <div class="doctor-avatar large">
                      <mat-icon>person</mat-icon>
                    </div>
                    <div class="doctor-details">
                      <h3>{{ getSelectedDoctorName() }}</h3>
                      @if (getSelectedDoctorSpecialization()) {
                      <p class="specialization">
                        <mat-icon>local_hospital</mat-icon>
                        {{ getSelectedDoctorSpecialization() }}
                      </p>
                      } @if (getSelectedDoctorEmail()) {
                      <p class="email">
                        <mat-icon>email</mat-icon>
                        {{ getSelectedDoctorEmail() }}
                      </p>
                      }
                    </div>
                  </div>
                </div>
                }
              </div>
              }
            </div>

            <mat-divider></mat-divider>

            <!-- Appointments List -->
            @if (selectedDoctorControl.value) {
            <div class="appointments-section">
              <div class="section-header">
                <h3>
                  <mat-icon>event_note</mat-icon>
                  المواعيد @if (appointmentCount > 0) {
                  <span class="count-badge">{{ appointmentCount }}</span>
                  }
                </h3>
                @if (loadingAppointments()) {
                <mat-spinner diameter="24"></mat-spinner>
                }
              </div>

              @if (loadingAppointments()) {
              <div class="loading-container">
                <mat-spinner diameter="50"></mat-spinner>
                <p>جاري تحميل المواعيد...</p>
              </div>
              } @else if (appointments().length === 0) {
              <div class="empty-state">
                <mat-icon class="empty-icon">event_busy</mat-icon>
                <h3>لا توجد مواعيد</h3>
                <p>لا توجد مواعيد لهذا الطبيب في اليوم الحالي</p>
              </div>
              } @else {

              <!-- Appointments Expansion Panels -->
              <mat-accordion class="appointments-accordion">
                @for (appointment of appointments(); track appointment.id) {
                <mat-expansion-panel
                  class="appointment-panel"
                  [class.status-scheduled]="
                    appointment.status === appointmentStatus.SCHEDULED
                  "
                  [class.status-confirmed]="
                    appointment.status === appointmentStatus.CONFIRMED
                  "
                  [class.status-in-progress]="
                    appointment.status === appointmentStatus.IN_PROGRESS
                  "
                  [class.status-completed]="
                    appointment.status === appointmentStatus.COMPLETED
                  "
                  [class.status-cancelled]="
                    appointment.status === appointmentStatus.CANCELLED
                  "
                  [class.status-no-show]="
                    appointment.status === appointmentStatus.NO_SHOW
                  "
                  [expanded]="appointment.showDetails"
                  (opened)="togglePatientDetails(appointment)"
                  (closed)="appointment.showDetails = false"
                >
                  <!-- Panel Header -->
                  <mat-expansion-panel-header>
                    <mat-panel-title class="appointment-header">
                      <!-- Status Indicator Strip -->
                      <div class="status-strip"></div>

                      <!-- Token Badge -->
                      <div class="token-section">
                        <app-token-badge
                          [tokenNumber]="appointment.tokenNumber"
                          [size]="'medium'"
                          [tooltipText]="
                            appointment.status === appointmentStatus.COMPLETED
                              ? 'الموعد مكتمل'
                              : appointment.status ===
                                appointmentStatus.IN_PROGRESS
                              ? 'الموعد جارٍ حالياً'
                              : appointment.status ===
                                appointmentStatus.CANCELLED
                              ? 'تم إلغاء الموعد'
                              : 'في قائمة الانتظار'
                          "
                        ></app-token-badge>
                      </div>

                      <!-- Patient Info -->
                      <div class="patient-section">
                        <div class="patient-name">
                          <mat-icon>person</mat-icon>
                          <span>{{ appointment.patientName }}</span>
                        </div>
                        <div class="appointment-summary">
                          <span class="detail-item">
                            <mat-icon>access_time</mat-icon>
                            {{ appointment.appointmentTime }}
                          </span>
                          <mat-chip class="type-chip">
                            {{ getTypeLabel(appointment.appointmentType) }}
                          </mat-chip>
                        </div>
                      </div>

                      <!-- Status Badge -->
                      <div class="status-section">
                        <mat-chip class="status-chip">
                          <mat-icon>{{
                            getStatusIcon(appointment.status)
                          }}</mat-icon>
                          {{ getStatusLabel(appointment.status) }}
                        </mat-chip>
                      </div>
                    </mat-panel-title>
                  </mat-expansion-panel-header>

                  <!-- Panel Content - Patient Details -->
                  <div class="appointment-details">
                    @if (appointment.loadingPatientDetails) {
                    <div class="loading-details">
                      <mat-spinner diameter="30"></mat-spinner>
                      <p>جاري تحميل التفاصيل...</p>
                    </div>
                    } @else {

                    <!-- Chief Complaint -->
                    @if (appointment.chiefComplaint) {
                    <div class="detail-card">
                      <div class="detail-header">
                        <mat-icon>medical_information</mat-icon>
                        <h4>الشكوى الرئيسية</h4>
                      </div>
                      <p class="detail-content">
                        {{ appointment.chiefComplaint }}
                      </p>
                    </div>
                    }

                    <div class="details-grid">
                      <!-- Blood Type -->
                      @if (appointment.patientDetails?.bloodType) {
                      <div class="detail-item">
                        <mat-icon class="detail-icon blood-icon"
                          >bloodtype</mat-icon
                        >
                        <div class="detail-text">
                          <span class="detail-label">فصيلة الدم</span>
                          <span
                            class="detail-value blood-type"
                            [style.color]="
                              getBloodTypeColor(
                                appointment.patientDetails?.bloodType
                              )
                            "
                          >
                            {{
                              getBloodTypeDisplay(
                                appointment.patientDetails?.bloodType
                              )
                            }}
                          </span>
                        </div>
                      </div>
                      }

                      <!-- Age -->
                      @if (appointment.patientDetails?.age) {
                      <div class="detail-item">
                        <mat-icon class="detail-icon">cake</mat-icon>
                        <div class="detail-text">
                          <span class="detail-label">العمر</span>
                          <span class="detail-value"
                            >{{ appointment.patientDetails?.age }} سنة</span
                          >
                        </div>
                      </div>
                      }

                      <!-- Phone -->
                      @if (appointment.patientDetails?.phone) {
                      <div class="detail-item">
                        <mat-icon class="detail-icon">phone</mat-icon>
                        <div class="detail-text">
                          <span class="detail-label">رقم الهاتف</span>
                          <span class="detail-value">{{
                            appointment.patientDetails?.phone
                          }}</span>
                        </div>
                      </div>
                      }
                    </div>

                    <!-- Allergies -->
                    @if (appointment.patientDetails?.allergies) {
                    <div class="detail-card warning-card">
                      <div class="detail-header">
                        <mat-icon>warning</mat-icon>
                        <h4>الحساسية</h4>
                      </div>
                      <p class="detail-content">
                        {{ appointment.patientDetails?.allergies }}
                      </p>
                    </div>
                    }

                    <!-- Chronic Diseases -->
                    @if (appointment.patientDetails?.chronicDiseases) {
                    <div class="detail-card info-card">
                      <div class="detail-header">
                        <mat-icon>health_and_safety</mat-icon>
                        <h4>الأمراض المزمنة</h4>
                      </div>
                      <p class="detail-content">
                        {{ appointment.patientDetails?.chronicDiseases }}
                      </p>
                    </div>
                    }

                    <!-- Notes -->
                    @if (appointment.appointmentNotes ||
                    appointment.patientDetails?.notes) {
                    <div class="detail-card notes-card">
                      <div class="detail-header">
                        <mat-icon>note</mat-icon>
                        <h4>ملاحظات</h4>
                      </div>
                      @if (appointment.appointmentNotes) {
                      <div class="note-section">
                        <strong>ملاحظات الموعد:</strong>
                        <p class="detail-content">
                          {{ appointment.appointmentNotes }}
                        </p>
                      </div>
                      } @if (appointment.patientDetails?.notes) {
                      <div class="note-section">
                        <strong>ملاحظات المريض:</strong>
                        <p class="detail-content">
                          {{ appointment.patientDetails?.notes }}
                        </p>
                      </div>
                      }
                    </div>
                    }

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                      @if (canUpdateStatus(appointment.status)) {
                      <button
                        mat-raised-button
                        [matMenuTriggerFor]="statusMenu"
                        color="primary"
                      >
                        <mat-icon>update</mat-icon>
                        تحديث الحالة
                      </button>

                      <mat-menu #statusMenu="matMenu">
                        @for ( status of
                        getAvailableStatusTransitions(appointment.status); track
                        status ) {
                        <button
                          mat-menu-item
                          (click)="updateAppointmentStatus(appointment, status)"
                        >
                          <mat-icon>{{ getStatusIcon(status) }}</mat-icon>
                          <span>{{ getStatusLabel(status) }}</span>
                        </button>
                        }
                      </mat-menu>
                      } @else if (appointment.status ===
                      appointmentStatus.COMPLETED) {
                      <div class="completed-message">
                        <mat-icon>check_circle</mat-icon>
                        <span>تم إكمال هذا الموعد</span>
                      </div>
                      }
                    </div>

                    }
                  </div>
                </mat-expansion-panel>
                }
              </mat-accordion>
              }
            </div>
            } @else {
            <div class="empty-state">
              <mat-icon class="empty-icon">person_search</mat-icon>
              <h3>اختر طبيب</h3>
              <p>الرجاء اختيار طبيب من القائمة أعلاه لعرض مواعيده</p>
            </div>
            }
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  </app-sidebar>
</div>
