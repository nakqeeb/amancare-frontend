<div class="appointment-form-container">
  <app-header></app-header>
  <app-sidebar></app-sidebar>

  <main class="main-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <button mat-icon-button (click)="onCancel()" class="back-btn">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div>
          <h1>{{ isEditMode() ? "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯" : "Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯" }}</h1>
          <p class="subtitle">
            {{
              isEditMode()
                ? "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø·Ø¨ÙŠ"
                : "Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø·Ø¨ÙŠ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø±ÙŠØ¶"
            }}
          </p>
        </div>
      </div>
      <div class="header-actions">
        <button mat-stroked-button (click)="onReset()" [disabled]="loading()">
          <mat-icon>refresh</mat-icon>
          Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
        </button>
      </div>
    </div>

    <!-- Form Stepper -->
    <mat-card class="form-card">
      <mat-card-content>
        <mat-stepper linear #stepper>
          <!-- Step 1: Patient Selection -->
          <mat-step
            [stepControl]="patientFormGroup"
            [completed]="isStepValid('patient')"
          >
            <ng-template matStepLabel>
              <span class="step-label">
                <mat-icon>person</mat-icon>
                Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±ÙŠØ¶
              </span>
            </ng-template>

            <div class="step-content">
              <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</h3>

              <form [formGroup]="patientFormGroup">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±ÙŠØ¶</mat-label>
                  <input
                    matInput
                    formControlName="patientSearch"
                    [matAutocomplete]="patientAuto"
                    placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù..."
                  />
                  <mat-icon matSuffix>search</mat-icon>
                  <mat-autocomplete
                    #patientAuto="matAutocomplete"
                    [displayWith]="displayPatient"
                    (optionSelected)="onPatientSelected($event)"
                  >
                    @for (patient of filteredPatients$ | async; track
                    patient.id) {
                    <mat-option [value]="patient">
                      <div class="autocomplete-option">
                        <div class="option-main">
                          <strong
                            >{{ patient.firstName }}
                            {{ patient.lastName }}</strong
                          >
                          <span class="badge">{{ patient.patientNumber }}</span>
                        </div>
                        <div class="option-sub">
                          <span>ğŸ“± {{ patient.phone }}</span>
                          <span
                            >ğŸ‚
                            {{ getPatientAge(patient.dateOfBirth!) }} Ø³Ù†Ø©</span
                          >
                        </div>
                      </div>
                    </mat-option>
                    }
                  </mat-autocomplete>
                  <mat-error>{{ patientError }}</mat-error>
                </mat-form-field>

                <!-- Selected Patient Info -->
                @if (selectedPatient()) {
                <div class="selected-patient-card">
                  <div class="patient-avatar">
                    <mat-icon>person</mat-icon>
                  </div>
                  <div class="patient-info">
                    <h4>
                      {{ selectedPatient()!.firstName }}
                      {{ selectedPatient()!.lastName }}
                    </h4>
                    <div class="info-row">
                      <span
                        ><mat-icon>badge</mat-icon>
                        {{ selectedPatient()!.patientNumber }}</span
                      >
                      <span
                        ><mat-icon>phone</mat-icon>
                        {{ selectedPatient()!.phone }}</span
                      >
                      <span
                        ><mat-icon>cake</mat-icon>
                        {{ getPatientAge(selectedPatient()!.dateOfBirth!) }}
                        Ø³Ù†Ø©</span
                      >
                    </div>
                  </div>
                </div>
                }
              </form>

              <div class="step-actions">
                <button
                  mat-raised-button
                  color="primary"
                  matStepperNext
                  [disabled]="!isStepValid('patient')"
                >
                  Ø§Ù„ØªØ§Ù„ÙŠ
                  <mat-icon>arrow_forward</mat-icon>
                </button>
              </div>
            </div>
          </mat-step>

          <!-- Step 2: Schedule Selection -->
          <mat-step
            [stepControl]="scheduleFormGroup"
            [completed]="isStepValid('schedule')"
          >
            <ng-template matStepLabel>
              <span class="step-label">
                <mat-icon>event</mat-icon>
                Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯
              </span>
            </ng-template>

            <div class="step-content">
              <h3>ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h3>

              <form [formGroup]="scheduleFormGroup">
                <div class="form-row">
                  <!-- Doctor Selection -->
                  <mat-form-field appearance="outline">
                    <mat-label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨</mat-label>
                    <input
                      matInput
                      formControlName="doctorSearch"
                      [matAutocomplete]="doctorAuto"
                      placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨..."
                    />
                    <mat-icon matSuffix>medical_services</mat-icon>
                    <mat-autocomplete
                      #doctorAuto="matAutocomplete"
                      [displayWith]="displayDoctor"
                      (optionSelected)="onDoctorSelected($event)"
                    >
                      @for (doctor of filteredDoctors$ | async; track doctor.id)
                      {
                      <mat-option [value]="doctor">
                        <div class="autocomplete-option">
                          <strong>{{ doctor.name }}</strong>
                          <span class="specialty-badge">{{
                            doctor.specialization
                          }}</span>
                        </div>
                      </mat-option>
                      }
                    </mat-autocomplete>
                    <mat-error>{{ doctorError }}</mat-error>
                  </mat-form-field>

                  <!-- Date Selection -->
                  <mat-form-field appearance="outline">
                    <mat-label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯</mat-label>
                    <input
                      matInput
                      [matDatepicker]="datePicker"
                      formControlName="appointmentDate"
                      [min]="minDate()"
                      [max]="maxDate()"
                      (dateChange)="onDateChange($event.value)"
                    />
                    <mat-datepicker-toggle
                      matSuffix
                      [for]="datePicker"
                    ></mat-datepicker-toggle>
                    <mat-datepicker #datePicker></mat-datepicker>
                    <mat-error>{{ dateError }}</mat-error>
                  </mat-form-field>

                  <!-- Duration Selection -->
                  <mat-form-field appearance="outline">
                    <mat-label>Ù…Ø¯Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯</mat-label>
                    <mat-select formControlName="duration">
                      @for (duration of durations; track duration.value) {
                      <mat-option [value]="duration.value">
                        {{ duration.label }}
                      </mat-option>
                      }
                    </mat-select>
                    <mat-icon matSuffix>timer</mat-icon>
                  </mat-form-field>
                </div>

                <!-- Time Slots Selection -->
                @if (selectedDoctor() && selectedDate()) {
                <div class="time-slots-section">
                  <h4>Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h4>
                  @if (loading()) {
                  <div class="loading-slots">
                    <mat-spinner diameter="40"></mat-spinner>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©...</p>
                  </div>
                  } @else {
                  <app-time-slots
                    [timeSlots]="availableTimeSlots()"
                    [selectedSlot]="selectedTimeSlot()"
                    (slotSelected)="onTimeSlotSelected($event)"
                  ></app-time-slots>
                  }
                </div>
                }
              </form>

              <div class="step-actions">
                <button mat-button matStepperPrevious>
                  <mat-icon>arrow_back</mat-icon>
                  Ø§Ù„Ø³Ø§Ø¨Ù‚
                </button>
                <button
                  mat-raised-button
                  color="primary"
                  matStepperNext
                  [disabled]="!isStepValid('schedule')"
                >
                  Ø§Ù„ØªØ§Ù„ÙŠ
                  <mat-icon>arrow_forward</mat-icon>
                </button>
              </div>
            </div>
          </mat-step>

          <!-- Step 3: Appointment Details -->
          <mat-step
            [stepControl]="detailsFormGroup"
            [completed]="isStepValid('details')"
          >
            <ng-template matStepLabel>
              <span class="step-label">
                <mat-icon>description</mat-icon>
                ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯
              </span>
            </ng-template>

            <div class="step-content">
              <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h3>

              <form [formGroup]="detailsFormGroup">
                <!-- Appointment Type -->
                <div class="appointment-types">
                  <label class="section-label">Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¹Ø¯</label>
                  <mat-radio-group
                    formControlName="type"
                    class="type-radio-group"
                  >
                    @for (type of appointmentTypes; track type.value) {
                    <mat-radio-button [value]="type.value" class="type-option">
                      <div class="type-content">
                        <mat-icon>{{ type.icon }}</mat-icon>
                        <span>{{ type.label }}</span>
                      </div>
                    </mat-radio-button>
                    }
                  </mat-radio-group>
                </div>

                <!-- Chief Complaint -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</mat-label>
                  <textarea
                    matInput
                    formControlName="chiefComplaint"
                    rows="3"
                    placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…Ø±ÙŠØ¶..."
                  ></textarea>
                  <mat-hint align="end">
                    {{
                      detailsFormGroup.get("chiefComplaint")?.value?.length ||
                        0
                    }}/200
                  </mat-hint>
                  <mat-error>{{ chiefComplaintError }}</mat-error>
                </mat-form-field>

                <!-- Additional Notes -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</mat-label>
                  <textarea
                    matInput
                    formControlName="notes"
                    rows="3"
                    placeholder="Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."
                  ></textarea>
                </mat-form-field>
              </form>

              <div class="step-actions">
                <button mat-button matStepperPrevious>
                  <mat-icon>arrow_back</mat-icon>
                  Ø§Ù„Ø³Ø§Ø¨Ù‚
                </button>
                <button
                  mat-raised-button
                  color="primary"
                  (click)="onSubmit()"
                  [disabled]="loading() || appointmentForm.invalid"
                >
                  @if (loading()) {
                  <mat-spinner diameter="20"></mat-spinner>
                  } @else {
                  <mat-icon>{{ isEditMode() ? "save" : "check" }}</mat-icon>
                  {{ isEditMode() ? "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª" : "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²" }}
                  }
                </button>
              </div>
            </div>
          </mat-step>

          <!-- Summary Step -->
          <mat-step>
            <ng-template matStepLabel>
              <span class="step-label">
                <mat-icon>check_circle</mat-icon>
                Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙˆØ¹Ø¯
              </span>
            </ng-template>

            <div class="step-content summary">
              <h3>Ù…Ù„Ø®Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¹Ø¯</h3>

              <div class="summary-card">
                <!-- Patient Summary -->
                <div class="summary-section">
                  <h4><mat-icon>person</mat-icon> Ø§Ù„Ù…Ø±ÙŠØ¶</h4>
                  @if (selectedPatient()) {
                  <div class="summary-content">
                    <p>
                      <strong>Ø§Ù„Ø§Ø³Ù…:</strong>
                      {{ selectedPatient()!.firstName }}
                      {{ selectedPatient()!.lastName }}
                    </p>
                    <p>
                      <strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù:</strong>
                      {{ selectedPatient()!.patientNumber }}
                    </p>
                    <p>
                      <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> {{ selectedPatient()!.phone }}
                    </p>
                  </div>
                  }
                </div>

                <mat-divider></mat-divider>

                <!-- Schedule Summary -->
                <div class="summary-section">
                  <h4><mat-icon>schedule</mat-icon> Ø§Ù„Ù…ÙˆØ¹Ø¯</h4>
                  <div class="summary-content">
                    <p><strong>Ø§Ù„Ø·Ø¨ÙŠØ¨:</strong> {{ selectedDoctor()?.name }}</p>
                    <p>
                      <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong>
                      {{
                        scheduleFormGroup.get("appointmentDate")?.value
                          | date : "fullDate" : "ar"
                      }}
                    </p>
                    <p>
                      <strong>Ø§Ù„ÙˆÙ‚Øª:</strong>
                      {{ scheduleFormGroup.get("appointmentTime")?.value }}
                    </p>
                    <p>
                      <strong>Ø§Ù„Ù…Ø¯Ø©:</strong>
                      {{ scheduleFormGroup.get("duration")?.value }} Ø¯Ù‚ÙŠÙ‚Ø©
                    </p>
                  </div>
                </div>

                <mat-divider></mat-divider>

                <!-- Details Summary -->
                <div class="summary-section">
                  <h4><mat-icon>description</mat-icon> Ø§Ù„ØªÙØ§ØµÙŠÙ„</h4>
                  <div class="summary-content">
                    <!-- <p>
                      <strong>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¹Ø¯:</strong>
                      {{ appointmentTypes.find(t => t.value === detailsFormGroup.get('type')?.value)?.label }}
                    </p> -->
                    <p>
                      <strong>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¹Ø¯:</strong>
                      {{ selectedAppointmentTypeLabel }}
                    </p>
                    <p>
                      <strong>Ø§Ù„Ø´ÙƒÙˆÙ‰:</strong>
                      {{ detailsFormGroup.get("chiefComplaint")?.value }}
                    </p>
                    @if (detailsFormGroup.get('notes')?.value) {
                    <p>
                      <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong>
                      {{ detailsFormGroup.get("notes")?.value }}
                    </p>
                    }
                  </div>
                </div>
              </div>

              <div class="step-actions">
                <button mat-button matStepperPrevious>
                  <mat-icon>arrow_back</mat-icon>
                  Ø§Ù„Ø³Ø§Ø¨Ù‚
                </button>
                <button
                  mat-raised-button
                  color="primary"
                  (click)="onSubmit()"
                  [disabled]="loading() || appointmentForm.invalid"
                >
                  @if (loading()) {
                  <mat-spinner diameter="20"></mat-spinner>
                  } @else {
                  <mat-icon>{{ isEditMode() ? "save" : "check" }}</mat-icon>
                  {{ isEditMode() ? "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª" : "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²" }}
                  }
                </button>
              </div>
            </div>
          </mat-step>
        </mat-stepper>
      </mat-card-content>
    </mat-card>
  </main>
</div>
