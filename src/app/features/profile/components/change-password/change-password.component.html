<app-header></app-header>
<app-sidebar>
  <div class="security-container">
    <div class="page-header">
      <button mat-icon-button routerLink="/profile/overview">
        <mat-icon>arrow_forward</mat-icon>
      </button>
      <h1>الأمان وكلمة المرور</h1>
    </div>

    <mat-tab-group animationDuration="0ms">
      <!-- Change Password Tab -->
      <mat-tab label="تغيير كلمة المرور">
        <div class="tab-content">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>lock</mat-icon>
                تغيير كلمة المرور
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
                <mat-form-field>
                  <mat-label>كلمة المرور الحالية</mat-label>
                  <input
                    matInput
                    [type]="showCurrentPassword() ? 'text' : 'password'"
                    formControlName="currentPassword"
                  />
                  <button
                    mat-icon-button
                    matSuffix
                    type="button"
                    (click)="showCurrentPassword.set(!showCurrentPassword())"
                  >
                    <mat-icon>{{
                      showCurrentPassword() ? "visibility_off" : "visibility"
                    }}</mat-icon>
                  </button>
                  @if (passwordForm.get('currentPassword')?.hasError('required')
                  && passwordForm.get('currentPassword')?.touched) {
                  <mat-error>كلمة المرور الحالية مطلوبة</mat-error>
                  }
                </mat-form-field>

                <mat-form-field>
                  <mat-label>كلمة المرور الجديدة</mat-label>
                  <input
                    matInput
                    [type]="showNewPassword() ? 'text' : 'password'"
                    formControlName="newPassword"
                    (input)="checkPasswordStrength()"
                  />
                  <button
                    mat-icon-button
                    matSuffix
                    type="button"
                    (click)="showNewPassword.set(!showNewPassword())"
                  >
                    <mat-icon>{{
                      showNewPassword() ? "visibility_off" : "visibility"
                    }}</mat-icon>
                  </button>
                  @if (passwordForm.get('newPassword')?.hasError('required') &&
                  passwordForm.get('newPassword')?.touched) {
                  <mat-error>كلمة المرور الجديدة مطلوبة</mat-error>
                  } @if (passwordForm.get('newPassword')?.hasError('minlength'))
                  {
                  <mat-error
                    >كلمة المرور يجب أن تكون 8 أحرف على الأقل</mat-error
                  >
                  }
                </mat-form-field>

                <!-- Password Strength Indicator -->
                @if (passwordForm.get('newPassword')?.value) {
                <div class="password-strength">
                  <div class="strength-label">
                    <span>قوة كلمة المرور:</span>
                    <span [class]="'strength-' + passwordStrength()">
                      {{ getPasswordStrengthLabel() }}
                    </span>
                  </div>
                  <mat-progress-bar
                    mode="determinate"
                    [value]="passwordStrengthValue()"
                    [color]="getPasswordStrengthColor()"
                  >
                  </mat-progress-bar>
                  <div class="password-requirements">
                    <mat-chip [color]="hasMinLength() ? 'primary' : ''">
                      <mat-icon>{{
                        hasMinLength() ? "check" : "close"
                      }}</mat-icon>
                      8 أحرف على الأقل
                    </mat-chip>
                    <mat-chip [color]="hasUpperCase() ? 'primary' : ''">
                      <mat-icon>{{
                        hasUpperCase() ? "check" : "close"
                      }}</mat-icon>
                      حرف كبير
                    </mat-chip>
                    <mat-chip [color]="hasLowerCase() ? 'primary' : ''">
                      <mat-icon>{{
                        hasLowerCase() ? "check" : "close"
                      }}</mat-icon>
                      حرف صغير
                    </mat-chip>
                    <mat-chip [color]="hasNumber() ? 'primary' : ''">
                      <mat-icon>{{ hasNumber() ? "check" : "close" }}</mat-icon>
                      رقم
                    </mat-chip>
                    <mat-chip [color]="hasSpecialChar() ? 'primary' : ''">
                      <mat-icon>{{
                        hasSpecialChar() ? "check" : "close"
                      }}</mat-icon>
                      رمز خاص
                    </mat-chip>
                  </div>
                </div>
                }

                <mat-form-field>
                  <mat-label>تأكيد كلمة المرور الجديدة</mat-label>
                  <input
                    matInput
                    [type]="showConfirmPassword() ? 'text' : 'password'"
                    formControlName="confirmPassword"
                  />
                  <button
                    mat-icon-button
                    matSuffix
                    type="button"
                    (click)="showConfirmPassword.set(!showConfirmPassword())"
                  >
                    <mat-icon>{{
                      showConfirmPassword() ? "visibility_off" : "visibility"
                    }}</mat-icon>
                  </button>
                  @if (passwordForm.get('confirmPassword')?.hasError('required')
                  && passwordForm.get('confirmPassword')?.touched) {
                  <mat-error>تأكيد كلمة المرور مطلوب</mat-error>
                  } @if (passwordForm.hasError('passwordMismatch') &&
                  passwordForm.get('confirmPassword')?.touched) {
                  <mat-error>كلمات المرور غير متطابقة</mat-error>
                  }
                </mat-form-field>

                <div class="logout-option">
                  <mat-slide-toggle formControlName="logoutOtherSessions">
                    تسجيل الخروج من جميع الأجهزة الأخرى
                  </mat-slide-toggle>
                  <p class="hint-text">
                    سيتم تسجيل خروجك من جميع الجلسات النشطة الأخرى بعد تغيير
                    كلمة المرور
                  </p>
                </div>

                <div class="form-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="passwordForm.invalid || loading()"
                  >
                    @if (loading()) {
                    <mat-spinner diameter="20"></mat-spinner>
                    } @else {
                    <mat-icon>lock</mat-icon>
                    } تغيير كلمة المرور
                  </button>
                  <button
                    mat-button
                    type="button"
                    (click)="resetPasswordForm()"
                  >
                    إلغاء
                  </button>
                </div>
              </form>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Two-Factor Authentication Tab -->
      <mat-tab label="المصادقة الثنائية">
        <div class="tab-content">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>security</mat-icon>
                المصادقة الثنائية (2FA)
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="two-factor-section">
                @if (!profile()?.twoFactorEnabled) {
                <div class="two-factor-disabled">
                  <mat-icon class="warning-icon">warning</mat-icon>
                  <h3>المصادقة الثنائية غير مفعلة</h3>
                  <p>
                    قم بتفعيل المصادقة الثنائية لإضافة طبقة حماية إضافية لحسابك.
                    ستحتاج إلى إدخال رمز من تطبيق المصادقة بالإضافة إلى كلمة
                    المرور.
                  </p>
                  <button
                    mat-raised-button
                    color="primary"
                    (click)="enableTwoFactor()"
                  >
                    <mat-icon>security</mat-icon>
                    تفعيل المصادقة الثنائية
                  </button>
                </div>
                } @else {
                <div class="two-factor-enabled">
                  <mat-icon class="success-icon">check_circle</mat-icon>
                  <h3>المصادقة الثنائية مفعلة</h3>
                  <p>حسابك محمي بالمصادقة الثنائية</p>

                  <div class="two-factor-info">
                    <mat-list>
                      <mat-list-item>
                        <mat-icon matListItemIcon>smartphone</mat-icon>
                        <div matListItemTitle>تطبيق المصادقة</div>
                        <div matListItemLine>
                          Google Authenticator أو Microsoft Authenticator
                        </div>
                      </mat-list-item>
                      <mat-list-item>
                        <mat-icon matListItemIcon>access_time</mat-icon>
                        <div matListItemTitle>آخر استخدام</div>
                        <div matListItemLine>
                          {{ formatDate(lastTwoFactorUse()) }}
                        </div>
                      </mat-list-item>
                    </mat-list>
                  </div>

                  <button
                    mat-stroked-button
                    color="warn"
                    (click)="disableTwoFactor()"
                  >
                    <mat-icon>close</mat-icon>
                    تعطيل المصادقة الثنائية
                  </button>
                </div>
                }
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Backup Codes -->
          @if (profile()?.twoFactorEnabled) {
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>backup</mat-icon>
                رموز الاحتياط
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <p>
                احتفظ برموز الاحتياط هذه في مكان آمن. يمكنك استخدامها لتسجيل
                الدخول في حالة فقدان الوصول إلى تطبيق المصادقة.
              </p>
              <button
                mat-button
                color="primary"
                (click)="generateBackupCodes()"
              >
                <mat-icon>refresh</mat-icon>
                توليد رموز احتياط جديدة
              </button>
            </mat-card-content>
          </mat-card>
          }
        </div>
      </mat-tab>

      <!-- Active Sessions Tab -->
      <mat-tab label="الجلسات النشطة">
        <div class="tab-content">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>devices</mat-icon>
                الجلسات النشطة
              </mat-card-title>
              <button mat-button color="warn" (click)="terminateAllSessions()">
                إنهاء جميع الجلسات الأخرى
              </button>
            </mat-card-header>
            <mat-card-content>
              <mat-list>
                @for (session of sessions(); track session.id) {
                <mat-list-item class="session-item">
                  <mat-icon
                    matListItemIcon
                    [class]="'device-' + session.deviceType"
                  >
                    {{ getDeviceIcon(session.deviceType) }}
                  </mat-icon>
                  <div matListItemTitle>
                    {{ session.deviceName }}
                    @if (session.isCurrentSession) {
                    <mat-chip color="primary">الجلسة الحالية</mat-chip>
                    }
                  </div>
                  <div matListItemLine>
                    <span class="session-info">
                      <mat-icon>location_on</mat-icon>
                      {{ session.location || session.ipAddress }}
                    </span>
                    <span class="session-info">
                      <mat-icon>access_time</mat-icon>
                      آخر نشاط:
                      {{ formatRelativeTime(session.lastActivityTime) }}
                    </span>
                  </div>
                  @if (!session.isCurrentSession) {
                  <button
                    mat-icon-button
                    matListItemMeta
                    color="warn"
                    (click)="terminateSession(session.id)"
                    matTooltip="إنهاء الجلسة"
                  >
                    <mat-icon>close</mat-icon>
                  </button>
                  }
                </mat-list-item>
                <mat-divider></mat-divider>
                }
              </mat-list>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Security Questions Tab -->
      <mat-tab label="أسئلة الأمان">
        <div class="tab-content">
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                <mat-icon>quiz</mat-icon>
                أسئلة الأمان
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <p>
                قم بإعداد أسئلة الأمان لاستعادة حسابك في حالة نسيان كلمة المرور
              </p>

              <form [formGroup]="securityQuestionsForm">
                <mat-form-field>
                  <mat-label>السؤال الأول</mat-label>
                  <mat-select formControlName="question1">
                    <mat-option value="mother_maiden_name"
                      >ما هو اسم والدتك قبل الزواج؟</mat-option
                    >
                    <mat-option value="first_pet"
                      >ما هو اسم حيوانك الأليف الأول؟</mat-option
                    >
                    <mat-option value="birth_city"
                      >في أي مدينة ولدت؟</mat-option
                    >
                    <mat-option value="first_school"
                      >ما هو اسم مدرستك الابتدائية؟</mat-option
                    >
                  </mat-select>
                </mat-form-field>

                <mat-form-field>
                  <mat-label>الإجابة</mat-label>
                  <input matInput formControlName="answer1" />
                </mat-form-field>

                <mat-form-field>
                  <mat-label>السؤال الثاني</mat-label>
                  <mat-select formControlName="question2">
                    <mat-option value="favorite_teacher"
                      >من هو معلمك المفضل؟</mat-option
                    >
                    <mat-option value="first_car"
                      >ما هو نوع سيارتك الأولى؟</mat-option
                    >
                    <mat-option value="favorite_food"
                      >ما هو طعامك المفضل؟</mat-option
                    >
                    <mat-option value="best_friend"
                      >ما هو اسم صديقك المفضل في الطفولة؟</mat-option
                    >
                  </mat-select>
                </mat-form-field>

                <mat-form-field>
                  <mat-label>الإجابة</mat-label>
                  <input matInput formControlName="answer2" />
                </mat-form-field>

                <div class="form-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    (click)="saveSecurityQuestions()"
                    [disabled]="securityQuestionsForm.invalid || loading()"
                  >
                    حفظ أسئلة الأمان
                  </button>
                </div>
              </form>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</app-sidebar>
