<div class="profile-picture-dialog">
  <h2 mat-dialog-title>
    <mat-icon>photo_camera</mat-icon>
    تحديث صورة الملف الشخصي
  </h2>

  <mat-dialog-content>
    <div class="picture-container">
      @if (currentImage()) {
      <!-- Image Editor -->
      <div class="image-editor">
        <div class="canvas-container">
          <canvas
            #imageCanvas
            (mousedown)="startDrag($event)"
            (mousemove)="drag($event)"
            (mouseup)="endDrag()"
            (wheel)="onWheel($event)"
          >
          </canvas>
          <div class="crop-overlay"></div>
        </div>

        <div class="editor-controls">
          <div class="zoom-control">
            <mat-icon>zoom_in</mat-icon>
            <mat-slider
              min="1"
              max="3"
              step="0.1"
              [value]="zoomLevel()"
              (input)="setZoom($event)"
            >
            </mat-slider>
            <span class="zoom-value"
              >{{ (zoomLevel() * 100).toFixed(0) }}%</span
            >
          </div>

          <div class="rotation-control">
            <button
              mat-icon-button
              (click)="rotate(-90)"
              matTooltip="تدوير يسار"
            >
              <mat-icon>rotate_left</mat-icon>
            </button>
            <button
              mat-icon-button
              (click)="rotate(90)"
              matTooltip="تدوير يمين"
            >
              <mat-icon>rotate_right</mat-icon>
            </button>
            <button
              mat-icon-button
              (click)="flipHorizontal()"
              matTooltip="قلب أفقي"
            >
              <mat-icon>flip</mat-icon>
            </button>
          </div>
        </div>
      </div>
      } @else if (data.currentPicture) {
      <!-- Current Picture Display -->
      <div class="current-picture">
        <img [src]="data.currentPicture" alt="Current Profile Picture" />
        <div class="picture-actions">
          <button mat-raised-button color="warn" (click)="removePicture()">
            <mat-icon>delete</mat-icon>
            إزالة الصورة الحالية
          </button>
        </div>
      </div>
      } @else {
      <!-- Upload Area -->
      <div
        class="upload-area"
        [class.drag-over]="isDragging()"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
      >
        <input
          type="file"
          #fileInput
          accept="image/jpeg,image/jpg,image/png,image/webp"
          (change)="onFileSelected($event)"
          hidden
        />

        <mat-icon class="upload-icon">cloud_upload</mat-icon>
        <h3>اسحب الصورة هنا</h3>
        <p>أو</p>
        <button mat-raised-button color="primary" (click)="fileInput.click()">
          <mat-icon>folder_open</mat-icon>
          اختر من الجهاز
        </button>
        <p class="upload-hint">
          JPG, PNG, WebP • حجم أقصى 5MB • دقة مُوصى بها 500×500
        </p>
      </div>
      } @if (!currentImage() && !data.currentPicture) {
      <!-- Avatar Selection -->
      <div class="avatar-selection">
        <h4>أو اختر صورة رمزية</h4>
        <div class="avatar-grid">
          @for (avatar of defaultAvatars; track avatar.id) {
          <div
            class="avatar-option"
            [class.selected]="selectedAvatar() === avatar.id"
            (click)="selectAvatar(avatar)"
          >
            <div class="avatar-preview" [style.background]="avatar.background">
              <mat-icon>{{ avatar.icon }}</mat-icon>
            </div>
          </div>
          }
        </div>
      </div>
      }

      <!-- File Input for Replace -->
      @if (currentImage() || data.currentPicture) {
      <input
        type="file"
        #replaceInput
        accept="image/jpeg,image/jpg,image/png,image/webp"
        (change)="onFileSelected($event)"
        hidden
      />
      }
    </div>

    <!-- Error Messages -->
    @if (errorMessage()) {
    <div class="error-message">
      <mat-icon>error</mat-icon>
      {{ errorMessage() }}
    </div>
    }

    <!-- Loading State -->
    @if (loading()) {
    <div class="loading-overlay">
      <mat-spinner></mat-spinner>
      <p>جاري {{ uploadProgress() > 0 ? "رفع" : "معالجة" }} الصورة...</p>
      @if (uploadProgress() > 0) {
      <div class="upload-progress">
        <div class="progress-bar" [style.width.%]="uploadProgress()"></div>
      </div>
      }
    </div>
    }
  </mat-dialog-content>

  <mat-dialog-actions>
    @if (currentImage()) {
    <button mat-button (click)="replaceInput.click()">
      <mat-icon>refresh</mat-icon>
      اختر صورة أخرى
    </button>
    }

    <span class="spacer"></span>

    <button mat-button (click)="cancel()">إلغاء</button>

    @if (currentImage() || selectedAvatar()) {
    <button
      mat-raised-button
      color="primary"
      (click)="save()"
      [disabled]="loading()"
    >
      @if (loading()) {
      <mat-spinner diameter="20"></mat-spinner>
      } @else {
      <mat-icon>save</mat-icon>
      } حفظ الصورة
    </button>
    }
  </mat-dialog-actions>
</div>
