<!-- src/app/features/guest-booking/components/manage-appointments/manage-appointments.component.html -->

<div class="manage-appointments-container">
  <mat-card class="manage-card">
    <div class="manage-header">
      <mat-icon class="header-icon">search</mat-icon>
      <h1>ابحث عن مواعيدك</h1>
      <p class="subtitle">
        أدخل رقم المريض الخاص بك للبحث عن مواعيدك وإدارتها
      </p>
    </div>

    <mat-card-content>
      <form
        [formGroup]="searchForm"
        (ngSubmit)="onSearch()"
        class="search-form"
      >
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>رقم المريض</mat-label>
          <input
            matInput
            formControlName="patientNumber"
            placeholder="مثال: P2024001"
            required
          />
          <mat-icon matPrefix>badge</mat-icon>
          <mat-hint>رقم المريض الذي حصلت عليه عند الحجز</mat-hint>
          @if (searchForm.get('patientNumber')?.hasError('required') &&
          searchForm.get('patientNumber')?.touched) {
          <mat-error>رقم المريض مطلوب</mat-error>
          }
          @if (searchForm.get('patientNumber')?.hasError('minlength')) {
          <mat-error>رقم المريض غير صحيح</mat-error>
          }
        </mat-form-field>

        <button
          mat-raised-button
          color="primary"
          type="submit"
          class="search-button"
          [disabled]="loading() || searchForm.invalid"
        >
          @if (loading()) {
          <mat-spinner diameter="20"></mat-spinner>
          } @else {
          <mat-icon>search</mat-icon>
          }
          <span>{{ loading() ? "جارٍ البحث..." : "بحث عن المواعيد" }}</span>
        </button>
      </form>

      @if (loading()) {
      <div class="loading-state">
        <mat-spinner diameter="50"></mat-spinner>
        <p>جارٍ البحث عن مواعيدك...</p>
      </div>
      }

      @if (!loading() && searched() && appointments().length === 0) {
      <div class="empty-state">
        <mat-icon>event_busy</mat-icon>
        <h3>لم يتم العثور على مواعيد</h3>
        <p>تحقق من رقم المريض وحاول مرة أخرى</p>
      </div>
      }

      @if (appointments().length > 0) {
      <div class="appointments-list">
        <h2>مواعيدك ({{ appointments().length }})</h2>

        @for (appointment of appointments(); track appointment.id) {
        <mat-card class="appointment-card">
          <div class="appointment-header">
            <div class="status-badge">
              <mat-chip [color]="getStatusColor(appointment.status)">
                {{ getStatusLabel(appointment.status) }}
              </mat-chip>
            </div>
            <span class="appointment-id">رقم الموعد: #{{ appointment.tokenNumber }}</span>
          </div>

          <div class="appointment-details">
            <div class="detail-section">
              <h3>
                <mat-icon>person</mat-icon>
                معلومات المريض
              </h3>
              <div class="detail-row">
                <mat-icon>badge</mat-icon>
                <span><strong>رقم المريض:</strong> {{ appointment.patient.patientNumber }}</span>
              </div>
              <div class="detail-row">
                <mat-icon>person_outline</mat-icon>
                <span><strong>الاسم:</strong> {{ appointment.patient.fullName }}</span>
              </div>
              <div class="detail-row">
                <mat-icon>phone</mat-icon>
                <span><strong>الهاتف:</strong> {{ appointment.patient.phone }}</span>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="detail-section">
              <h3>
                <mat-icon>medical_services</mat-icon>
                معلومات الموعد
              </h3>
              <div class="detail-row">
                <mat-icon>person</mat-icon>
                <span><strong>الطبيب:</strong> {{ appointment.doctor.fullName }}</span>
              </div>
              @if (appointment.doctor.specialization) {
              <div class="detail-row">
                <mat-icon>science</mat-icon>
                <span><strong>التخصص:</strong> {{ appointment.doctor.specialization }}</span>
              </div>
              }
              <div class="detail-row">
                <mat-icon>calendar_today</mat-icon>
                <span><strong>التاريخ:</strong> {{ formatDate(appointment.appointmentDate) }}</span>
              </div>
              <div class="detail-row">
                <mat-icon>schedule</mat-icon>
                <span><strong>الوقت:</strong> {{ formatTime(appointment.appointmentTime) }}</span>
              </div>
              <div class="detail-row">
                <mat-icon>schedule</mat-icon>
                <span><strong>رقم الموعد:</strong> {{ appointment.tokenNumber }}</span>
              </div>
              <div class="detail-row">
                <mat-icon>timer</mat-icon>
                <span><strong>المدة:</strong> {{ appointment.durationMinutes }} دقيقة</span>
              </div>
            </div>

            @if (appointment.chiefComplaint) {
            <mat-divider></mat-divider>
            <div class="detail-section">
              <h3>
                <mat-icon>description</mat-icon>
                الشكوى الرئيسية
              </h3>
              <p class="complaint-text">{{ appointment.chiefComplaint }}</p>
            </div>
            }

            @if (appointment.notes) {
            <mat-divider></mat-divider>
            <div class="detail-section">
              <h3>
                <mat-icon>notes</mat-icon>
                ملاحظات
              </h3>
              <p class="notes-text">{{ appointment.notes }}</p>
            </div>
            }
          </div>

          @if (canCancelAppointment(appointment)) {
          <div class="appointment-actions">
            <button
              mat-stroked-button
              color="warn"
              (click)="onCancelAppointment(appointment)"
            >
              <mat-icon>cancel</mat-icon>
              <span>إلغاء الموعد</span>
            </button>
          </div>
          }
        </mat-card>
        }
      </div>
      }
    </mat-card-content>

    <mat-card-actions>
      <button mat-button routerLink="/">
        <mat-icon>arrow_forward</mat-icon>
        <span>العودة للرئيسية</span>
      </button>
      <button mat-raised-button color="primary" routerLink="/guest/book">
        <mat-icon>add</mat-icon>
        <span>حجز موعد جديد</span>
      </button>
    </mat-card-actions>
  </mat-card>
</div>
