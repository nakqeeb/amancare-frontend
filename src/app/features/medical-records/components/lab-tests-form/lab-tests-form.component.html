<mat-card class="lab-tests-card">
  <mat-card-header>
    <mat-card-title>
      <mat-icon>biotech</mat-icon>
      الفحوصات المخبرية
    </mat-card-title>
    <button mat-icon-button (click)="addLabTest()" matTooltip="إضافة فحص">
      <mat-icon>add_circle</mat-icon>
    </button>
  </mat-card-header>
  <mat-card-content>
    <form [formGroup]="labTestsForm">
      <div formArrayName="labTests">
        @for (test of labTests.controls; track $index; let i = $index) {
        <div class="lab-test-item" [formGroupName]="i">
          <div class="test-header">
            <h4>فحص #{{ i + 1 }}</h4>
            <button
              mat-icon-button
              color="warn"
              (click)="removeLabTest(i)"
              matTooltip="حذف الفحص"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="test-grid">
            <!-- Test Name -->
            <mat-form-field appearance="outline" class="test-name">
              <mat-label>اسم الفحص</mat-label>
              <input
                matInput
                formControlName="testName"
                placeholder="مثال: تحليل دم شامل"
              />
              <mat-icon matPrefix>biotech</mat-icon>
              <mat-error>اسم الفحص مطلوب</mat-error>
            </mat-form-field>

            <!-- Test Category -->
            <mat-form-field appearance="outline">
              <mat-label>فئة الفحص</mat-label>
              <mat-select formControlName="category">
                <mat-option [value]="LabTestCategory.HEMATOLOGY">
                  <mat-icon>opacity</mat-icon> دمويات
                </mat-option>
                <mat-option [value]="LabTestCategory.BIOCHEMISTRY">
                  <mat-icon>science</mat-icon> كيمياء حيوية
                </mat-option>
                <mat-option [value]="LabTestCategory.MICROBIOLOGY">
                  <mat-icon>bug_report</mat-icon> أحياء دقيقة
                </mat-option>
                <mat-option [value]="LabTestCategory.IMMUNOLOGY">
                  <mat-icon>shield</mat-icon> مناعة
                </mat-option>
                <mat-option [value]="LabTestCategory.PATHOLOGY">
                  <mat-icon>biotech</mat-icon> أنسجة
                </mat-option>
                <mat-option [value]="LabTestCategory.GENETICS">
                  <mat-icon>dna</mat-icon> وراثة
                </mat-option>
                <mat-option [value]="LabTestCategory.TOXICOLOGY">
                  <mat-icon>warning</mat-icon> سموم
                </mat-option>
              </mat-select>
              <mat-error>فئة الفحص مطلوبة</mat-error>
            </mat-form-field>

            <!-- Urgency -->
            <mat-form-field appearance="outline">
              <mat-label>الأولوية</mat-label>
              <mat-select formControlName="urgency">
                <mat-option [value]="TestUrgency.ROUTINE">
                  <mat-icon>schedule</mat-icon> روتيني
                </mat-option>
                <mat-option [value]="TestUrgency.URGENT">
                  <mat-icon>priority_high</mat-icon> عاجل
                </mat-option>
                <mat-option [value]="TestUrgency.STAT">
                  <mat-icon>emergency</mat-icon> فوري
                </mat-option>
              </mat-select>
              <mat-error>الأولوية مطلوبة</mat-error>
            </mat-form-field>

            <!-- Specimen Type -->
            <mat-form-field appearance="outline">
              <mat-label>نوع العينة</mat-label>
              <mat-select formControlName="specimenType">
                <mat-option value="دم">دم</mat-option>
                <mat-option value="بول">بول</mat-option>
                <mat-option value="براز">براز</mat-option>
                <mat-option value="بلغم">بلغم</mat-option>
                <mat-option value="مسحة">مسحة</mat-option>
                <mat-option value="سائل">سائل</mat-option>
                <mat-option value="أنسجة">أنسجة</mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Instructions -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>تعليمات</mat-label>
              <textarea
                matInput
                formControlName="instructions"
                rows="2"
                placeholder="تعليمات خاصة للمريض أو المختبر..."
              ></textarea>
            </mat-form-field>
          </div>

          @if (i < labTests.length - 1) {
          <mat-divider></mat-divider>
          }
        </div>
        } @if (labTests.length === 0) {
        <div class="empty-state">
          <mat-icon>biotech</mat-icon>
          <p>لم يتم طلب أي فحوصات مخبرية</p>
          <button mat-raised-button color="primary" (click)="addLabTest()">
            <mat-icon>add</mat-icon>
            طلب فحص
          </button>
        </div>
        }
      </div>
    </form>

    @if (labTests.length > 0) {
    <div class="common-tests">
      <h4>فحوصات شائعة</h4>
      <div class="test-chips">
        @for (test of commonTests; track test) {
        <mat-chip (click)="addCommonTest(test)">
          <mat-icon>add</mat-icon>
          {{ test }}
        </mat-chip>
        }
      </div>
    </div>

    <div class="form-actions">
      <button
        mat-raised-button
        color="primary"
        (click)="onSave()"
        [disabled]="labTestsForm.invalid"
      >
        <mat-icon>save</mat-icon>
        حفظ طلبات الفحوصات
      </button>
    </div>
    }
  </mat-card-content>
</mat-card>
