<mat-card class="prescription-card">
  <mat-card-header>
    <mat-card-title>
      <mat-icon>medication</mat-icon>
      الوصفة الطبية
    </mat-card-title>
    <button
      mat-icon-button
      (click)="addPrescription()"
      matTooltip="إضافة دواء جديد"
    >
      <mat-icon>add_circle</mat-icon>
    </button>
  </mat-card-header>
  <mat-card-content>
    <form [formGroup]="prescriptionForm">
      <div formArrayName="prescriptions">
        @for (prescription of prescriptionsArray.controls; track $index; let i =
        $index) {
        <div class="prescription-item" [formGroupName]="i">
          <div class="prescription-header">
            <h4>دواء #{{ i + 1 }}</h4>
            <button
              mat-icon-button
              color="warn"
              (click)="removePrescription(i)"
              matTooltip="حذف الدواء"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="prescription-grid">
            <!-- Medication Name -->
            <mat-form-field appearance="outline" class="medication-name">
              <mat-label>اسم الدواء</mat-label>
              <input
                matInput
                formControlName="medicationName"
                [matAutocomplete]="auto"
                placeholder="اكتب اسم الدواء..."
              />
              <mat-icon matPrefix>medication</mat-icon>
              <mat-autocomplete #auto="matAutocomplete">
                @for (suggestion of getMedicationSuggestions(i) | async; track
                suggestion) {
                <mat-option [value]="suggestion">{{ suggestion }}</mat-option>
                }
              </mat-autocomplete>
              <mat-error>اسم الدواء مطلوب</mat-error>
            </mat-form-field>

            <!-- Generic Name -->
            <mat-form-field appearance="outline">
              <mat-label>الاسم العلمي (اختياري)</mat-label>
              <input matInput formControlName="genericName" />
            </mat-form-field>

            <!-- Dosage -->
            <mat-form-field appearance="outline">
              <mat-label>الجرعة</mat-label>
              <input
                matInput
                formControlName="dosage"
                placeholder="مثال: 500mg"
              />
              <mat-error>الجرعة مطلوبة</mat-error>
            </mat-form-field>

            <!-- Frequency -->
            <mat-form-field appearance="outline">
              <mat-label>التكرار</mat-label>
              <mat-select formControlName="frequency">
                <mat-option value="مرة واحدة يومياً"
                  >مرة واحدة يومياً</mat-option
                >
                <mat-option value="مرتين يومياً">مرتين يومياً</mat-option>
                <mat-option value="ثلاث مرات يومياً"
                  >ثلاث مرات يومياً</mat-option
                >
                <mat-option value="أربع مرات يومياً"
                  >أربع مرات يومياً</mat-option
                >
                <mat-option value="كل 6 ساعات">كل 6 ساعات</mat-option>
                <mat-option value="كل 8 ساعات">كل 8 ساعات</mat-option>
                <mat-option value="كل 12 ساعة">كل 12 ساعة</mat-option>
                <mat-option value="عند الحاجة">عند الحاجة</mat-option>
              </mat-select>
              <mat-error>التكرار مطلوب</mat-error>
            </mat-form-field>

            <!-- Duration -->
            <mat-form-field appearance="outline">
              <mat-label>المدة</mat-label>
              <input
                matInput
                formControlName="duration"
                placeholder="مثال: 7 أيام"
              />
              <mat-error>المدة مطلوبة</mat-error>
            </mat-form-field>

            <!-- Route -->
            <mat-form-field appearance="outline">
              <mat-label>طريقة الإعطاء</mat-label>
              <mat-select formControlName="route">
                <mat-option [value]="MedicationRoute.ORAL">
                  <mat-icon>medication_liquid</mat-icon> فموي
                </mat-option>
                <mat-option [value]="MedicationRoute.INTRAVENOUS">
                  <mat-icon>vaccines</mat-icon> وريدي
                </mat-option>
                <mat-option [value]="MedicationRoute.INTRAMUSCULAR">
                  <mat-icon>vaccines</mat-icon> عضلي
                </mat-option>
                <mat-option [value]="MedicationRoute.SUBCUTANEOUS">
                  <mat-icon>vaccines</mat-icon> تحت الجلد
                </mat-option>
                <mat-option [value]="MedicationRoute.TOPICAL">
                  <mat-icon>spa</mat-icon> موضعي
                </mat-option>
                <mat-option [value]="MedicationRoute.INHALATION">
                  <mat-icon>air</mat-icon> استنشاق
                </mat-option>
                <mat-option [value]="MedicationRoute.OPHTHALMIC">
                  <mat-icon>visibility</mat-icon> قطرة عين
                </mat-option>
                <mat-option [value]="MedicationRoute.OTIC">
                  <mat-icon>hearing</mat-icon> قطرة أذن
                </mat-option>
                <mat-option [value]="MedicationRoute.NASAL">
                  <mat-icon>air</mat-icon> أنفي
                </mat-option>
              </mat-select>
              <mat-error>طريقة الإعطاء مطلوبة</mat-error>
            </mat-form-field>

            <!-- Quantity -->
            <mat-form-field appearance="outline">
              <mat-label>الكمية</mat-label>
              <input
                matInput
                type="number"
                formControlName="quantity"
                placeholder="عدد الحبات/العبوات"
              />
            </mat-form-field>

            <!-- Refills -->
            <mat-form-field appearance="outline">
              <mat-label>إعادة الصرف</mat-label>
              <input
                matInput
                type="number"
                formControlName="refills"
                placeholder="عدد المرات"
              />
            </mat-form-field>

            <!-- Instructions -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>التعليمات</mat-label>
              <textarea
                matInput
                formControlName="instructions"
                rows="2"
                placeholder="تعليمات خاصة للمريض..."
              ></textarea>
            </mat-form-field>

            <!-- PRN Checkbox -->
            <div class="checkbox-field">
              <mat-checkbox formControlName="isPRN">
                عند الحاجة (PRN)
              </mat-checkbox>
            </div>
          </div>

          @if (i < prescriptions!.length - 1) {
          <mat-divider></mat-divider>
          }
        </div>
        } @if (prescriptions!.length === 0) {
        <div class="empty-state">
          <mat-icon>medication</mat-icon>
          <p>لم يتم إضافة أي أدوية بعد</p>
          <button mat-raised-button color="primary" (click)="addPrescription()">
            <mat-icon>add</mat-icon>
            إضافة دواء
          </button>
        </div>
        }
      </div>
    </form>

    @if (prescriptions!.length > 0) {
    <div class="form-actions">
      <button
        mat-raised-button
        color="primary"
        (click)="onSave()"
        [disabled]="prescriptionForm.invalid"
      >
        <mat-icon>save</mat-icon>
        حفظ الوصفة الطبية
      </button>
      <button mat-stroked-button (click)="onPrint()">
        <mat-icon>print</mat-icon>
        طباعة الوصفة
      </button>
    </div>
    }
  </mat-card-content>
</mat-card>
