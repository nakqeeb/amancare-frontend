<!-- src/app/features/medical-records/components/medical-record-details/medical-record-details.component.html -->
<app-header />
<app-sidebar>
  <div class="medical-record-details-container">
    @if (loading()) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>جاري تحميل السجل الطبي...</p>
    </div>
    } @else if (medicalRecord()) {
    <!-- Header -->
    <div class="details-header">
      <div class="header-content">
        <button mat-icon-button (click)="onBack()" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>

        <div class="title-section">
          <h1 class="page-title">
            <mat-icon>description</mat-icon>
            السجل الطبي #{{ medicalRecord()!.id }}
          </h1>
          <div class="record-meta">
            <span class="meta-item">
              <mat-icon>calendar_today</mat-icon>
              {{ formatDate(medicalRecord()!.visitDate) }}
            </span>
            <span class="meta-item">
              <mat-icon>person</mat-icon>
              {{ medicalRecord()!.patientName }}
            </span>
            <span class="meta-item">
              <mat-icon>medical_services</mat-icon>
              د. {{ medicalRecord()!.doctorName }}
            </span>
            <span
              class="status-badge"
              [ngClass]="'status-' + medicalRecord()!.status.toLowerCase()"
            >
              {{ getStatusLabel(medicalRecord()!.status) }}
            </span>
            @if (medicalRecord()!.isConfidential) {
            <span class="confidential-badge">
              <mat-icon>lock</mat-icon>
              سري
            </span>
            }
          </div>
        </div>

        <div class="header-actions">
          @if (canEdit()) {
          <button mat-button (click)="onEdit()">
            <mat-icon>edit</mat-icon>
            تعديل
          </button>
          }

          <button mat-button (click)="onPrint()">
            <mat-icon>print</mat-icon>
            طباعة
          </button>

          <button mat-button (click)="onExportPdf()">
            <mat-icon>picture_as_pdf</mat-icon>
            تصدير PDF
          </button>

          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="onDuplicate()">
              <mat-icon>content_copy</mat-icon>
              <span>نسخ السجل</span>
            </button>
            @if (canLock()) {
            <button mat-menu-item (click)="onToggleLock()">
              <mat-icon>{{
                medicalRecord()!.status === "LOCKED" ? "lock_open" : "lock"
              }}</mat-icon>
              <span>{{
                medicalRecord()!.status === "LOCKED"
                  ? "إلغاء القفل"
                  : "قفل السجل"
              }}</span>
            </button>
            }
            <button mat-menu-item (click)="onViewHistory()">
              <mat-icon>history</mat-icon>
              <span>سجل التعديلات</span>
            </button>
            @if (canDelete()) {
            <mat-divider></mat-divider>
            <button mat-menu-item color="warn" (click)="onDelete()">
              <mat-icon>delete</mat-icon>
              <span>حذف السجل</span>
            </button>
            }
          </mat-menu>
        </div>
      </div>
    </div>

    <!-- Content Tabs -->
    <mat-tab-group class="content-tabs" [(selectedIndex)]="selectedTab">
      <!-- Overview Tab -->
      <mat-tab label="نظرة عامة">
        <div class="tab-content">
          <!-- Patient Information Card -->
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>person</mat-icon>
                معلومات المريض
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-grid">
                <div class="info-item">
                  <label>الاسم:</label>
                  <span>{{ medicalRecord()!.patientName }}</span>
                </div>
                <div class="info-item">
                  <label>رقم المريض:</label>
                  <span>{{ medicalRecord()!.patientNumber }}</span>
                </div>
                <div class="info-item">
                  <label>نوع الزيارة:</label>
                  <span>{{
                    getVisitTypeLabel(medicalRecord()!.visitType)
                  }}</span>
                </div>
                <div class="info-item">
                  <label>تاريخ الزيارة:</label>
                  <span>{{ formatDate(medicalRecord()!.visitDate) }}</span>
                </div>
                @if (medicalRecord()!.appointmentId) {
                <div class="info-item">
                  <label>رقم الموعد:</label>
                  <span>#{{ medicalRecord()!.appointmentId }}</span>
                </div>
                }
                <div class="info-item">
                  <label>الطبيب المعالج:</label>
                  <span>د. {{ medicalRecord()!.doctorName }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Chief Complaint & Present Illness -->
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>medical_information</mat-icon>
                الشكوى والتاريخ المرضي
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="section">
                <h3>الشكوى الرئيسية</h3>
                <p class="content-text">
                  {{ medicalRecord()!.chiefComplaint }}
                </p>
              </div>

              <mat-divider></mat-divider>

              <div class="section">
                <h3>تاريخ المرض الحالي</h3>
                <p class="content-text">
                  {{ medicalRecord()!.presentIllness }}
                </p>
              </div>

              @if (medicalRecord()!.pastMedicalHistory) {
              <mat-divider></mat-divider>
              <div class="section">
                <h3>التاريخ المرضي السابق</h3>
                <p class="content-text">
                  {{ medicalRecord()!.pastMedicalHistory }}
                </p>
              </div>
              }
            </mat-card-content>
          </mat-card>

          <!-- Diagnosis -->
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>medical_services</mat-icon>
                التشخيص
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              @if (medicalRecord()!.diagnosis &&
              medicalRecord()!.diagnosis.length > 0) {
              <div class="diagnoses-list">
                @for (diagnosis of medicalRecord()!.diagnosis; track
                diagnosis.id) {
                <div
                  class="diagnosis-item"
                  [class.primary]="diagnosis.isPrimary"
                >
                  <div class="diagnosis-header">
                    @if (diagnosis.isPrimary) {
                    <span class="primary-badge">رئيسي</span>
                    }
                    <span class="diagnosis-type">{{
                      getDiagnosisTypeLabel(diagnosis.type)
                    }}</span>
                    @if (diagnosis.icdCode) {
                    <span class="icd-code"
                      >ICD-10: {{ diagnosis.icdCode }}</span
                    >
                    }
                  </div>
                  <div class="diagnosis-description">
                    {{ diagnosis.description }}
                  </div>
                  @if (diagnosis.notes) {
                  <div class="diagnosis-notes">
                    {{ diagnosis.notes }}
                  </div>
                  }
                </div>
                }
              </div>
              } @else {
              <p class="no-data">لا يوجد تشخيص</p>
              }
            </mat-card-content>
          </mat-card>

          <!-- Treatment Plan -->
          @if (medicalRecord()!.treatmentPlan) {
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>healing</mat-icon>
                خطة العلاج
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <p class="content-text">{{ medicalRecord()!.treatmentPlan }}</p>
            </mat-card-content>
          </mat-card>
          }
        </div>
      </mat-tab>

      <!-- Vital Signs Tab -->
      <mat-tab label="العلامات الحيوية">
        <div class="tab-content">
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>favorite</mat-icon>
                العلامات الحيوية
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              @if (medicalRecord()!.vitalSigns) {
              <div class="vital-signs-grid">
                @if (medicalRecord()!.vitalSigns?.temperature) {
                <div class="vital-sign-card">
                  <mat-icon>thermostat</mat-icon>
                  <div class="vital-content">
                    <span class="vital-value"
                      >{{ medicalRecord()!.vitalSigns?.temperature }}°C</span
                    >
                    <span class="vital-label">درجة الحرارة</span>
                  </div>
                </div>
                } @if (medicalRecord()!.vitalSigns?.bloodPressureSystolic) {
                <div class="vital-sign-card">
                  <mat-icon>bloodtype</mat-icon>
                  <div class="vital-content">
                    <span class="vital-value">
                      {{
                        medicalRecord()!.vitalSigns?.bloodPressureSystolic
                      }}/{{
                        medicalRecord()!.vitalSigns?.bloodPressureDiastolic
                      }}
                    </span>
                    <span class="vital-label">ضغط الدم</span>
                  </div>
                </div>
                } @if (medicalRecord()!.vitalSigns?.heartRate) {
                <div class="vital-sign-card">
                  <mat-icon>favorite</mat-icon>
                  <div class="vital-content">
                    <span class="vital-value"
                      >{{ medicalRecord()!.vitalSigns?.heartRate }} bpm</span
                    >
                    <span class="vital-label">معدل النبض</span>
                  </div>
                </div>
                } @if (medicalRecord()!.vitalSigns?.respiratoryRate) {
                <div class="vital-sign-card">
                  <mat-icon>air</mat-icon>
                  <div class="vital-content">
                    <span class="vital-value"
                      >{{
                        medicalRecord()!.vitalSigns?.respiratoryRate
                      }}
                      /min</span
                    >
                    <span class="vital-label">معدل التنفس</span>
                  </div>
                </div>
                } @if (medicalRecord()!.vitalSigns?.oxygenSaturation) {
                <div class="vital-sign-card">
                  <mat-icon>opacity</mat-icon>
                  <div class="vital-content">
                    <span class="vital-value"
                      >{{
                        medicalRecord()!.vitalSigns?.oxygenSaturation
                      }}%</span
                    >
                    <span class="vital-label">تشبع الأكسجين</span>
                  </div>
                </div>
                } @if (medicalRecord()!.vitalSigns?.weight) {
                <div class="vital-sign-card">
                  <mat-icon>monitor_weight</mat-icon>
                  <div class="vital-content">
                    <span class="vital-value"
                      >{{ medicalRecord()!.vitalSigns?.weight }} kg</span
                    >
                    <span class="vital-label">الوزن</span>
                  </div>
                </div>
                } @if (medicalRecord()!.vitalSigns?.height) {
                <div class="vital-sign-card">
                  <mat-icon>height</mat-icon>
                  <div class="vital-content">
                    <span class="vital-value"
                      >{{ medicalRecord()!.vitalSigns?.height }} cm</span
                    >
                    <span class="vital-label">الطول</span>
                  </div>
                </div>
                } @if (medicalRecord()!.vitalSigns?.bmi) {
                <div class="vital-sign-card">
                  <mat-icon>accessibility_new</mat-icon>
                  <div class="vital-content">
                    <span class="vital-value">{{
                      medicalRecord()!.vitalSigns?.bmi
                    }}</span>
                    <span class="vital-label">مؤشر كتلة الجسم</span>
                  </div>
                </div>
                }
              </div>
              } @else {
              <p class="no-data">لا توجد علامات حيوية مسجلة</p>
              }
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Prescriptions Tab -->
      <mat-tab label="الوصفات الطبية">
        <div class="tab-content">
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>medication</mat-icon>
                الوصفات الطبية
              </mat-card-title>
              @if (medicalRecord()!.prescriptions &&
              medicalRecord()!.prescriptions!.length > 0) {
              <button mat-button (click)="onPrintPrescription()">
                <mat-icon>print</mat-icon>
                طباعة الوصفة
              </button>
              }
            </mat-card-header>
            <mat-card-content>
              @if (medicalRecord()!.prescriptions &&
              medicalRecord()!.prescriptions!.length > 0) {
              <div class="prescriptions-table">
                <table
                  mat-table
                  [dataSource]="medicalRecord()?.prescriptions || []"
                  class="full-width"
                >
                  <ng-container matColumnDef="medication">
                    <th mat-header-cell *matHeaderCellDef>الدواء</th>
                    <td mat-cell *matCellDef="let prescription">
                      <div class="medication-info">
                        <span class="medication-name">{{
                          prescription.medicationName
                        }}</span>
                        @if (prescription.genericName) {
                        <span class="generic-name"
                          >({{ prescription.genericName }})</span
                        >
                        }
                      </div>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="dosage">
                    <th mat-header-cell *matHeaderCellDef>الجرعة</th>
                    <td mat-cell *matCellDef="let prescription">
                      {{ prescription.dosage }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="frequency">
                    <th mat-header-cell *matHeaderCellDef>التكرار</th>
                    <td mat-cell *matCellDef="let prescription">
                      {{ prescription.frequency }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="duration">
                    <th mat-header-cell *matHeaderCellDef>المدة</th>
                    <td mat-cell *matCellDef="let prescription">
                      {{ prescription.duration }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="route">
                    <th mat-header-cell *matHeaderCellDef>طريقة الإعطاء</th>
                    <td mat-cell *matCellDef="let prescription">
                      {{ getMedicationRouteLabel(prescription.route) }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="instructions">
                    <th mat-header-cell *matHeaderCellDef>التعليمات</th>
                    <td mat-cell *matCellDef="let prescription">
                      {{ prescription.instructions || "-" }}
                    </td>
                  </ng-container>

                  <tr
                    mat-header-row
                    *matHeaderRowDef="prescriptionColumns"
                  ></tr>
                  <tr
                    mat-row
                    *matRowDef="let row; columns: prescriptionColumns"
                  ></tr>
                </table>
              </div>
              } @else {
              <p class="no-data">لا توجد وصفات طبية</p>
              }
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Lab Tests Tab -->
      @if (medicalRecord()!.labTests && medicalRecord()!.labTests!.length > 0) {
      <mat-tab label="التحاليل المخبرية">
        <div class="tab-content">
          <app-lab-results
            [labTests]="medicalRecord()!.labTests"
            [readOnly]="true"
          >
          </app-lab-results>
        </div>
      </mat-tab>
      }

      <!-- Radiology Tab -->
      @if (medicalRecord()!.radiologyTests &&
      medicalRecord()!.radiologyTests!.length > 0) {
      <mat-tab label="الأشعة">
        <div class="tab-content">
          <app-radiology-results
            [radiologyTests]="medicalRecord()!.radiologyTests"
            [readOnly]="true"
          >
          </app-radiology-results>
        </div>
      </mat-tab>
      }

      <!-- Follow-up Tab -->
      <mat-tab label="المتابعة">
        <div class="tab-content">
          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>event</mat-icon>
                معلومات المتابعة
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              @if (medicalRecord()!.followUpDate) {
              <div class="section">
                <h3>موعد المتابعة</h3>
                <p class="follow-up-date">
                  <mat-icon>calendar_today</mat-icon>
                  {{ formatDate(medicalRecord()!.followUpDate!) }}
                </p>
              </div>
              } @if (medicalRecord()!.followUpInstructions) {
              <div class="section">
                <h3>تعليمات المتابعة</h3>
                <p class="content-text">
                  {{ medicalRecord()!.followUpInstructions }}
                </p>
              </div>
              } @if (medicalRecord()!.referrals &&
              medicalRecord()!.referrals!.length > 0) {
              <div class="section">
                <h3>التحويلات</h3>
                <div class="referrals-list">
                  @for (referral of medicalRecord()!.referrals; track
                  referral.id) {
                  <div class="referral-item">
                    <div class="referral-header">
                      <span class="referral-type">
                        {{ getReferralLabel(referral.referralType) }}
                      </span>
                      <span
                        class="referral-priority priority-{{
                          referral.priority.toLowerCase()
                        }}"
                      >
                        {{ getReferralPriorityLabel(referral.priority) }}
                      </span>
                    </div>
                    <div class="referral-content">
                      <p><strong>إلى:</strong> {{ referral.referredTo }}</p>
                      @if (referral.specialty) {
                      <p><strong>التخصص:</strong> {{ referral.specialty }}</p>
                      }
                      <p><strong>السبب:</strong> {{ referral.reason }}</p>
                      @if (referral.notes) {
                      <p><strong>ملاحظات:</strong> {{ referral.notes }}</p>
                      }
                    </div>
                  </div>
                  }
                </div>
              </div>
              } @if (medicalRecord()!.notes) {
              <div class="section">
                <h3>ملاحظات إضافية</h3>
                <p class="content-text">{{ medicalRecord()!.notes }}</p>
              </div>
              }
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>

    <!-- Audit Information -->
    <mat-card class="audit-card">
      <mat-card-content>
        <div class="audit-info">
          <span>
            <mat-icon>create</mat-icon>
            أنشئ بواسطة: {{ medicalRecord()!.createdBy }} في
            {{ formatDateTime(medicalRecord()!.createdAt!) }}
          </span>
          @if (medicalRecord()!.updatedAt) {
          <span>
            <mat-icon>update</mat-icon>
            آخر تحديث: {{ medicalRecord()!.updatedBy }} في
            {{ formatDateTime(medicalRecord()!.updatedAt!) }}
          </span>
          }
        </div>
      </mat-card-content>
    </mat-card>
    } @else {
    <div class="empty-state">
      <mat-icon>error_outline</mat-icon>
      <h3>لم يتم العثور على السجل الطبي</h3>
      <button mat-raised-button color="primary" (click)="onBack()">
        العودة للقائمة
      </button>
    </div>
    }
  </div>
</app-sidebar>
