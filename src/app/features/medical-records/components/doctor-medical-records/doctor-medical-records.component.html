<app-header />
<app-sidebar>
  <div class="doctor-records-container">
    <!-- Header -->
    <div class="page-header">
      <div class="header-content">
        <button mat-icon-button (click)="onBack()" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>

        <div class="title-section">
          <h1 class="page-title">
            <mat-icon>person</mat-icon>
            سجلات الطبيب
          </h1>
          @if (doctor()) {
          <div class="doctor-info">
            <span class="doctor-name">د. {{ doctor()!.fullName }}</span>
            @if (doctor()!.specialization) {
            <span class="doctor-specialty">{{ doctor()!.specialization }}</span>
            }
          </div>
          }
        </div>

        <div class="header-actions">
          <button mat-button (click)="onExport()">
            <mat-icon>download</mat-icon>
            تصدير
          </button>

          <button mat-icon-button (click)="onRefresh()">
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
      </div>

      <!-- Statistics -->
      <div class="doctor-stats">
        <div class="stat-card">
          <mat-icon>description</mat-icon>
          <div class="stat-content">
            <span class="stat-value">{{ totalRecords() }}</span>
            <span class="stat-label">إجمالي السجلات</span>
          </div>
        </div>
        <div class="stat-card">
          <mat-icon>people</mat-icon>
          <div class="stat-content">
            <span class="stat-value">{{ uniquePatients() }}</span>
            <span class="stat-label">عدد المرضى</span>
          </div>
        </div>
        <div class="stat-card">
          <mat-icon>today</mat-icon>
          <div class="stat-content">
            <span class="stat-value">{{ todayRecords() }}</span>
            <span class="stat-label">سجلات اليوم</span>
          </div>
        </div>
        <div class="stat-card">
          <mat-icon>done_all</mat-icon>
          <div class="stat-content">
            <span class="stat-value">{{ completedRecords() }}</span>
            <span class="stat-label">مكتملة</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <mat-card class="filters-card">
      <mat-card-content>
        <div class="filters-row">
          <mat-form-field appearance="outline">
            <mat-label>الفترة الزمنية</mat-label>
            <mat-select
              [(value)]="selectedPeriod"
              (selectionChange)="onFilterChange()"
            >
              <mat-option value="all">الكل</mat-option>
              <mat-option value="today">اليوم</mat-option>
              <mat-option value="week">هذا الأسبوع</mat-option>
              <mat-option value="month">هذا الشهر</mat-option>
              <mat-option value="year">هذه السنة</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>الحالة</mat-label>
            <mat-select
              [(value)]="selectedStatus"
              (selectionChange)="onFilterChange()"
            >
              <mat-option value="">الكل</mat-option>
              <mat-option value="DRAFT">مسودة</mat-option>
              <mat-option value="COMPLETED">مكتمل</mat-option>
              <mat-option value="REVIEWED">مراجع</mat-option>
              <mat-option value="LOCKED">مقفل</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>نوع الزيارة</mat-label>
            <mat-select
              [(value)]="selectedVisitType"
              (selectionChange)="onFilterChange()"
            >
              <mat-option value="">الكل</mat-option>
              <mat-option value="FIRST_VISIT">زيارة أولى</mat-option>
              <mat-option value="FOLLOW_UP">متابعة</mat-option>
              <mat-option value="EMERGENCY">طوارئ</mat-option>
              <mat-option value="ROUTINE_CHECK">فحص دوري</mat-option>
              <mat-option value="CONSULTATION">استشارة</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Records Table -->
    <mat-card class="records-card">
      <mat-card-content>
        @if (loading()) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
          <p>جاري تحميل السجلات...</p>
        </div>
        } @else if (filteredRecords().length === 0) {
        <div class="empty-state">
          <mat-icon>folder_open</mat-icon>
          <h3>لا توجد سجلات</h3>
          <p>لم يتم العثور على سجلات طبية للطبيب المحدد</p>
        </div>
        } @else {
        <table mat-table [dataSource]="filteredRecords()" class="records-table">
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>رقم السجل</th>
            <td mat-cell *matCellDef="let record">#{{ record.id }}</td>
          </ng-container>

          <ng-container matColumnDef="visitDate">
            <th mat-header-cell *matHeaderCellDef>التاريخ</th>
            <td mat-cell *matCellDef="let record">
              {{ formatDate(record.visitDate) }}
            </td>
          </ng-container>

          <ng-container matColumnDef="patient">
            <th mat-header-cell *matHeaderCellDef>المريض</th>
            <td mat-cell *matCellDef="let record">
              <div class="patient-info">
                <span>{{ record.patientName }}</span>
                <span class="patient-number">{{ record.patientNumber }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="visitType">
            <th mat-header-cell *matHeaderCellDef>نوع الزيارة</th>
            <td mat-cell *matCellDef="let record">
              <mat-chip
                [style.background-color]="getVisitTypeColor(record.visitType)"
              >
                {{ getVisitTypeLabel(record.visitType) }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="chiefComplaint">
            <th mat-header-cell *matHeaderCellDef>الشكوى الرئيسية</th>
            <td mat-cell *matCellDef="let record">
              {{ record.chiefComplaint | slice : 0 : 50 }}...
            </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>الحالة</th>
            <td mat-cell *matCellDef="let record">
              <mat-chip
                [style.background-color]="getStatusColor(record.status)"
              >
                {{ getStatusLabel(record.status) }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>الإجراءات</th>
            <td mat-cell *matCellDef="let record">
              <button mat-icon-button (click)="onView(record)" matTooltip="عرض">
                <mat-icon>visibility</mat-icon>
              </button>
              @if (canEdit(record)) {
              <button
                mat-icon-button
                (click)="onEdit(record)"
                matTooltip="تعديل"
              >
                <mat-icon>edit</mat-icon>
              </button>
              }
              <button
                mat-icon-button
                (click)="onPrint(record)"
                matTooltip="طباعة"
              >
                <mat-icon>print</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            (click)="onView(row)"
            class="clickable-row"
          ></tr>
        </table>

        <mat-paginator
          [pageSize]="pageSize"
          [length]="totalRecords()"
          [pageIndex]="currentPage"
          [pageSizeOptions]="[10, 25, 50]"
          (page)="onPageChange($event)"
          showFirstLastButtons
        >
        </mat-paginator>
        }
      </mat-card-content>
    </mat-card>
  </div>
</app-sidebar>
