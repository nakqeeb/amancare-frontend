<app-header />
<app-sidebar>
  <div class="statistics-container">
    <!-- Header -->
    <div class="page-header">
      <div class="header-content">
        <div class="title-section">
          <h1 class="page-title">
            <mat-icon>analytics</mat-icon>
            إحصائيات السجلات الطبية
          </h1>
          <p class="page-subtitle">
            تحليلات شاملة للسجلات الطبية والاتجاهات الصحية
          </p>
        </div>

        <div class="header-actions">
          <mat-form-field appearance="outline" class="period-select">
            <mat-label>الفترة الزمنية</mat-label>
            <mat-select
              [(value)]="selectedPeriod"
              (selectionChange)="onPeriodChange()"
            >
              <mat-option value="today">اليوم</mat-option>
              <mat-option value="week">هذا الأسبوع</mat-option>
              <mat-option value="month">هذا الشهر</mat-option>
              <mat-option value="quarter">ربع السنة</mat-option>
              <mat-option value="year">هذه السنة</mat-option>
              <mat-option value="custom">مخصص</mat-option>
            </mat-select>
          </mat-form-field>

          @if (selectedPeriod === 'custom') {
          <mat-form-field appearance="outline">
            <mat-label>من تاريخ</mat-label>
            <input
              matInput
              [matDatepicker]="fromPicker"
              [(ngModel)]="fromDate"
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="fromPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #fromPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>إلى تاريخ</mat-label>
            <input matInput [matDatepicker]="toPicker" [(ngModel)]="toDate" />
            <mat-datepicker-toggle
              matSuffix
              [for]="toPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #toPicker></mat-datepicker>
          </mat-form-field>
          }

          <button mat-raised-button color="primary" (click)="onExportReport()">
            <mat-icon>download</mat-icon>
            تصدير التقرير
          </button>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="statistics-content">
      @if (loading()) {
      <div class="loading-container">
        <mat-spinner></mat-spinner>
        <p>جاري تحميل الإحصائيات...</p>
      </div>
      } @else {
      <!-- Summary Cards -->
      <div class="summary-cards">
        <mat-card class="summary-card primary">
          <mat-card-content>
            <div class="card-icon">
              <mat-icon>description</mat-icon>
            </div>
            <div class="card-content">
              <h2 class="card-value">{{ statistics()?.totalRecords || 0 }}</h2>
              <p class="card-label">إجمالي السجلات</p>
              <span class="card-trend positive">
                <mat-icon>trending_up</mat-icon>
                +12% من الشهر الماضي
              </span>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card success">
          <mat-card-content>
            <div class="card-icon">
              <mat-icon>today</mat-icon>
            </div>
            <div class="card-content">
              <h2 class="card-value">{{ statistics()?.recordsToday || 0 }}</h2>
              <p class="card-label">سجلات اليوم</p>
              <span class="card-trend positive">
                <mat-icon>trending_up</mat-icon>
                معدل 15 يومياً
              </span>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card warning">
          <mat-card-content>
            <div class="card-icon">
              <mat-icon>pending</mat-icon>
            </div>
            <div class="card-content">
              <h2 class="card-value">
                {{ statistics()?.recordsByStatus?.['DRAFT'] || 0 }}
              </h2>
              <p class="card-label">مسودات</p>
              <span class="card-trend negative">
                <mat-icon>trending_down</mat-icon>
                -5% من الأسبوع الماضي
              </span>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="summary-card info">
          <mat-card-content>
            <div class="card-icon">
              <mat-icon>schedule</mat-icon>
            </div>
            <div class="card-content">
              <h2 class="card-value">{{ statistics()?.followUpRate || 0 }}%</h2>
              <p class="card-label">معدل المتابعة</p>
              <span class="card-trend neutral">
                <mat-icon>remove</mat-icon>
                مستقر
              </span>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Charts Section -->
      <div class="charts-section">
        <!-- Visit Types Distribution -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>توزيع أنواع الزيارات</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <!-- Chart would be rendered here using Chart.js or similar -->
              <div class="chart-placeholder">
                <canvas id="visitTypesChart"></canvas>
              </div>
              <div class="chart-legend">
                @for (type of visitTypes; track type.type) {
                <div class="legend-item">
                  <span
                    class="legend-color"
                    [style.background]="type.color"
                  ></span>
                  <span class="legend-label">{{ type.label }}</span>
                  <span class="legend-value">{{ type.count }}</span>
                </div>
                }
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Records Trend -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>اتجاه السجلات الطبية</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <div class="chart-placeholder">
                <canvas id="recordsTrendChart"></canvas>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Tabs Section -->
      <mat-tab-group class="statistics-tabs">
        <!-- Common Diagnoses Tab -->
        <mat-tab label="التشخيصات الشائعة">
          <div class="tab-content">
            <mat-card>
              <mat-card-header>
                <mat-card-title>أكثر التشخيصات شيوعاً</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <table
                  mat-table
                  [dataSource]="commonDiagnoses()"
                  class="full-width"
                >
                  <ng-container matColumnDef="rank">
                    <th mat-header-cell *matHeaderCellDef>الترتيب</th>
                    <td mat-cell *matCellDef="let element; let i = index">
                      <span class="rank-badge">{{ i + 1 }}</span>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="diagnosis">
                    <th mat-header-cell *matHeaderCellDef>التشخيص</th>
                    <td mat-cell *matCellDef="let element">
                      <div class="diagnosis-info">
                        <span class="diagnosis-name">{{
                          element.diagnosis
                        }}</span>
                        @if (element.icdCode) {
                        <span class="icd-code">{{ element.icdCode }}</span>
                        }
                      </div>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="count">
                    <th mat-header-cell *matHeaderCellDef>العدد</th>
                    <td mat-cell *matCellDef="let element">
                      {{ element.count }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="percentage">
                    <th mat-header-cell *matHeaderCellDef>النسبة</th>
                    <td mat-cell *matCellDef="let element">
                      <div class="percentage-bar">
                        <div
                          class="bar"
                          [style.width.%]="element.percentage"
                        ></div>
                        <span class="value">{{ element.percentage }}%</span>
                      </div>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="diagnosisColumns"></tr>
                  <tr
                    mat-row
                    *matRowDef="let row; columns: diagnosisColumns"
                  ></tr>
                </table>
              </mat-card-content>
            </mat-card>
          </div>
        </mat-tab>

        <!-- Common Medications Tab -->
        <mat-tab label="الأدوية الشائعة">
          <div class="tab-content">
            <mat-card>
              <mat-card-header>
                <mat-card-title>أكثر الأدوية وصفاً</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <table
                  mat-table
                  [dataSource]="commonMedications()"
                  class="full-width"
                >
                  <ng-container matColumnDef="rank">
                    <th mat-header-cell *matHeaderCellDef>الترتيب</th>
                    <td mat-cell *matCellDef="let element; let i = index">
                      <span class="rank-badge">{{ i + 1 }}</span>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="medication">
                    <th mat-header-cell *matHeaderCellDef>الدواء</th>
                    <td mat-cell *matCellDef="let element">
                      <div class="medication-info">
                        <mat-icon>medication</mat-icon>
                        {{ element.medicationName }}
                      </div>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="count">
                    <th mat-header-cell *matHeaderCellDef>عدد الوصفات</th>
                    <td mat-cell *matCellDef="let element">
                      {{ element.count }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="percentage">
                    <th mat-header-cell *matHeaderCellDef>النسبة</th>
                    <td mat-cell *matCellDef="let element">
                      <div class="percentage-bar">
                        <div
                          class="bar medication"
                          [style.width.%]="element.percentage"
                        ></div>
                        <span class="value">{{ element.percentage }}%</span>
                      </div>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="medicationColumns"></tr>
                  <tr
                    mat-row
                    *matRowDef="let row; columns: medicationColumns"
                  ></tr>
                </table>
              </mat-card-content>
            </mat-card>
          </div>
        </mat-tab>

        <!-- Performance Metrics Tab -->
        <mat-tab label="مؤشرات الأداء">
          <div class="tab-content">
            <div class="metrics-grid">
              <mat-card class="metric-card">
                <mat-card-content>
                  <div class="metric-icon">
                    <mat-icon>timer</mat-icon>
                  </div>
                  <div class="metric-details">
                    <h3 class="metric-value">
                      {{ statistics()?.averageConsultationTime || 0 }} دقيقة
                    </h3>
                    <p class="metric-label">متوسط وقت الاستشارة</p>
                  </div>
                </mat-card-content>
              </mat-card>

              <mat-card class="metric-card">
                <mat-card-content>
                  <div class="metric-icon">
                    <mat-icon>event_available</mat-icon>
                  </div>
                  <div class="metric-details">
                    <h3 class="metric-value">{{ completionRate() }}%</h3>
                    <p class="metric-label">معدل إكمال السجلات</p>
                  </div>
                </mat-card-content>
              </mat-card>

              <mat-card class="metric-card">
                <mat-card-content>
                  <div class="metric-icon">
                    <mat-icon>lock</mat-icon>
                  </div>
                  <div class="metric-details">
                    <h3 class="metric-value">
                      {{ statistics()?.confidentialRecordsCount || 0 }}
                    </h3>
                    <p class="metric-label">السجلات السرية</p>
                  </div>
                </mat-card-content>
              </mat-card>

              <mat-card class="metric-card">
                <mat-card-content>
                  <div class="metric-icon">
                    <mat-icon>calendar_month</mat-icon>
                  </div>
                  <div class="metric-details">
                    <h3 class="metric-value">
                      {{ statistics()?.recordsThisMonth || 0 }}
                    </h3>
                    <p class="metric-label">سجلات هذا الشهر</p>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
      }
    </div>
  </div>
</app-sidebar>
