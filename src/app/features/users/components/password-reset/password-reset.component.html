<!-- ===================================================================
     Password Reset Component Template
     src/app/features/users/components/password-reset/password-reset.component.html
     =================================================================== -->

<div class="password-reset-dialog">
  <!-- Dialog Header -->
  <div class="dialog-header">
    <h2 mat-dialog-title>
      <mat-icon>{{ data.mode === "reset" ? "lock_reset" : "key" }}</mat-icon>
      {{ getDialogTitle() }}
    </h2>

    <button
      mat-icon-button
      mat-dialog-close
      class="close-button"
      matTooltip="إغلاق"
    >
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Dialog Content -->
  <mat-dialog-content class="dialog-content">
    <!-- User Info -->
    <div class="user-info">
      <div class="user-avatar">
        <img
          [src]="
            data.user.profilePicture || '/assets/images/default-avatar.png'
          "
          [alt]="data.user.fullName"
          class="avatar-img"
        />
      </div>

      <div class="user-details">
        <div class="user-name">
          {{ data.user.firstName }} {{ data.user.lastName }}
        </div>
        <div class="user-role">{{ data.user.email }}</div>
        <div class="action-description">{{ getDialogDescription() }}</div>
      </div>
    </div>

    <mat-divider></mat-divider>

    <!-- Reset Mode (Admin Reset) -->
    @if (data.mode === 'reset') {
    <div class="reset-mode">
      <div class="reset-info">
        <mat-icon class="info-icon">info</mat-icon>
        <div class="info-content">
          <h3>إعادة تعيين كلمة المرور</h3>
          <p>
            سيتم إنشاء كلمة مرور مؤقتة جديدة وإرسالها للمستخدم. سيُطلب من
            المستخدم تغييرها عند تسجيل الدخول التالي.
          </p>
        </div>
      </div>

      <div class="reset-warning">
        <mat-icon class="warning-icon">warning</mat-icon>
        <p>تحذير: كلمة المرور الحالية ستصبح غير صالحة فوراً</p>
      </div>
    </div>
    }

    <!-- Change Mode (Set New Password) -->
    @if (data.mode === 'change') {
    <div class="change-mode">
      <form [formGroup]="passwordForm" class="password-form">
        <!-- Password Generator Section -->
        <div class="generator-section">
          <button
            type="button"
            mat-stroked-button
            color="primary"
            (click)="generatePassword()"
            class="generate-btn"
          >
            <mat-icon>auto_fix_high</mat-icon>
            إنشاء كلمة مرور قوية
          </button>
        </div>

        <!-- New Password Field -->
        <mat-form-field class="password-field">
          <mat-label>كلمة المرور الجديدة</mat-label>
          <input
            matInput
            [type]="passwordVisible() ? 'text' : 'password'"
            formControlName="newPassword"
            placeholder="أدخل كلمة مرور قوية"
          />

          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="togglePasswordVisibility()"
            [matTooltip]="
              passwordVisible() ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور'
            "
          >
            <mat-icon>{{
              passwordVisible() ? "visibility_off" : "visibility"
            }}</mat-icon>
          </button>

          @if (newPassword?.value) {
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="copyPassword()"
            matTooltip="نسخ كلمة المرور"
          >
            <mat-icon>content_copy</mat-icon>
          </button>
          }

          <mat-error>{{ getErrorMessage("newPassword") }}</mat-error>
        </mat-form-field>

        <!-- Password Strength Indicator -->
        @if (newPassword?.value) {
        <div class="password-strength">
          <div class="strength-label">قوة كلمة المرور:</div>
          <div class="strength-bar">
            <div
              class="strength-fill"
              [style.width]="getPasswordStrength().width"
              [style.background-color]="getPasswordStrength().color"
            ></div>
          </div>
          <div
            class="strength-text"
            [style.color]="getPasswordStrength().color"
          >
            {{ getPasswordStrength().level }}
          </div>
        </div>
        }

        <!-- Confirm Password Field -->
        <mat-form-field class="password-field">
          <mat-label>تأكيد كلمة المرور</mat-label>
          <input
            matInput
            [type]="confirmPasswordVisible() ? 'text' : 'password'"
            formControlName="confirmPassword"
            placeholder="أعد إدخال كلمة المرور"
          />

          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="toggleConfirmPasswordVisibility()"
            [matTooltip]="
              confirmPasswordVisible()
                ? 'إخفاء كلمة المرور'
                : 'إظهار كلمة المرور'
            "
          >
            <mat-icon>{{
              confirmPasswordVisible() ? "visibility_off" : "visibility"
            }}</mat-icon>
          </button>

          <mat-error>{{ getErrorMessage("confirmPassword") }}</mat-error>
        </mat-form-field>

        <!-- Password Requirements Section -->
        <div class="password-requirements">
          <h4>متطلبات كلمة المرور:</h4>
          <ul class="requirements-list">
            <li [class.met]="meetsMinLength()">
              <mat-icon class="req-icon">
                {{ meetsMinLength() ? "check_circle" : "cancel" }}
              </mat-icon>
              8 أحرف على الأقل
            </li>
            <li [class.met]="meetsLowerCase()">
              <mat-icon class="req-icon">
                {{ meetsLowerCase() ? "check_circle" : "cancel" }}
              </mat-icon>
              حرف صغير واحد على الأقل
            </li>
            <li [class.met]="meetsUpperCase()">
              <mat-icon class="req-icon">
                {{ meetsUpperCase() ? "check_circle" : "cancel" }}
              </mat-icon>
              حرف كبير واحد على الأقل
            </li>
            <li [class.met]="meetsNumber()">
              <mat-icon class="req-icon">
                {{ meetsNumber() ? "check_circle" : "cancel" }}
              </mat-icon>
              رقم واحد على الأقل
            </li>
            <li [class.met]="meetsSpecialChar()">
              <mat-icon class="req-icon">
                {{ meetsSpecialChar() ? "check_circle" : "cancel" }}
              </mat-icon>
              رمز خاص واحد على الأقل (!@#$%^&*)
            </li>
          </ul>
        </div>
      </form>
    </div>
    }
  </mat-dialog-content>

  <!-- Dialog Actions -->
  <mat-dialog-actions class="dialog-actions">
    <button mat-stroked-button (click)="onCancel()" [disabled]="loading()">
      إلغاء
    </button>

    <button
      mat-raised-button
      color="primary"
      (click)="onSubmit()"
      [disabled]="loading() || (data.mode === 'change' && !passwordForm.valid)"
    >
      @if (loading()) {
      <mat-spinner
        diameter="20"
        color="inherit"
        class="button-spinner"
      ></mat-spinner>
      } @else {
      <mat-icon>
        {{ data.mode === "reset" ? "lock_reset" : "key" }}
      </mat-icon>
      }
      {{ getSubmitButtonText() }}
    </button>
  </mat-dialog-actions>
</div>
