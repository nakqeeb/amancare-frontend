<!-- ===================================================================
     src/app/features/auth/components/reset-password/reset-password.component.html
     =================================================================== -->

<div class="auth-container">
  <!-- Background -->
  <div class="auth-background">
    <div class="background-shapes">
      <div class="shape shape-1"></div>
      <div class="shape shape-2"></div>
    </div>
  </div>

  <!-- Content -->
  <div class="auth-content">
    <!-- Header -->
    <div class="auth-header">
      <!-- <mat-icon class="app-logo">local_hospital</mat-icon> -->
      <img class="app-logo" src="images/logo.png" />
      <h1>إعادة تعيين كلمة المرور</h1>
      <p>إنشاء كلمة مرور جديدة لحسابك</p>
    </div>

    <!-- Reset Password Card -->
    <mat-card class="auth-card">
      <!-- Loading State -->
      @if (isValidating()) {
      <div class="loading-content">
        <mat-spinner diameter="40"></mat-spinner>
        <p>جاري التحقق من الرمز...</p>
      </div>
      }

      <!-- Invalid Token State -->
      @else if (!isValidToken()) {
      <div class="error-content">
        <mat-icon class="error-icon">error_outline</mat-icon>
        <h3>رمز غير صحيح</h3>
        <p>الرمز المستخدم غير صحيح أو انتهت صلاحيته.</p>
        <div class="error-actions">
          <button
            mat-raised-button
            color="primary"
            (click)="goToForgotPassword()"
          >
            <mat-icon>refresh</mat-icon>
            طلب رمز جديد
          </button>
          <button mat-button (click)="goToLogin()">
            <mat-icon>arrow_back</mat-icon>
            العودة لتسجيل الدخول
          </button>
        </div>
      </div>
      }

      <!-- Valid Token - Reset Form -->
      @else {
      <form [formGroup]="resetForm" (ngSubmit)="onSubmit()">
        <h2 class="form-title">إنشاء كلمة مرور جديدة</h2>

        <!-- New Password -->
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>كلمة المرور الجديدة</mat-label>
          <input
            matInput
            [type]="hideNewPassword() ? 'password' : 'text'"
            formControlName="newPassword"
            placeholder="أدخل كلمة المرور الجديدة"
          />
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="hideNewPassword.set(!hideNewPassword())"
          >
            <mat-icon>
              {{ hideNewPassword() ? "visibility" : "visibility_off" }}
            </mat-icon>
          </button>

          <!-- Password Strength Indicator -->
          @if (resetForm.get('newPassword')?.value) {
          <div class="password-strength">
            <div class="strength-bar">
              <div
                class="strength-fill"
                [style.width.%]="getPasswordStrength().score * 20"
                [ngClass]="'strength-' + getPasswordStrength().color"
              ></div>
            </div>
            <span class="strength-label">{{
              getPasswordStrength().label
            }}</span>
          </div>
          }

          <mat-error *ngIf="resetForm.get('newPassword')?.hasError('required')">
            كلمة المرور الجديدة مطلوبة
          </mat-error>
          <mat-error
            *ngIf="resetForm.get('newPassword')?.hasError('minlength')"
          >
            يجب أن تكون كلمة المرور 8 أحرف على الأقل
          </mat-error>
          <mat-error
            *ngIf="resetForm.get('newPassword')?.hasError('weakPassword')"
          >
            كلمة المرور ضعيفة. يجب أن تحتوي على أحرف كبيرة وصغيرة وأرقام ورموز
          </mat-error>
        </mat-form-field>

        <!-- Confirm Password -->
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>تأكيد كلمة المرور</mat-label>
          <input
            matInput
            [type]="hideConfirmPassword() ? 'password' : 'text'"
            formControlName="confirmPassword"
            placeholder="أعد كتابة كلمة المرور"
          />
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="hideConfirmPassword.set(!hideConfirmPassword())"
          >
            <mat-icon>
              {{ hideConfirmPassword() ? "visibility" : "visibility_off" }}
            </mat-icon>
          </button>
          <mat-error
            *ngIf="resetForm.get('confirmPassword')?.hasError('required')"
          >
            تأكيد كلمة المرور مطلوب
          </mat-error>
          <mat-error *ngIf="hasPasswordMismatch()">
            كلمات المرور غير متطابقة
          </mat-error>
        </mat-form-field>

        <!-- Password Requirements -->
        <div class="password-requirements">
          <h4>متطلبات كلمة المرور:</h4>
          <ul>
            <li [class.met]="hasMinLength()">8 أحرف على الأقل</li>
            <li [class.met]="hasUpperCase()">حرف كبير واحد على الأقل</li>
            <li [class.met]="hasLowerCase()">حرف صغير واحد على الأقل</li>
            <li [class.met]="hasNumber()">رقم واحد على الأقل</li>
            <li [class.met]="hasSpecialChar()">رمز خاص واحد على الأقل</li>
          </ul>
        </div>

        <!-- Submit Button -->
        <button
          mat-raised-button
          color="primary"
          type="submit"
          class="submit-button"
          [disabled]="resetForm.invalid || isLoading()"
        >
          @if (isLoading()) {
          <mat-spinner diameter="20"></mat-spinner>
          جاري تغيير كلمة المرور... } @else {
          <mat-icon>save</mat-icon>
          تغيير كلمة المرور }
        </button>

        <!-- Footer Links -->
        <div class="form-footer">
          <mat-divider></mat-divider>
          <p>
            <a routerLink="/auth/login" class="auth-link">
              <mat-icon>arrow_back</mat-icon>
              العودة إلى تسجيل الدخول
            </a>
          </p>
        </div>
      </form>
      }
    </mat-card>
  </div>
</div>
