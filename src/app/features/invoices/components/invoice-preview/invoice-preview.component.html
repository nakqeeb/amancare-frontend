<!-- ===================================================================
     src/app/features/invoices/components/invoice-preview/invoice-preview.component.html
     =================================================================== -->
<div class="invoice-preview-container" [class.fullscreen]="isFullscreen()">
  <!-- Header (Hidden in print) -->
  <div class="preview-header no-print">
    <app-header></app-header>
    <app-sidebar>
      <div class="header-content">
        <div class="title-section">
          <button mat-icon-button (click)="navigateBack()" class="back-button">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <div class="title-info">
            <h1 class="page-title">معاينة الفاتورة</h1>
            <p class="page-subtitle">{{ invoice()?.invoiceNumber }}</p>
          </div>
        </div>

        <div class="header-actions">
          <button
            mat-icon-button
            (click)="toggleFullscreen()"
            [matTooltip]="isFullscreen() ? 'إلغاء ملء الشاشة' : 'ملء الشاشة'"
          >
            <mat-icon>{{
              isFullscreen() ? "fullscreen_exit" : "fullscreen"
            }}</mat-icon>
          </button>

          <button mat-stroked-button (click)="printInvoice()">
            <mat-icon>print</mat-icon>
            طباعة
          </button>

          <button mat-stroked-button color="primary" (click)="generatePDF()">
            <mat-icon>picture_as_pdf</mat-icon>
            تحميل PDF
          </button>

          <button mat-raised-button color="primary" (click)="sendEmail()">
            <mat-icon>email</mat-icon>
            إرسال بالبريد
          </button>
        </div>
      </div>
    </app-sidebar>
  </div>

  <!-- Loading State -->
  @if (loading()) {
  <div class="loading-container no-print">
    <mat-spinner diameter="50"></mat-spinner>
    <p>جاري تحميل الفاتورة...</p>
  </div>
  }

  <!-- Invoice Content -->
  @if (!loading() && invoice()) {
  <div class="invoice-content">
    <!-- Company Header -->
    <div class="company-header">
      <div class="company-info">
        <div class="company-logo">
          <!-- Logo would go here -->
          <div class="logo-placeholder">
            <mat-icon>local_hospital</mat-icon>
          </div>
        </div>
        <div class="company-details">
          <h1 class="company-name">{{ companyInfo.name }}</h1>
          <h2 class="company-name-en">{{ companyInfo.nameEn }}</h2>
          <div class="company-contact">
            <div class="contact-item">
              <mat-icon>location_on</mat-icon>
              <span>{{ companyInfo.address }}</span>
            </div>
            <div class="contact-item">
              <mat-icon>phone</mat-icon>
              <span>{{ companyInfo.phone }}</span>
            </div>
            <div class="contact-item">
              <mat-icon>email</mat-icon>
              <span>{{ companyInfo.email }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="invoice-header-info">
        <h2 class="invoice-title">
          فـــاتــورة ضـــريـــبـــيـــة
          <br />
          <span class="invoice-title-en">TAX INVOICE</span>
        </h2>
        <div class="invoice-meta">
          <div class="meta-item">
            <span class="label">رقم الفاتورة:</span>
            <span class="value">{{ invoice()?.invoiceNumber }}</span>
          </div>
          <div class="meta-item">
            <span class="label">تاريخ الإصدار:</span>
            <span class="value">{{ formatDate(invoice()?.issueDate!) }}</span>
          </div>
          <div class="meta-item">
            <span class="label">تاريخ الاستحقاق:</span>
            <span class="value">{{ formatDate(invoice()?.dueDate!) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Patient Information -->
    <div class="patient-section">
      <div class="section-title">
        <h3>معلومات العميل</h3>
        <span class="section-title-en">Customer Information</span>
      </div>
      <div class="patient-info">
        <div class="patient-details">
          <div class="info-row">
            <span class="label">الاسم:</span>
            <span class="value">{{ invoice()?.patientName }}</span>
          </div>
          @if (invoice()?.patientPhone) {
          <div class="info-row">
            <span class="label">الهاتف:</span>
            <span class="value">{{ invoice()?.patientPhone }}</span>
          </div>
          }
          <div class="info-row">
            <span class="label">رقم العميل:</span>
            <span class="value">{{ invoice()?.patientId }}</span>
          </div>
        </div>

        <div class="invoice-status">
          @if (isOverdue(invoice()!)) {
          <div class="status-badge overdue">متأخرة السداد</div>
          } @else if (invoice()?.remainingAmount === 0) {
          <div class="status-badge paid">مدفوعة بالكامل</div>
          } @else {
          <div class="status-badge pending">
            {{ getPaymentStatusText() }}
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Services Table -->
    <div class="services-section">
      <div class="section-title">
        <h3>تفاصيل الخدمات</h3>
        <span class="section-title-en">Service Details</span>
      </div>

      <table class="services-table">
        <thead>
          <tr>
            <th class="service-name">وصف الخدمة / Service Description</th>
            <th class="quantity">الكمية / Qty</th>
            <th class="unit-price">سعر الوحدة / Unit Price</th>
            <th class="total-price">الإجمالي / Total</th>
          </tr>
        </thead>
        <tbody>
          @for (item of invoice()?.items || []; track item.id || $index) {
          <tr>
            <td class="service-name">
              <div class="service-details">
                <div class="service-name-ar">{{ item.serviceName }}</div>
                @if (item.description) {
                <div class="service-description">{{ item.description }}</div>
                }
                <div class="service-category">
                  {{ getServiceCategoryText(item.category) }}
                </div>
              </div>
            </td>
            <td class="quantity">{{ item.quantity }}</td>
            <td class="unit-price">{{ formatCurrency(item.unitPrice) }}</td>
            <td class="total-price">{{ formatCurrency(item.totalPrice) }}</td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Financial Summary -->
    <div class="summary-section">
      <div class="summary-content">
        <div class="summary-left">
          <!-- Amount in Words -->
          <div class="amount-in-words">
            <div class="section-title">
              <h4>المبلغ بالأحرف</h4>
              <span class="section-title-en">Amount in Words</span>
            </div>
            <div class="words-content">
              {{ convertNumberToArabicWords(invoice()?.totalAmount!) }}
            </div>
          </div>

          <!-- Payment Terms -->
          @if (invoice()?.terms) {
          <div class="payment-terms">
            <div class="section-title">
              <h4>شروط الدفع</h4>
              <span class="section-title-en">Payment Terms</span>
            </div>
            <div class="terms-content">
              {{ invoice()?.terms }}
            </div>
          </div>
          }
        </div>

        <div class="summary-right">
          <div class="calculation-table">
            <div class="calculation-row">
              <span class="label">المجموع الفرعي / Subtotal:</span>
              <span class="value">{{
                formatCurrency(invoice()?.subtotal!)
              }}</span>
            </div>

            @if (invoice()?.discountAmount && invoice()?.discountAmount! > 0) {
            <div class="calculation-row discount">
              <span class="label">الخصم / Discount:</span>
              <span class="value"
                >-{{ formatCurrency(invoice()?.discountAmount!) }}</span
              >
            </div>
            }

            <div class="calculation-row">
              <span class="label"
                >ضريبة القيمة المضافة ({{ invoice()?.taxPercentage || 15 }}%) /
                VAT:</span
              >
              <span class="value">{{
                formatCurrency(invoice()?.taxAmount!)
              }}</span>
            </div>

            <div class="calculation-divider"></div>

            <div class="calculation-row total">
              <span class="label"
                >الإجمالي شامل الضريبة / Total (Incl. VAT):</span
              >
              <span class="value">{{
                formatCurrency(invoice()?.totalAmount!)
              }}</span>
            </div>

            @if (invoice()?.paidAmount && invoice()?.paidAmount! > 0) {
            <div class="calculation-row paid">
              <span class="label">المبلغ المدفوع / Paid Amount:</span>
              <span class="value">{{
                formatCurrency(invoice()?.paidAmount!)
              }}</span>
            </div>

            <div class="calculation-row remaining">
              <span class="label">المبلغ المستحق / Amount Due:</span>
              <span class="value">{{
                formatCurrency(invoice()?.remainingAmount!)
              }}</span>
            </div>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Notes Section -->
    @if (invoice()?.notes) {
    <div class="notes-section">
      <div class="section-title">
        <h4>ملاحظات</h4>
        <span class="section-title-en">Notes</span>
      </div>
      <div class="notes-content">
        {{ invoice()?.notes }}
      </div>
    </div>
    }

    <!-- Footer -->
    <div class="invoice-footer">
      <div class="footer-content">
        <div class="footer-left">
          <div class="tax-info">
            <div class="tax-item">
              <span class="label">الرقم الضريبي / Tax ID:</span>
              <span class="value">{{ companyInfo.taxId }}</span>
            </div>
            <div class="tax-item">
              <span class="label">رقم السجل التجاري / CR Number:</span>
              <span class="value">{{ companyInfo.crNumber }}</span>
            </div>
          </div>
        </div>

        <div class="footer-right">
          <div class="signature-section">
            <div class="signature-box">
              <div class="signature-line"></div>
              <div class="signature-label">
                التوقيع والختم / Signature & Stamp
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer-bottom">
        <div class="company-contact-footer">
          <span>{{ companyInfo.website }}</span>
          <span>•</span>
          <span>{{ companyInfo.email }}</span>
          <span>•</span>
          <span>{{ companyInfo.phone }}</span>
        </div>
      </div>
    </div>

    <!-- QR Code Section (for Saudi Arabia tax compliance) -->
    <div class="qr-section">
      <div class="qr-placeholder">
        <mat-icon>qr_code</mat-icon>
        <span>رمز الاستجابة السريعة</span>
      </div>
    </div>
  </div>
  }

  <!-- Error State -->
  @if (!loading() && !invoice()) {
  <div class="error-state no-print">
    <mat-icon class="error-icon">error</mat-icon>
    <h3>لم يتم العثور على الفاتورة</h3>
    <p>الفاتورة المطلوبة غير موجودة أو تم حذفها.</p>
    <button mat-raised-button color="primary" (click)="navigateBack()">
      <mat-icon>arrow_back</mat-icon>
      العودة
    </button>
  </div>

  }
</div>
