<!-- ===================================================================
     src/app/features/invoices/components/invoice-form/invoice-form.component.html
     =================================================================== -->
<div class="invoice-form-container">
  <!-- Header -->
  <app-header></app-header>

  <!-- Sidebar -->
  <app-sidebar>
    <!-- Main Content -->
    <div class="main-content">
      <div class="page-header">
        <div class="header-content">
          <div class="title-section">
            <h1 class="page-title">
              <mat-icon>receipt_long</mat-icon>
              @if (isEditMode()) { تعديل الفاتورة } @else { إنشاء فاتورة جديدة }
            </h1>
            <p class="page-subtitle">
              @if (isEditMode()) { تعديل تفاصيل الفاتورة الحالية } @else { إنشاء
              فاتورة جديدة للمريض }
            </p>
          </div>

          <div class="header-actions">
            <button mat-stroked-button (click)="onCancel()">
              <mat-icon>cancel</mat-icon>
              إلغاء
            </button>
          </div>
        </div>
      </div>

      <!-- Loading Spinner -->
      @if (loading()) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>جاري التحميل...</p>
      </div>
      }

      <!-- Invoice Form -->
      @if (!loading()) {
      <form [formGroup]="invoiceForm" (ngSubmit)="onSubmit()">
        <mat-card class="form-card">
          <mat-card-content>
            <mat-stepper [selectedIndex]="currentStep()" #stepper>
              <!-- Step 1: Patient Information -->
              <mat-step
                [stepControl]="invoiceForm.get('patientId')!"
                label="معلومات المريض"
              >
                <ng-template matStepContent>
                  <div class="step-content">
                    <h3>اختيار المريض</h3>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>البحث عن المريض</mat-label>
                        <input
                          matInput
                          formControlName="patientSearch"
                          [matAutocomplete]="patientAuto"
                          placeholder="ابحث بالاسم أو الهاتف أو البريد الإلكتروني"
                        />
                        <mat-icon matSuffix>search</mat-icon>
                        <mat-autocomplete
                          #patientAuto="matAutocomplete"
                          [displayWith]="displayPatient"
                        >
                          @for (patient of filteredPatients$ | async; track
                          patient.id) {
                          <mat-option
                            [value]="patient"
                            (onSelectionChange)="onPatientSelected(patient)"
                          >
                            <div class="patient-option">
                              <div class="patient-name">
                                {{ patient.firstName }} {{ patient.lastName }}
                              </div>
                              <div class="patient-details">
                                <span>{{ patient.phone }}</span>
                                @if (patient.email) {
                                <span> • {{ patient.email }}</span>
                                }
                              </div>
                            </div>
                          </mat-option>
                          }
                        </mat-autocomplete>
                        @if (invoiceForm.get('patientId')?.hasError('required')
                        && invoiceForm.get('patientId')?.touched) {
                        <mat-error>يرجى اختيار المريض</mat-error>
                        }
                      </mat-form-field>
                    </div>

                    <!-- Selected Patient Info -->
                    @if (selectedPatient()) {
                    <mat-card class="selected-patient-card">
                      <mat-card-content>
                        <div class="patient-info">
                          <div class="patient-avatar">
                            <mat-icon>person</mat-icon>
                          </div>
                          <div class="patient-details">
                            <h4>
                              {{ selectedPatient()?.firstName }}
                              {{ selectedPatient()?.lastName }}
                            </h4>
                            <div class="detail-row">
                              <mat-icon>phone</mat-icon>
                              <span>{{ selectedPatient()?.phone }}</span>
                            </div>
                            @if (selectedPatient()?.email) {
                            <div class="detail-row">
                              <mat-icon>email</mat-icon>
                              <span>{{ selectedPatient()?.email }}</span>
                            </div>
                            } @if (selectedPatient()?.dateOfBirth) {
                            <div class="detail-row">
                              <mat-icon>cake</mat-icon>
                              <span>{{
                                selectedPatient()?.dateOfBirth
                                  | date : "dd/MM/yyyy"
                              }}</span>
                            </div>
                            }
                          </div>
                        </div>
                      </mat-card-content>
                    </mat-card>
                    }

                    <!-- Additional Fields -->
                    <div class="form-row">
                      <mat-form-field appearance="outline">
                        <mat-label>تاريخ الاستحقاق</mat-label>
                        <input
                          matInput
                          [matDatepicker]="duePicker"
                          formControlName="dueDate"
                          required
                        />
                        <mat-datepicker-toggle
                          matSuffix
                          [for]="duePicker"
                        ></mat-datepicker-toggle>
                        <mat-datepicker #duePicker></mat-datepicker>
                        @if (invoiceForm.get('dueDate')?.hasError('required') &&
                        invoiceForm.get('dueDate')?.touched) {
                        <mat-error>يرجى تحديد تاريخ الاستحقاق</mat-error>
                        }
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>الأولوية</mat-label>
                        <mat-select formControlName="priority">
                          <mat-option value="LOW">منخفضة</mat-option>
                          <mat-option value="NORMAL">عادية</mat-option>
                          <mat-option value="HIGH">عالية</mat-option>
                          <mat-option value="URGENT">عاجل</mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>

                    <div class="step-actions">
                      <button
                        mat-raised-button
                        color="primary"
                        [disabled]="!selectedPatient()"
                        (click)="nextStep()"
                      >
                        التالي
                        <mat-icon>arrow_forward</mat-icon>
                      </button>
                    </div>
                  </div>
                </ng-template>
              </mat-step>

              <!-- Step 2: Invoice Items -->
              <mat-step
                [stepControl]="invoiceForm.get('items')!"
                label="بنود الفاتورة"
              >
                <ng-template matStepContent>
                  <div class="step-content">
                    <div class="step-header">
                      <h3>بنود الفاتورة</h3>
                      <button
                        mat-raised-button
                        color="primary"
                        (click)="addItem()"
                      >
                        <mat-icon>add</mat-icon>
                        إضافة بند
                      </button>
                    </div>

                    <!-- Predefined Services -->
                    @if (predefinedServices().length > 0) {
                    <mat-card class="predefined-services-card">
                      <mat-card-header>
                        <mat-card-title>الخدمات المعرّفة مسبقاً</mat-card-title>
                      </mat-card-header>
                      <mat-card-content>
                        <div class="services-grid">
                          @for (service of predefinedServices(); track
                          service.serviceName) {
                          <div
                            class="service-item"
                            (click)="addPredefinedService(service)"
                          >
                            <div class="service-name">
                              {{ service.serviceName }}
                            </div>
                            <div class="service-price">
                              {{ formatCurrency(service.unitPrice) }}
                            </div>
                            <mat-icon>add_circle_outline</mat-icon>
                          </div>
                          }
                        </div>
                      </mat-card-content>
                    </mat-card>
                    }

                    <!-- Items Table -->
                    @if (invoiceItemsArray.length > 0) {
                    <div class="items-table-container">
                      <table
                        mat-table
                        [dataSource]="invoiceItemsArray.controls"
                        class="items-table"
                      >
                        <!-- Service Name Column -->
                        <ng-container matColumnDef="serviceName">
                          <th mat-header-cell *matHeaderCellDef>الخدمة</th>
                          <td mat-cell *matCellDef="let item; let i = index">
                            <div [formGroup]="item">
                              <mat-form-field appearance="outline">
                                <input
                                  matInput
                                  formControlName="serviceName"
                                  placeholder="اسم الخدمة"
                                />
                              </mat-form-field>
                              <mat-form-field appearance="outline">
                                <mat-select formControlName="category">
                                  <mat-option value="CONSULTATION"
                                    >استشارة</mat-option
                                  >
                                  <mat-option value="PROCEDURE"
                                    >إجراء طبي</mat-option
                                  >
                                  <mat-option value="MEDICATION"
                                    >دواء</mat-option
                                  >
                                  <mat-option value="LAB_TEST"
                                    >فحص مختبر</mat-option
                                  >
                                  <mat-option value="RADIOLOGY"
                                    >أشعة</mat-option
                                  >
                                  <mat-option value="SURGERY"
                                    >عملية جراحية</mat-option
                                  >
                                  <mat-option value="OTHER">أخرى</mat-option>
                                </mat-select>
                              </mat-form-field>
                            </div>
                          </td>
                        </ng-container>

                        <!-- Quantity Column -->
                        <ng-container matColumnDef="quantity">
                          <th mat-header-cell *matHeaderCellDef>الكمية</th>
                          <td mat-cell *matCellDef="let item">
                            <div [formGroup]="item">
                              <mat-form-field appearance="outline">
                                <input
                                  matInput
                                  type="number"
                                  formControlName="quantity"
                                  min="1"
                                />
                              </mat-form-field>
                            </div>
                          </td>
                        </ng-container>

                        <!-- Unit Price Column -->
                        <ng-container matColumnDef="unitPrice">
                          <th mat-header-cell *matHeaderCellDef>سعر الوحدة</th>
                          <td mat-cell *matCellDef="let item">
                            <div [formGroup]="item">
                              <mat-form-field appearance="outline">
                                <input
                                  matInput
                                  type="number"
                                  formControlName="unitPrice"
                                  min="0"
                                  step="0.01"
                                />
                                <span matSuffix>ريال</span>
                              </mat-form-field>
                            </div>
                          </td>
                        </ng-container>

                        <!-- Total Price Column -->
                        <ng-container matColumnDef="totalPrice">
                          <th mat-header-cell *matHeaderCellDef>الإجمالي</th>
                          <td mat-cell *matCellDef="let item">
                            <div [formGroup]="item" class="total-price">
                              {{
                                formatCurrency(
                                  item.get("totalPrice")?.value || 0
                                )
                              }}
                            </div>
                          </td>
                        </ng-container>

                        <!-- Actions Column -->
                        <ng-container matColumnDef="actions">
                          <th mat-header-cell *matHeaderCellDef>الإجراءات</th>
                          <td mat-cell *matCellDef="let item; let i = index">
                            <button
                              mat-icon-button
                              color="warn"
                              (click)="removeItem(i)"
                            >
                              <mat-icon>delete</mat-icon>
                            </button>
                          </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="itemsColumns"></tr>
                        <tr
                          mat-row
                          *matRowDef="let row; columns: itemsColumns"
                        ></tr>
                      </table>
                    </div>
                    }

                    <!-- Empty State -->
                    @if (invoiceItemsArray.length === 0) {
                    <div class="empty-items-state">
                      <mat-icon class="empty-icon">shopping_cart</mat-icon>
                      <h4>لا توجد بنود في الفاتورة</h4>
                      <p>
                        أضف بنود للفاتورة باستخدام الخدمات المعرّفة مسبقاً أو
                        بإضافة بند جديد
                      </p>
                      <button
                        mat-raised-button
                        color="primary"
                        (click)="addItem()"
                      >
                        <mat-icon>add</mat-icon>
                        إضافة بند جديد
                      </button>
                    </div>
                    }

                    <div class="step-actions">
                      <button mat-stroked-button (click)="previousStep()">
                        <mat-icon>arrow_back</mat-icon>
                        السابق
                      </button>
                      <button
                        mat-raised-button
                        color="primary"
                        [disabled]="invoiceItemsArray.length === 0"
                        (click)="nextStep()"
                      >
                        التالي
                        <mat-icon>arrow_forward</mat-icon>
                      </button>
                    </div>
                  </div>
                </ng-template>
              </mat-step>

              <!-- Step 3: Calculations & Review -->
              <mat-step label="المراجعة والحفظ">
                <ng-template matStepContent>
                  <div class="step-content">
                    <h3>مراجعة الفاتورة</h3>

                    <!-- Calculations -->
                    <mat-card class="calculations-card">
                      <mat-card-header>
                        <mat-card-title>الحسابات</mat-card-title>
                      </mat-card-header>
                      <mat-card-content>
                        <div class="calculations-grid">
                          <!-- Tax Settings -->
                          <div class="calculation-section">
                            <h4>الضريبة</h4>
                            <mat-form-field appearance="outline">
                              <mat-label>نسبة الضريبة (%)</mat-label>
                              <input
                                matInput
                                type="number"
                                formControlName="taxPercentage"
                                min="0"
                                max="100"
                                step="0.01"
                              />
                              <span matSuffix>%</span>
                            </mat-form-field>
                          </div>

                          <!-- Discount Settings -->
                          <div class="calculation-section">
                            <h4>الخصم</h4>
                            <mat-form-field appearance="outline">
                              <mat-label>نسبة الخصم (%)</mat-label>
                              <input
                                matInput
                                type="number"
                                formControlName="discountPercentage"
                                min="0"
                                max="100"
                                step="0.01"
                              />
                              <span matSuffix>%</span>
                            </mat-form-field>
                            <div class="or-divider">أو</div>
                            <mat-form-field appearance="outline">
                              <mat-label>مبلغ الخصم</mat-label>
                              <input
                                matInput
                                type="number"
                                formControlName="discountAmount"
                                min="0"
                                step="0.01"
                              />
                              <span matSuffix>ريال</span>
                            </mat-form-field>
                          </div>
                        </div>

                        <!-- Summary -->
                        <div class="invoice-summary">
                          <div class="summary-row">
                            <span>المجموع الفرعي:</span>
                            <span class="amount">{{
                              formatCurrency(subtotal())
                            }}</span>
                          </div>
                          @if (discountAmount() > 0) {
                          <div class="summary-row discount">
                            <span>الخصم:</span>
                            <span class="amount"
                              >-{{ formatCurrency(discountAmount()) }}</span
                            >
                          </div>
                          }
                          <div class="summary-row">
                            <span
                              >الضريبة ({{
                                invoiceForm.get("taxPercentage")?.value || 15
                              }}%):</span
                            >
                            <span class="amount">{{
                              formatCurrency(taxAmount())
                            }}</span>
                          </div>
                          <mat-divider></mat-divider>
                          <div class="summary-row total">
                            <span>الإجمالي النهائي:</span>
                            <span class="amount">{{
                              formatCurrency(totalAmount())
                            }}</span>
                          </div>
                        </div>
                      </mat-card-content>
                    </mat-card>

                    <!-- Notes -->
                    <mat-card class="notes-card">
                      <mat-card-header>
                        <mat-card-title>ملاحظات إضافية</mat-card-title>
                      </mat-card-header>
                      <mat-card-content>
                        <div class="form-row">
                          <mat-form-field
                            appearance="outline"
                            class="full-width"
                          >
                            <mat-label>ملاحظات للعميل</mat-label>
                            <textarea
                              matInput
                              formControlName="notes"
                              rows="3"
                              placeholder="ملاحظات ستظهر في الفاتورة للعميل"
                            ></textarea>
                          </mat-form-field>
                        </div>

                        <div class="form-row">
                          <mat-form-field
                            appearance="outline"
                            class="full-width"
                          >
                            <mat-label>شروط الدفع</mat-label>
                            <textarea
                              matInput
                              formControlName="terms"
                              rows="3"
                            ></textarea>
                          </mat-form-field>
                        </div>

                        <div class="form-row">
                          <mat-form-field
                            appearance="outline"
                            class="full-width"
                          >
                            <mat-label>ملاحظات داخلية</mat-label>
                            <textarea
                              matInput
                              formControlName="internalNotes"
                              rows="2"
                              placeholder="ملاحظات داخلية لا تظهر للعميل"
                            ></textarea>
                          </mat-form-field>
                        </div>
                      </mat-card-content>
                    </mat-card>

                    <div class="step-actions">
                      <button mat-stroked-button (click)="previousStep()">
                        <mat-icon>arrow_back</mat-icon>
                        السابق
                      </button>
                      <button
                        mat-raised-button
                        color="primary"
                        type="submit"
                        [disabled]="invoiceForm.invalid || loading()"
                      >
                        @if (loading()) {
                        <mat-spinner diameter="20"></mat-spinner>
                        } @else {
                        <mat-icon>save</mat-icon>
                        } @if (isEditMode()) { تحديث الفاتورة } @else { حفظ
                        الفاتورة }
                      </button>
                    </div>
                  </div>
                </ng-template>
              </mat-step>
            </mat-stepper>
          </mat-card-content>
        </mat-card>
      </form>
      }
    </div>
  </app-sidebar>
</div>
