<!-- ===================================================================
     src/app/features/invoices/components/payment-tracker/payment-tracker.component.html
     =================================================================== -->
<div class="payment-tracker-container">
  <!-- Header -->
  <app-header></app-header>

  <!-- Sidebar -->
  <app-sidebar>
    <!-- Main Content -->
    <div class="main-content">
      <!-- Loading State -->
      @if (loading()) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>جاري تحميل بيانات الفاتورة...</p>
      </div>
      }

      <!-- Payment Tracker Content -->
      @if (!loading() && invoice()) {
      <div class="payment-content">
        <!-- Page Header -->
        <div class="page-header">
          <div class="header-content">
            <div class="title-section">
              <button
                mat-icon-button
                (click)="navigateBack()"
                class="back-button"
              >
                <mat-icon>arrow_back</mat-icon>
              </button>
              <div class="title-info">
                <h1 class="page-title">تتبع المدفوعات</h1>
                <p class="page-subtitle">
                  الفاتورة {{ invoice()?.invoiceNumber }}
                </p>
              </div>
            </div>

            <div class="header-actions">
              <button
                mat-raised-button
                color="primary"
                (click)="toggleAddPayment()"
                [disabled]="invoice()?.remainingAmount === 0"
              >
                <mat-icon>{{ showAddPayment() ? "close" : "add" }}</mat-icon>
                @if (showAddPayment()) { إلغاء } @else { إضافة دفعة }
              </button>
            </div>
          </div>
        </div>

        <!-- Invoice Summary -->
        <div class="invoice-summary">
          <mat-card class="summary-card">
            <mat-card-header>
              <mat-card-title>ملخص الفاتورة</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="summary-grid">
                <div class="summary-item">
                  <div class="label">المريض:</div>
                  <div class="value">{{ invoice()?.patientName }}</div>
                </div>
                <div class="summary-item">
                  <div class="label">تاريخ الإصدار:</div>
                  <div class="value">
                    {{ formatDate(invoice()?.issueDate!) }}
                  </div>
                </div>
                <div class="summary-item">
                  <div class="label">تاريخ الاستحقاق:</div>
                  <div class="value">{{ formatDate(invoice()?.dueDate!) }}</div>
                </div>
                <div class="summary-item">
                  <div class="label">إجمالي المبلغ:</div>
                  <div class="value amount">
                    {{ formatCurrency(invoice()?.totalAmount!) }}
                  </div>
                </div>
              </div>

              <!-- Payment Progress -->
              <div class="payment-progress">
                <div class="progress-header">
                  <span class="progress-label">حالة السداد</span>
                  <span class="progress-percentage"
                    >{{ calculatePaymentProgress().toFixed(1) }}%</span
                  >
                </div>
                <mat-progress-bar
                  [value]="calculatePaymentProgress()"
                  [color]="getPaymentProgressColor()"
                  mode="determinate"
                >
                </mat-progress-bar>
                <div class="progress-details">
                  <div class="progress-item">
                    <span class="label">مدفوع:</span>
                    <span class="value paid">{{
                      formatCurrency(invoice()?.paidAmount || 0)
                    }}</span>
                  </div>
                  <div class="progress-item">
                    <span class="label">متبقي:</span>
                    <span class="value remaining">{{
                      formatCurrency(invoice()?.remainingAmount || 0)
                    }}</span>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Add Payment Form -->
        @if (showAddPayment()) {
        <mat-card class="payment-form-card">
          <mat-card-header>
            <mat-card-title>إضافة دفعة جديدة</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form [formGroup]="paymentForm" (ngSubmit)="addPayment()">
              <!-- Payment Amount -->
              <div class="form-section">
                <h4>مبلغ الدفعة</h4>
                <div class="form-row">
                  <mat-form-field appearance="outline" class="amount-field">
                    <mat-label>المبلغ</mat-label>
                    <input
                      matInput
                      type="number"
                      formControlName="amount"
                      min="0.01"
                      step="0.01"
                      required
                    />
                    <span matSuffix>ريال</span>
                    @if (paymentForm.get('amount')?.hasError('required') &&
                    paymentForm.get('amount')?.touched) {
                    <mat-error>يرجى إدخال المبلغ</mat-error>
                    } @if (paymentForm.get('amount')?.hasError('min') &&
                    paymentForm.get('amount')?.touched) {
                    <mat-error>يجب أن يكون المبلغ أكبر من صفر</mat-error>
                    }
                  </mat-form-field>

                  <div class="quick-amount-buttons">
                    <button
                      mat-stroked-button
                      type="button"
                      (click)="setPaymentAmount(25)"
                    >
                      25%
                    </button>
                    <button
                      mat-stroked-button
                      type="button"
                      (click)="setPaymentAmount(50)"
                    >
                      50%
                    </button>
                    <button
                      mat-stroked-button
                      type="button"
                      (click)="setPaymentAmount(75)"
                    >
                      75%
                    </button>
                    <button
                      mat-raised-button
                      type="button"
                      color="accent"
                      (click)="setFullPayment()"
                    >
                      كامل
                    </button>
                  </div>
                </div>
              </div>

              <!-- Payment Method -->
              <div class="form-section">
                <h4>طريقة الدفع</h4>
                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>طريقة الدفع</mat-label>
                    <mat-select formControlName="paymentMethod" required>
                      @for (method of paymentMethods; track method.value) {
                      <mat-option [value]="method.value">
                        <div class="payment-method-option">
                          <mat-icon>{{ method.icon }}</mat-icon>
                          <span>{{ method.label }}</span>
                        </div>
                      </mat-option>
                      }
                    </mat-select>
                    @if (paymentForm.get('paymentMethod')?.hasError('required')
                    && paymentForm.get('paymentMethod')?.touched) {
                    <mat-error>يرجى اختيار طريقة الدفع</mat-error>
                    }
                  </mat-form-field>
                </div>

                <!-- Method-specific fields -->
                <div class="method-specific-fields">
                  <!-- Credit/Debit Card Fields -->
                  @if (paymentForm.get('paymentMethod')?.value ===
                  PaymentMethod.CREDIT_CARD ||
                  paymentForm.get('paymentMethod')?.value ===
                  PaymentMethod.DEBIT_CARD) {
                  <div class="form-row">
                    <mat-form-field appearance="outline">
                      <mat-label>آخر 4 أرقام من البطاقة</mat-label>
                      <input
                        matInput
                        formControlName="cardLastFourDigits"
                        placeholder="1234"
                        maxlength="4"
                        required
                      />
                      @if
                      (paymentForm.get('cardLastFourDigits')?.hasError('required')
                      && paymentForm.get('cardLastFourDigits')?.touched) {
                      <mat-error>يرجى إدخال آخر 4 أرقام</mat-error>
                      } @if
                      (paymentForm.get('cardLastFourDigits')?.hasError('pattern')
                      && paymentForm.get('cardLastFourDigits')?.touched) {
                      <mat-error>يجب أن يكون 4 أرقام فقط</mat-error>
                      }
                    </mat-form-field>
                  </div>
                  }

                  <!-- Check Fields -->
                  @if (paymentForm.get('paymentMethod')?.value ===
                  PaymentMethod.CHECK) {
                  <div class="form-row">
                    <mat-form-field appearance="outline">
                      <mat-label>رقم الشيك</mat-label>
                      <input matInput formControlName="checkNumber" required />
                      @if (paymentForm.get('checkNumber')?.hasError('required')
                      && paymentForm.get('checkNumber')?.touched) {
                      <mat-error>يرجى إدخال رقم الشيك</mat-error>
                      }
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>اسم البنك</mat-label>
                      <input matInput formControlName="bankName" required />
                      @if (paymentForm.get('bankName')?.hasError('required') &&
                      paymentForm.get('bankName')?.touched) {
                      <mat-error>يرجى إدخال اسم البنك</mat-error>
                      }
                    </mat-form-field>
                  </div>
                  }

                  <!-- Bank Transfer Fields -->
                  @if (paymentForm.get('paymentMethod')?.value ===
                  PaymentMethod.BANK_TRANSFER) {
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>رقم المعاملة</mat-label>
                      <input
                        matInput
                        formControlName="transactionId"
                        required
                      />
                      @if
                      (paymentForm.get('transactionId')?.hasError('required') &&
                      paymentForm.get('transactionId')?.touched) {
                      <mat-error>يرجى إدخال رقم المعاملة</mat-error>
                      }
                    </mat-form-field>
                  </div>
                  }
                </div>
              </div>

              <!-- Additional Information -->
              <div class="form-section">
                <h4>معلومات إضافية</h4>
                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>تاريخ الدفع</mat-label>
                    <input
                      matInput
                      [matDatepicker]="paymentDatePicker"
                      formControlName="paymentDate"
                      required
                    />
                    <mat-datepicker-toggle
                      matSuffix
                      [for]="paymentDatePicker"
                    ></mat-datepicker-toggle>
                    <mat-datepicker #paymentDatePicker></mat-datepicker>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>رقم المرجع (اختياري)</mat-label>
                    <input
                      matInput
                      formControlName="referenceNumber"
                      placeholder="رقم الإيصال أو المرجع"
                    />
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>ملاحظات (اختياري)</mat-label>
                    <textarea
                      matInput
                      formControlName="notes"
                      rows="3"
                      placeholder="ملاحظات حول الدفعة"
                    ></textarea>
                  </mat-form-field>
                </div>
              </div>

              <!-- Form Actions -->
              <div class="form-actions">
                <button
                  mat-stroked-button
                  type="button"
                  (click)="toggleAddPayment()"
                >
                  <mat-icon>cancel</mat-icon>
                  إلغاء
                </button>
                <button
                  mat-raised-button
                  color="primary"
                  type="submit"
                  [disabled]="
                    paymentForm.invalid ||
                    submitting() ||
                    !isPaymentMethodValid()
                  "
                >
                  @if (submitting()) {
                  <mat-spinner diameter="20"></mat-spinner>
                  } @else {
                  <mat-icon>save</mat-icon>
                  } حفظ الدفعة
                </button>
              </div>
            </form>
          </mat-card-content>
        </mat-card>
        }

        <!-- Payment History -->
        <mat-card class="payment-history-card">
          <mat-card-header>
            <div class="card-header-content">
              <mat-card-title>سجل المدفوعات</mat-card-title>
              @if (invoice()?.payments && invoice()?.payments!.length > 0) {
              <div class="payment-count">
                {{ (invoice()?.payments)!.length }} دفعة
              </div>
              }
            </div>
          </mat-card-header>
          <mat-card-content>
            @if (invoice()?.payments && invoice()?.payments!.length > 0) {
            <div class="table-container">
              <table
                mat-table
                [dataSource]="invoice()?.payments || []"
                class="payments-table"
              >
                <!-- Payment Date Column -->
                <ng-container matColumnDef="paymentDate">
                  <th mat-header-cell *matHeaderCellDef>تاريخ الدفع</th>
                  <td mat-cell *matCellDef="let payment">
                    {{ formatDate(payment.paymentDate) }}
                  </td>
                </ng-container>

                <!-- Amount Column -->
                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef>المبلغ</th>
                  <td mat-cell *matCellDef="let payment" class="amount-cell">
                    {{ formatCurrency(payment.amount) }}
                  </td>
                </ng-container>

                <!-- Payment Method Column -->
                <ng-container matColumnDef="paymentMethod">
                  <th mat-header-cell *matHeaderCellDef>طريقة الدفع</th>
                  <td mat-cell *matCellDef="let payment">
                    <div class="payment-method">
                      <mat-icon>{{
                        getPaymentMethodConfig(payment.paymentMethod).icon
                      }}</mat-icon>
                      <span>{{
                        getPaymentMethodConfig(payment.paymentMethod).label
                      }}</span>
                    </div>
                  </td>
                </ng-container>

                <!-- Reference Number Column -->
                <ng-container matColumnDef="referenceNumber">
                  <th mat-header-cell *matHeaderCellDef>رقم المرجع</th>
                  <td mat-cell *matCellDef="let payment">
                    {{ payment.referenceNumber || "-" }}
                  </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>الحالة</th>
                  <td mat-cell *matCellDef="let payment">
                    <mat-chip-set>
                      <mat-chip
                        [color]="getPaymentStatusConfig(payment.status).color"
                        selected
                      >
                        <mat-icon>{{
                          getPaymentStatusConfig(payment.status).icon
                        }}</mat-icon>
                        {{ getPaymentStatusConfig(payment.status).text }}
                      </mat-chip>
                    </mat-chip-set>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>الإجراءات</th>
                  <td mat-cell *matCellDef="let payment">
                    <button mat-icon-button [matMenuTriggerFor]="paymentMenu">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #paymentMenu="matMenu">
                      <button
                        mat-menu-item
                        (click)="viewPaymentDetails(payment)"
                      >
                        <mat-icon>visibility</mat-icon>
                        <span>عرض التفاصيل</span>
                      </button>
                      <button
                        mat-menu-item
                        (click)="generatePaymentReceipt(payment)"
                      >
                        <mat-icon>receipt</mat-icon>
                        <span>إيصال الدفع</span>
                      </button>
                      @if (payment.status === PaymentStatus.COMPLETED &&
                      hasPermission(['ADMIN', 'SYSTEM_ADMIN'])) {
                      <mat-divider></mat-divider>
                      <button
                        mat-menu-item
                        (click)="refundPayment(payment)"
                        class="refund-action"
                      >
                        <mat-icon>undo</mat-icon>
                        <span>استرداد</span>
                      </button>
                      }
                    </mat-menu>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="paymentsColumns"></tr>
                <tr
                  mat-row
                  *matRowDef="let row; columns: paymentsColumns"
                  [class.selected]="selectedPayment() === row"
                  (click)="viewPaymentDetails(row)"
                ></tr>
              </table>
            </div>

            <!-- Payment Summary -->
            <div class="payment-summary">
              <mat-divider></mat-divider>
              <div class="summary-totals">
                <div class="total-item">
                  <span class="label">إجمالي المدفوعات:</span>
                  <span class="value"
                    >{{ invoice()?.payments?.length || 0 }} دفعة</span
                  >
                </div>
                <div class="total-item">
                  <span class="label">إجمالي المبلغ المدفوع:</span>
                  <span class="value amount">{{
                    formatCurrency(invoice()?.paidAmount || 0)
                  }}</span>
                </div>
                <div class="total-item remaining">
                  <span class="label">المبلغ المتبقي:</span>
                  <span class="value amount">{{
                    formatCurrency(invoice()?.remainingAmount || 0)
                  }}</span>
                </div>
              </div>
            </div>
            } @else {
            <div class="empty-payments-state">
              <mat-icon class="empty-icon">payment</mat-icon>
              <h4>لا توجد مدفوعات</h4>
              <p>لم يتم تسجيل أي مدفوعات لهذه الفاتورة بعد</p>
              <button
                mat-raised-button
                color="primary"
                (click)="toggleAddPayment()"
                [disabled]="invoice()?.remainingAmount === 0"
              >
                <mat-icon>add</mat-icon>
                إضافة أول دفعة
              </button>
            </div>
            }
          </mat-card-content>
        </mat-card>

        <!-- Payment Details Panel -->
        @if (selectedPayment()) {
        <mat-card class="payment-details-card">
          <mat-card-header>
            <mat-card-title>تفاصيل الدفعة</mat-card-title>
            <button mat-icon-button (click)="selectedPayment.set(null)">
              <mat-icon>close</mat-icon>
            </button>
          </mat-card-header>
          <mat-card-content>
            <div class="payment-details">
              <div class="detail-section">
                <h4>معلومات أساسية</h4>
                <div class="detail-grid">
                  <div class="detail-item">
                    <span class="label">المبلغ:</span>
                    <span class="value">{{
                      formatCurrency(selectedPayment()?.amount!)
                    }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="label">تاريخ الدفع:</span>
                    <span class="value">{{
                      formatDate(selectedPayment()?.paymentDate!)
                    }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="label">طريقة الدفع:</span>
                    <span class="value">{{
                      getPaymentMethodConfig(selectedPayment()?.paymentMethod!)
                        .label
                    }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="label">الحالة:</span>
                    <span class="value">{{
                      getPaymentStatusConfig(selectedPayment()?.status!).text
                    }}</span>
                  </div>
                </div>
              </div>

              @if (selectedPayment()?.referenceNumber ||
              selectedPayment()?.notes) {
              <div class="detail-section">
                <h4>معلومات إضافية</h4>
                <div class="detail-grid">
                  @if (selectedPayment()?.referenceNumber) {
                  <div class="detail-item">
                    <span class="label">رقم المرجع:</span>
                    <span class="value">{{
                      selectedPayment()?.referenceNumber
                    }}</span>
                  </div>
                  } @if (selectedPayment()?.notes) {
                  <div class="detail-item full-width">
                    <span class="label">الملاحظات:</span>
                    <span class="value">{{ selectedPayment()?.notes }}</span>
                  </div>
                  }
                </div>
              </div>
              } @if (selectedPayment()?.processedBy) {
              <div class="detail-section">
                <h4>معلومات المعالجة</h4>
                <div class="detail-grid">
                  <div class="detail-item">
                    <span class="label">معالج بواسطة:</span>
                    <span class="value">{{
                      selectedPayment()?.processedBy
                    }}</span>
                  </div>
                </div>
              </div>
              }
            </div>
          </mat-card-content>
        </mat-card>
        }
      </div>
      }

      <!-- Error State -->
      @if (!loading() && !invoice()) {
      <div class="error-state">
        <mat-icon class="error-icon">error</mat-icon>
        <h3>لم يتم العثور على الفاتورة</h3>
        <p>الفاتورة المطلوبة غير موجودة أو تم حذفها.</p>
        <button mat-raised-button color="primary" (click)="navigateBack()">
          <mat-icon>arrow_back</mat-icon>
          العودة للقائمة
        </button>
      </div>
      }
    </div>
  </app-sidebar>
</div>
