<!-- ===================================================================
     src/app/features/reports/components/trends-analysis/trends-analysis.component.html
     =================================================================== -->
<app-header></app-header>

<app-sidebar>
  <div class="trends-analysis-container">
    <!-- Page Header -->
    <div class="page-header">
      <h1>
        <mat-icon>trending_up</mat-icon>
        تحليل الاتجاهات
      </h1>
      <div class="header-actions">
        <button
          mat-stroked-button
          (click)="refreshData()"
          [disabled]="loading()"
        >
          <mat-icon>refresh</mat-icon>
          تحديث البيانات
        </button>
        <button mat-button [matMenuTriggerFor]="exportMenu">
          <mat-icon>file_download</mat-icon>
          تصدير التقرير
          <mat-icon>arrow_drop_down</mat-icon>
        </button>
        <mat-menu #exportMenu="matMenu">
          <button mat-menu-item (click)="exportTrendsReport(exportFormat.PDF)">
            <mat-icon>picture_as_pdf</mat-icon>
            تصدير PDF
          </button>
          <button
            mat-menu-item
            (click)="exportTrendsReport(exportFormat.EXCEL)"
          >
            <mat-icon>table_chart</mat-icon>
            تصدير Excel
          </button>
        </mat-menu>
      </div>
    </div>

    <!-- Filters Section -->
    <mat-card class="filters-card">
      <mat-card-header>
        <mat-card-title class="filters-title">
          <mat-icon>filter_list</mat-icon>
          خيارات التحليل
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="filtersForm" class="filters-form">
          <mat-form-field appearance="outline">
            <mat-label>الفترة الزمنية</mat-label>
            <mat-select formControlName="period">
              @for (option of periodOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>فئة المقاييس</mat-label>
            <mat-select formControlName="category">
              @for (category of metricCategories; track category.value) {
              <mat-option [value]="category.value">{{
                category.label
              }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>العيادة</mat-label>
            <mat-select formControlName="clinicId">
              <mat-option [value]="null">جميع العيادات</mat-option>
              <!-- Add clinic options dynamically -->
            </mat-select>
          </mat-form-field>

          <!-- Advanced Filters -->
          <mat-expansion-panel class="advanced-filters">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>tune</mat-icon>
                خيارات متقدمة
              </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="expansion-content">
              @if (filtersForm.get('period')?.value === 'custom') {
              <mat-form-field appearance="outline">
                <mat-label>من تاريخ</mat-label>
                <input
                  matInput
                  [matDatepicker]="startPicker"
                  formControlName="customStartDate"
                />
                <mat-datepicker-toggle
                  matIconSuffix
                  [for]="startPicker"
                ></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>إلى تاريخ</mat-label>
                <input
                  matInput
                  [matDatepicker]="endPicker"
                  formControlName="customEndDate"
                />
                <mat-datepicker-toggle
                  matIconSuffix
                  [for]="endPicker"
                ></mat-datepicker-toggle>
                <mat-datepicker #endPicker></mat-datepicker>
              </mat-form-field>
              }

              <div class="filter-options">
                <mat-slide-toggle formControlName="includeWeekends">
                  تضمين عطل نهاية الأسبوع
                </mat-slide-toggle>

                <mat-slide-toggle formControlName="smoothing">
                  تطبيق التنعيم على البيانات
                </mat-slide-toggle>
              </div>
            </div>
          </mat-expansion-panel>

          <div class="filter-actions">
            <button
              mat-raised-button
              color="primary"
              (click)="onFiltersChange()"
            >
              تطبيق الفلاتر
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Loading State -->
    @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>جاري تحليل البيانات...</p>
    </div>
    } @if (!loading()) {
    <!-- Trends Overview -->
    <div class="trends-overview">
      <h2 class="section-title">
        <mat-icon>insights</mat-icon>
        نظرة عامة على الاتجاهات
      </h2>
    </div>

    <div class="trends-grid">
      @for (metric of trendMetrics(); track metric.id) {
      <mat-card class="trend-card" [ngClass]="metric.category">
        <mat-card-content>
          <div class="trend-header">
            <div class="trend-info">
              <div class="trend-icon">
                <mat-icon>{{ getChangeIcon(metric.changeType) }}</mat-icon>
              </div>
              <div class="trend-details">
                <h3 class="trend-title">{{ metric.title }}</h3>
                <div class="trend-value">
                  {{ metric.value | number : "1.0-2" }} {{ metric.unit }}
                </div>
              </div>
            </div>
            <div class="trend-change">
              <div
                class="change-percentage"
                [ngClass]="getChangeClass(metric.changeType)"
              >
                <mat-icon>{{ getChangeIcon(metric.changeType) }}</mat-icon>
                {{ metric.change | number : "1.1-1" }}%
              </div>
              <p class="change-period">{{ metric.period }}</p>
            </div>
          </div>

          <div class="trend-chart">
            <div class="mini-chart">
              <svg width="100%" height="60" viewBox="0 0 300 60">
                <!-- Simple line chart visualization -->
                @if (metric.chartData.length > 0) {
                <path
                  class="trend-line"
                  [ngClass]="metric.changeType"
                  [attr.d]="generateTrendPath(metric.chartData)"
                  fill="none"
                  stroke-width="2"
                ></path>
                <path
                  class="trend-area"
                  [ngClass]="metric.changeType"
                  [attr.d]="generateTrendArea(metric.chartData)"
                ></path>
                }
              </svg>
            </div>
          </div>

          <div class="trend-footer">
            <div class="period-info">
              <mat-icon>schedule</mat-icon>
              {{ metric.period }}
            </div>
            <div
              class="trend-status"
              [ngClass]="
                metric.changeType === 'positive'
                  ? 'improving'
                  : metric.changeType === 'negative'
                  ? 'declining'
                  : 'stable'
              "
            >
              {{
                metric.changeType === "positive"
                  ? "في تحسن"
                  : metric.changeType === "negative"
                  ? "في تراجع"
                  : "مستقر"
              }}
            </div>
          </div>
        </mat-card-content>
      </mat-card>
      }
    </div>

    <!-- Analysis Tabs -->
    <mat-card class="analysis-tabs-card">
      <mat-tab-group
        [(selectedIndex)]="selectedTab"
        (selectedTabChange)="onTabChange($event.index)"
      >
        <!-- Comparative Analysis Tab -->
        <mat-tab label="التحليل المقارن">
          <div class="tab-content">
            <div class="comparative-section">
              <div class="comparison-controls">
                <div class="control-group">
                  <label>الفترة الأولى</label>
                  <mat-form-field appearance="outline">
                    <mat-select
                      [value]="comparisonPeriod1()"
                      (selectionChange)="
                        onComparisonPeriodChange(
                          $event.value,
                          comparisonPeriod2()
                        )
                      "
                    >
                      @for (option of periodOptions; track option.value) {
                      <mat-option [value]="option.value">{{
                        option.label
                      }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="vs-indicator">مقابل</div>

                <div class="control-group">
                  <label>الفترة الثانية</label>
                  <mat-form-field appearance="outline">
                    <mat-select
                      [value]="comparisonPeriod2()"
                      (selectionChange)="
                        onComparisonPeriodChange(
                          comparisonPeriod1(),
                          $event.value
                        )
                      "
                    >
                      @for (option of periodOptions; track option.value) {
                      <mat-option [value]="option.value">{{
                        option.label
                      }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>

              <div class="comparison-chart">
                <h3 class="chart-title">مقارنة الأداء بين الفترتين</h3>
                <app-chart-widget
                  [chartType]="'bar'"
                  [data]="[]"
                  [title]="'مقارنة الإيرادات'"
                  [height]="400"
                >
                </app-chart-widget>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Seasonal Analysis Tab -->
        <mat-tab label="التحليل الموسمي">
          <div class="tab-content">
            <div class="seasonal-section">
              <div class="patterns-grid">
                @for (pattern of seasonalPatterns(); track pattern.season) {
                <div class="pattern-card">
                  <div class="pattern-icon" [ngClass]="pattern.season">
                    <mat-icon>{{ getSeasonIcon(pattern.season) }}</mat-icon>
                  </div>
                  <h3 class="pattern-title">{{ pattern.title }}</h3>
                  <p class="pattern-description">{{ pattern.description }}</p>

                  <div class="pattern-metrics">
                    <div class="metric">
                      <div class="metric-value">
                        {{
                          pattern.averageRevenue
                            | currency : "SAR" : "symbol" : "1.0-0"
                        }}
                      </div>
                      <div class="metric-label">متوسط الإيرادات</div>
                    </div>
                    <div class="metric">
                      <div class="metric-value">
                        {{ pattern.averageAppointments }}
                      </div>
                      <div class="metric-label">متوسط المواعيد</div>
                    </div>
                    <div class="metric">
                      <div class="metric-value">
                        {{ pattern.patientFlow | number : "1.1-1" }}x
                      </div>
                      <div class="metric-label">تدفق المرضى</div>
                    </div>
                    <div class="metric">
                      <div class="metric-value">
                        {{ pattern.peakMonths.length }}
                      </div>
                      <div class="metric-label">أشهر الذروة</div>
                    </div>
                  </div>
                </div>
                }
              </div>

              <div class="seasonal-chart">
                <div class="chart-header">
                  <h3 class="chart-title">الأنماط الموسمية للإيرادات</h3>
                  <div class="chart-legend">
                    <div class="legend-item">
                      <div
                        class="legend-color"
                        style="background: #4caf50"
                      ></div>
                      <span>الإيرادات</span>
                    </div>
                    <div class="legend-item">
                      <div
                        class="legend-color"
                        style="background: #2196f3"
                      ></div>
                      <span>المواعيد</span>
                    </div>
                  </div>
                </div>
                <app-chart-widget
                  [chartType]="'line'"
                  [data]="[]"
                  [title]="'التحليل الموسمي'"
                  [height]="350"
                >
                </app-chart-widget>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Predictive Analysis Tab -->
        <mat-tab label="التحليل التنبؤي">
          <div class="tab-content">
            <div class="predictive-section">
              <div class="predictions-header">
                <h3 class="header-title">
                  <mat-icon>psychology</mat-icon>
                  التوقعات المستقبلية
                </h3>
                <div class="confidence-indicator">
                  <mat-icon>verified</mat-icon>
                  <span
                    >مستوى الثقة:
                    <span class="confidence-level">85%</span></span
                  >
                </div>
              </div>

              <div class="predictions-grid">
                @for (insight of predictiveInsights(); track insight.id) {
                <div
                  class="prediction-card"
                  [ngClass]="insight.type + '-trend'"
                >
                  <div class="prediction-header">
                    <h4 class="prediction-title">{{ insight.title }}</h4>
                    <div class="prediction-confidence">
                      الثقة: {{ insight.confidence }}%
                    </div>
                  </div>

                  <div class="prediction-content">
                    <div class="current-value">
                      القيمة الحالية: {{ insight.currentValue | number }}
                    </div>
                    <div
                      class="predicted-value"
                      [ngClass]="
                        insight.predictedValue > insight.currentValue
                          ? 'increase'
                          : insight.predictedValue < insight.currentValue
                          ? 'decrease'
                          : 'stable'
                      "
                    >
                      <mat-icon>
                        {{
                          insight.predictedValue > insight.currentValue
                            ? "trending_up"
                            : insight.predictedValue < insight.currentValue
                            ? "trending_down"
                            : "trending_flat"
                        }}
                      </mat-icon>
                      التوقع: {{ insight.predictedValue | number }}
                    </div>
                    <p class="prediction-timeframe">{{ insight.timeframe }}</p>

                    <div class="prediction-factors">
                      <h5 class="factors-title">العوامل المؤثرة:</h5>
                      <ul class="factors-list">
                        @for (factor of insight.factors; track factor) {
                        <li>{{ factor }}</li>
                        }
                      </ul>
                    </div>
                  </div>
                </div>
                }
              </div>

              <div class="prediction-chart">
                <div class="chart-disclaimer">
                  <mat-icon>warning</mat-icon>
                  <p class="disclaimer-text">
                    التوقعات مبنية على البيانات التاريخية والاتجاهات الحالية.
                    النتائج الفعلية قد تختلف.
                  </p>
                </div>
                <app-chart-widget
                  [chartType]="'line'"
                  [data]="[]"
                  [title]="'التوقعات المستقبلية'"
                  [height]="400"
                >
                </app-chart-widget>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card>

    <!-- Business Insights Section -->
    <div class="insights-section">
      <div class="insights-header">
        <mat-icon>lightbulb</mat-icon>
        <h3 class="header-title">رؤى الأعمال</h3>
      </div>

      <div class="insights-list">
        @for (insight of businessInsights(); track insight.id) {
        <div class="insight-item" [ngClass]="insight.type">
          <mat-icon class="insight-icon">{{
            getInsightIcon(insight.type)
          }}</mat-icon>
          <div class="insight-content">
            <h4 class="insight-title">{{ insight.title }}</h4>
            <p class="insight-description">{{ insight.description }}</p>

            @if (insight.recommendation) {
            <div class="insight-recommendation">
              <strong>التوصية:</strong> {{ insight.recommendation }}
            </div>
            } @if (insight.actionItems.length > 0) {
            <div class="insight-actions">
              @for (action of insight.actionItems; track action) {
              <span class="action-chip">{{ action }}</span>
              }
            </div>
            }
          </div>
        </div>
        }
      </div>
    </div>
    }
  </div>
</app-sidebar>
