<app-header></app-header>

<app-sidebar>
  <div class="doctor-performance-container">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <div class="title-section">
          <h1 class="page-title">
            <mat-icon>medical_services</mat-icon>
            تقارير أداء الأطباء
          </h1>
          <p class="page-subtitle">تحليل مفصل لأداء وإنتاجية الفريق الطبي</p>
        </div>

        <div class="header-actions">
          <button
            mat-raised-button
            color="primary"
            [matMenuTriggerFor]="exportMenu"
          >
            <mat-icon>download</mat-icon>
            تصدير التقرير
          </button>

          <mat-menu #exportMenu="matMenu">
            <button mat-menu-item (click)="onExportReport(exportFormat.PDF)">
              <mat-icon>picture_as_pdf</mat-icon>
              تصدير PDF
            </button>
            <button mat-menu-item (click)="onExportReport(exportFormat.EXCEL)">
              <mat-icon>table_chart</mat-icon>
              تصدير Excel
            </button>
          </mat-menu>

          <button mat-stroked-button (click)="onRefreshData()">
            <mat-icon>refresh</mat-icon>
            تحديث
          </button>
        </div>
      </div>
    </div>

    <!-- Filters Section -->
    <mat-card class="filters-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>filter_alt</mat-icon>
          فلاتر التقرير
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="filterForm" class="filters-form">
          <div class="filter-row">
            <mat-form-field appearance="outline">
              <mat-label>من تاريخ</mat-label>
              <input
                matInput
                [matDatepicker]="startPicker"
                formControlName="startDate"
              />
              <mat-datepicker-toggle
                matIconSuffix
                [for]="startPicker"
              ></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>إلى تاريخ</mat-label>
              <input
                matInput
                [matDatepicker]="endPicker"
                formControlName="endDate"
              />
              <mat-datepicker-toggle
                matIconSuffix
                [for]="endPicker"
              ></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>الطبيب</mat-label>
              <mat-select formControlName="doctorId">
                <mat-option value="">جميع الأطباء</mat-option>
                <mat-option
                  *ngFor="let doctor of doctorsList"
                  [value]="doctor.id"
                >
                  {{ doctor.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>التخصص</mat-label>
              <mat-select formControlName="specialization">
                <mat-option value="">جميع التخصصات</mat-option>
                <mat-option value="general">طب عام</mat-option>
                <mat-option value="pediatrics">أطفال</mat-option>
                <mat-option value="cardiology">قلب</mat-option>
                <mat-option value="dermatology">جلدية</mat-option>
              </mat-select>
            </mat-form-field>

            <div class="filter-actions">
              <button
                mat-raised-button
                color="primary"
                (click)="onFilterChange()"
                [disabled]="loading()"
              >
                <mat-icon>search</mat-icon>
                تطبيق
              </button>
              <button mat-stroked-button (click)="onResetFilters()">
                <mat-icon>refresh</mat-icon>
                إعادة تعيين
              </button>
            </div>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Loading State -->
    <div *ngIf="loading()" class="loading-container">
      <mat-progress-spinner
        mode="indeterminate"
        diameter="50"
      ></mat-progress-spinner>
      <p>جاري تحميل بيانات الأداء...</p>
    </div>

    <!-- Performance Overview -->
    <div
      *ngIf="!loading() && doctorPerformance().length > 0"
      class="performance-content"
    >
      <!-- Overall KPIs -->
      <div class="kpi-section">
        <h2 class="section-title">
          <mat-icon>analytics</mat-icon>
          مؤشرات الأداء الرئيسية
        </h2>

        <div class="kpi-grid">
          <mat-card
            *ngFor="let kpi of overallKPIs()"
            class="kpi-card"
            [class]="'kpi-' + kpi.trend"
          >
            <mat-card-content>
              <div class="kpi-header">
                <span class="kpi-label">{{ kpi.label }}</span>
                <mat-icon class="trend-icon">{{
                  getTrendIcon(kpi.trend)
                }}</mat-icon>
              </div>
              <div class="kpi-value">
                <span class="value">{{
                  formatKPIValue(kpi.value, kpi.unit)
                }}</span>
                <span class="unit">{{ kpi.unit }}</span>
              </div>
              <div class="kpi-change" [class]="'change-' + kpi.trend">
                <mat-icon>{{ getTrendIcon(kpi.trend) }}</mat-icon>
                <span>{{ formatPercentage(kpi.change) }}</span>
              </div>
              <div *ngIf="kpi.target" class="kpi-target">
                <span>الهدف: {{ formatKPIValue(kpi.target, kpi.unit) }}</span>
                <mat-progress-bar
                  mode="determinate"
                  [value]="(kpi.value / kpi.target) * 100"
                  [color]="getProgressColor(kpi.value, kpi.target)"
                >
                </mat-progress-bar>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Performance Charts -->
      <div class="charts-section">
        <div class="charts-grid">
          <!-- Revenue by Doctor -->
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>الإيرادات حسب الطبيب</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <app-chart-widget
                [data]="revenueByDoctorChartData()"
                chartType="bar"
                [height]="350"
                colorScheme="natural"
                [showXAxisLabel]="true"
                [showYAxisLabel]="true"
                xAxisLabel="الطبيب"
                yAxisLabel="الإيرادات (ريال)"
              >
              </app-chart-widget>
            </mat-card-content>
          </mat-card>

          <!-- Efficiency Comparison -->
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>مقارنة الكفاءة</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <app-chart-widget
                [data]="efficiencyChartData()"
                chartType="bar"
                [height]="350"
                colorScheme="cool"
                [showXAxisLabel]="true"
                [showYAxisLabel]="true"
                xAxisLabel="الطبيب"
                yAxisLabel="موعد/ساعة"
              >
              </app-chart-widget>
            </mat-card-content>
          </mat-card>

          <!-- Patient Count -->
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>عدد المرضى المعالجين</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <app-chart-widget
                [data]="patientCountChartData()"
                chartType="pie"
                [height]="350"
                colorScheme="vivid"
                [doughnut]="true"
              >
              </app-chart-widget>
            </mat-card-content>
          </mat-card>

          <!-- Rating Comparison -->
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>مقارنة التقييمات</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <app-chart-widget
                [data]="ratingChartData()"
                chartType="bar"
                [height]="350"
                colorScheme="warm"
                [showXAxisLabel]="true"
                [showYAxisLabel]="true"
                xAxisLabel="الطبيب"
                yAxisLabel="التقييم (من 5)"
              >
              </app-chart-widget>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Detailed Performance Table -->
      <mat-card class="performance-table-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>table_chart</mat-icon>
            تفاصيل أداء الأطباء
          </mat-card-title>
          <mat-card-subtitle>
            معلومات شاملة عن أداء كل طبيب في الفترة المحددة
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <mat-table
            [dataSource]="doctorPerformance()"
            class="performance-table"
            matSort
          >
            <ng-container matColumnDef="doctorInfo">
              <mat-header-cell *matHeaderCellDef
                >معلومات الطبيب</mat-header-cell
              >
              <mat-cell *matCellDef="let doctor">
                <div class="doctor-info">
                  <div class="doctor-avatar">
                    <mat-icon>person</mat-icon>
                  </div>
                  <div class="doctor-details">
                    <span class="doctor-name">{{ doctor.doctorName }}</span>
                    <span class="doctor-specialization">{{
                      doctor.specialization
                    }}</span>
                  </div>
                </div>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="appointments">
              <mat-header-cell *matHeaderCellDef mat-sort-header
                >المواعيد</mat-header-cell
              >
              <mat-cell *matCellDef="let doctor">
                <div class="appointments-cell">
                  <div class="appointments-total">
                    {{ formatNumber(doctor.totalAppointments) }}
                  </div>
                  <div class="appointments-breakdown">
                    <span class="completed"
                      >{{ doctor.completedAppointments }} مكتملة</span
                    >
                    <span class="cancelled"
                      >{{ doctor.cancelledAppointments }} ملغاة</span
                    >
                  </div>
                </div>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="efficiency">
              <mat-header-cell *matHeaderCellDef mat-sort-header
                >الكفاءة</mat-header-cell
              >
              <mat-cell *matCellDef="let doctor">
                <div class="efficiency-cell">
                  <div class="efficiency-value">
                    {{ doctor.efficiency.toFixed(2) }}
                  </div>
                  <div class="efficiency-label">موعد/ساعة</div>
                  <mat-progress-bar
                    mode="determinate"
                    [value]="(doctor.efficiency / getMaxEfficiency()) * 100"
                    [color]="getEfficiencyColor(doctor.efficiency)"
                  >
                  </mat-progress-bar>
                </div>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="rating">
              <mat-header-cell *matHeaderCellDef mat-sort-header
                >التقييم</mat-header-cell
              >
              <mat-cell *matCellDef="let doctor">
                <div class="rating-cell">
                  <div class="rating-value">
                    {{ doctor.averageRating.toFixed(1) }}
                  </div>
                  <div class="stars">
                    <mat-icon
                      *ngFor="let star of getStars(doctor.averageRating)"
                      [class]="star.filled ? 'star-filled' : 'star-empty'"
                    >
                      {{ star.filled ? "star" : "star_border" }}
                    </mat-icon>
                  </div>
                </div>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="revenue">
              <mat-header-cell *matHeaderCellDef mat-sort-header
                >الإيرادات</mat-header-cell
              >
              <mat-cell *matCellDef="let doctor">
                <div class="revenue-cell">
                  <div class="revenue-value">
                    {{ formatCurrency(doctor.totalRevenue) }}
                  </div>
                  <div class="revenue-per-patient">
                    {{
                      formatCurrency(doctor.totalRevenue / doctor.patientsCount)
                    }}
                    لكل مريض
                  </div>
                </div>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="patients">
              <mat-header-cell *matHeaderCellDef mat-sort-header
                >المرضى</mat-header-cell
              >
              <mat-cell *matCellDef="let doctor">
                <div class="patients-cell">
                  <mat-chip color="primary" selected>
                    {{ formatNumber(doctor.patientsCount) }} مريض
                  </mat-chip>
                </div>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="workingHours">
              <mat-header-cell *matHeaderCellDef mat-sort-header
                >ساعات العمل</mat-header-cell
              >
              <mat-cell *matCellDef="let doctor">
                <div class="hours-cell">
                  <div class="hours-value">
                    {{ formatNumber(doctor.workingHours) }}
                  </div>
                  <div class="hours-label">ساعة</div>
                </div>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="actions">
              <mat-header-cell *matHeaderCellDef>الإجراءات</mat-header-cell>
              <mat-cell *matCellDef="let doctor">
                <button
                  mat-icon-button
                  [matMenuTriggerFor]="doctorMenu"
                  matTooltip="الإجراءات"
                >
                  <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #doctorMenu="matMenu">
                  <button
                    mat-menu-item
                    (click)="onViewDoctorDetails(doctor.doctorId)"
                  >
                    <mat-icon>visibility</mat-icon>
                    عرض التفاصيل
                  </button>
                  <button
                    mat-menu-item
                    (click)="onViewDoctorSchedule(doctor.doctorId)"
                  >
                    <mat-icon>schedule</mat-icon>
                    عرض الجدول
                  </button>
                  <button
                    mat-menu-item
                    (click)="onGenerateIndividualReport(doctor.doctorId)"
                  >
                    <mat-icon>description</mat-icon>
                    تقرير فردي
                  </button>
                  <mat-divider></mat-divider>
                  <button
                    mat-menu-item
                    (click)="onCompareDoctors(doctor.doctorId)"
                  >
                    <mat-icon>compare</mat-icon>
                    مقارنة الأداء
                  </button>
                </mat-menu>
              </mat-cell>
            </ng-container>

            <mat-header-row
              *matHeaderRowDef="[
                'doctorInfo',
                'appointments',
                'efficiency',
                'rating',
                'revenue',
                'patients',
                'workingHours',
                'actions'
              ]"
            ></mat-header-row>
            <mat-row
              *matRowDef="
                let row;
                columns: [
                  'doctorInfo',
                  'appointments',
                  'efficiency',
                  'rating',
                  'revenue',
                  'patients',
                  'workingHours',
                  'actions'
                ]
              "
            ></mat-row>
          </mat-table>
        </mat-card-content>
      </mat-card>

      <!-- Performance Insights -->
      <mat-card class="insights-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>lightbulb</mat-icon>
            رؤى وتوصيات
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-expansion-panel class="insight-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon color="primary">trending_up</mat-icon>
                أفضل الأطباء أداءً
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="insight-content">
              <div class="top-performers">
                <div
                  *ngFor="let doctor of getTopPerformers(); let i = index"
                  class="performer-item"
                >
                  <div class="performer-rank">{{ i + 1 }}</div>
                  <div class="performer-info">
                    <span class="performer-name">{{ doctor.doctorName }}</span>
                    <span class="performer-metric"
                      >كفاءة: {{ doctor.efficiency.toFixed(2) }} موعد/ساعة</span
                    >
                  </div>
                  <mat-chip color="primary" selected>{{
                    formatCurrency(doctor.totalRevenue)
                  }}</mat-chip>
                </div>
              </div>
            </div>
          </mat-expansion-panel>

          <mat-expansion-panel class="insight-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon color="accent">warning</mat-icon>
                مناطق تحتاج تحسين
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="insight-content">
              <div class="improvement-areas">
                <div
                  *ngFor="let area of getImprovementAreas()"
                  class="improvement-item"
                >
                  <mat-icon class="improvement-icon">{{ area.icon }}</mat-icon>
                  <div class="improvement-text">
                    <strong>{{ area.title }}</strong>
                    <p>{{ area.description }}</p>
                  </div>
                  <button
                    mat-stroked-button
                    color="accent"
                    (click)="onViewRecommendations(area.type)"
                  >
                    عرض التوصيات
                  </button>
                </div>
              </div>
            </div>
          </mat-expansion-panel>

          <mat-expansion-panel class="insight-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon color="warn">info</mat-icon>
                إحصائيات المقارنة
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="insight-content">
              <div class="comparison-stats">
                <div class="stat-item">
                  <span class="stat-label">متوسط الكفاءة العام:</span>
                  <span class="stat-value"
                    >{{ getAverageEfficiency().toFixed(2) }} موعد/ساعة</span
                  >
                </div>
                <div class="stat-item">
                  <span class="stat-label">متوسط التقييم:</span>
                  <span class="stat-value"
                    >{{ getAverageRating().toFixed(1) }}/5</span
                  >
                </div>
                <div class="stat-item">
                  <span class="stat-label">أعلى إيرادات شهرية:</span>
                  <span class="stat-value">{{
                    formatCurrency(getHighestRevenue())
                  }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">معدل إنجاز المواعيد:</span>
                  <span class="stat-value">{{
                    formatPercentage(getOverallCompletionRate())
                  }}</span>
                </div>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</app-sidebar>
