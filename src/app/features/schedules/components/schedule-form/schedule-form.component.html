<div class="schedule-form-container">
  <app-header></app-header>
  <app-sidebar>
    <div class="content-area">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-content">
          <button mat-icon-button (click)="onCancel()" class="back-button">
            <mat-icon>arrow_forward</mat-icon>
          </button>
          <div class="header-text">
            <h1>
              <mat-icon>{{ isEditMode() ? "edit" : "add" }}</mat-icon>
              {{ pageTitle() }}
            </h1>
            <p class="subtitle">{{ pageSubtitle() }}</p>
          </div>
        </div>
      </div>

      <!-- Edit Mode Warning -->
      @if (isEditMode() && showEditWarning()) {
      <mat-card class="warning-card">
        <mat-card-content>
          <div class="warning-content">
            <mat-icon>warning</mat-icon>
            <div class="warning-text">
              <h3>تنبيه: تعديل جدول موجود</h3>
              <p>
                تعديل هذا الجدول قد يؤثر على المواعيد المستقبلية. المواعيد
                الموجودة ستحتفظ بمدتها الأصلية ما لم يتم تحديثها يدوياً.
              </p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
      }

      <!-- Loading State -->
      @if (loading()) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>جارٍ تحميل بيانات الجدول...</p>
      </div>
      }

      <!-- Form Content -->
      @if (!loading()) {
      <mat-horizontal-stepper linear #stepper>
        <!-- Step 1: Doctor Selection -->
        <mat-step [stepControl]="doctorForm" label="اختيار الطبيب">
          <div class="step-content">
            <h2 class="step-title">
              <mat-icon>medical_services</mat-icon>
              اختر الطبيب
            </h2>

            @if (isEditMode()) {
            <mat-card class="info-card">
              <mat-card-content>
                <div class="info-message">
                  <mat-icon>info</mat-icon>
                  <p>
                    لا يمكن تغيير الطبيب عند تعديل الجدول. لإنشاء جدول لطبيب
                    آخر، يرجى إنشاء جدول جديد.
                  </p>
                </div>
              </mat-card-content>
            </mat-card>
            }

            <form [formGroup]="doctorForm">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>الطبيب</mat-label>
                <input
                  type="text"
                  matInput
                  formControlName="doctorSearch"
                  [matAutocomplete]="autoDoctor"
                  required
                />
                <mat-icon matPrefix>search</mat-icon>
                <mat-autocomplete
                  #autoDoctor="matAutocomplete"
                  [displayWith]="displayDoctor"
                  (optionSelected)="onDoctorSelected($event)"
                >
                  @for (doctor of filteredDoctors$ | async; track doctor.id) {
                  <mat-option [value]="doctor">
                    <div class="doctor-option">
                      <span class="doctor-name">{{ doctor.fullName }}</span>
                      @if (doctor.specialization) {
                      <span class="doctor-spec">{{
                        doctor.specialization
                      }}</span>
                      }
                    </div>
                  </mat-option>
                  }
                </mat-autocomplete>
                @if (doctorForm.get('doctorId')?.hasError('required') &&
                doctorForm.get('doctorId')?.touched) {
                <mat-error>يرجى اختيار الطبيب</mat-error>
                }
              </mat-form-field>

              @if (selectedDoctor()) {
              <mat-card class="selected-doctor-card">
                <mat-card-content>
                  <div class="selected-doctor">
                    <mat-icon>check_circle</mat-icon>
                    <div class="doctor-info">
                      <h3>{{ selectedDoctor()!.fullName }}</h3>
                      @if (selectedDoctor()!.specialization) {
                      <p>{{ selectedDoctor()!.specialization }}</p>
                      }
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
              }
            </form>

            <div class="step-actions">
              <button
                mat-raised-button
                color="primary"
                matStepperNext
                [disabled]="doctorForm.invalid"
              >
                <span>التالي</span>
                <mat-icon>arrow_back</mat-icon>
              </button>
            </div>
          </div>
        </mat-step>

        <!-- Step 2: Working Days -->
        <mat-step [stepControl]="daysForm" label="أيام العمل">
          <div class="step-content">
            <h2 class="step-title">
              <mat-icon>event</mat-icon>
              اختر أيام العمل
            </h2>

            @if (isEditMode()) {
            <mat-card class="info-card">
              <mat-card-content>
                <div class="info-message">
                  <mat-icon>info</mat-icon>
                  <p>
                    في وضع التعديل، يمكنك فقط تعديل جدول اليوم المحدد. لإضافة
                    أيام أخرى، استخدم خاصية النسخ.
                  </p>
                </div>
              </mat-card-content>
            </mat-card>
            }

            <form [formGroup]="daysForm">
              <div class="days-grid">
                @for (day of availableDays; track day.value) {
                <button
                  type="button"
                  mat-stroked-button
                  class="day-button"
                  [class.selected]="isDaySelected(day.value)"
                  [disabled]="isEditMode()"
                  (click)="onDayToggle(day.value)"
                >
                  <mat-icon>{{
                    isDaySelected(day.value)
                      ? "check_circle"
                      : "radio_button_unchecked"
                  }}</mat-icon>
                  <span>{{ day.label }}</span>
                </button>
                }
              </div>

              @if (daysForm.get('workingDays')?.hasError('required') &&
              daysForm.get('workingDays')?.touched) {
              <p class="error-text">يرجى اختيار يوم عمل واحد على الأقل</p>
              } @if (selectedDays().length > 0) {
              <mat-card class="selected-days-card">
                <mat-card-content>
                  <h4>الأيام المختارة ({{ selectedDays().length }}):</h4>
                  <div class="selected-days-chips">
                    @for (day of selectedDays(); track day) {
                    <mat-chip color="primary" selected>
                      {{ getDayLabel(day) }}
                    </mat-chip>
                    }
                  </div>
                </mat-card-content>
              </mat-card>
              }
            </form>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_forward</mat-icon>
                <span>السابق</span>
              </button>
              <button
                mat-raised-button
                color="primary"
                matStepperNext
                [disabled]="daysForm.invalid"
              >
                <span>التالي</span>
                <mat-icon>arrow_back</mat-icon>
              </button>
            </div>
          </div>
        </mat-step>

        <!-- Step 3: Working Hours -->
        <mat-step [stepControl]="hoursForm" label="ساعات العمل">
          <div class="step-content">
            <h2 class="step-title">
              <mat-icon>schedule</mat-icon>
              حدد ساعات العمل
            </h2>

            <form [formGroup]="hoursForm">
              <div class="form-row">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>وقت البداية</mat-label>
                  <input
                    matInput
                    type="time"
                    formControlName="startTime"
                    required
                  />
                  <mat-icon matPrefix>access_time</mat-icon>
                  @if (hoursForm.get('startTime')?.hasError('required')) {
                  <mat-error>وقت البداية مطلوب</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>وقت النهاية</mat-label>
                  <input
                    matInput
                    type="time"
                    formControlName="endTime"
                    required
                  />
                  <mat-icon matPrefix>access_time</mat-icon>
                  @if (hoursForm.get('endTime')?.hasError('required')) {
                  <mat-error>وقت النهاية مطلوب</mat-error>
                  }
                </mat-form-field>
              </div>

              <mat-divider></mat-divider>

              <div class="break-section">
                <mat-checkbox formControlName="hasBreak">
                  إضافة فترة استراحة
                </mat-checkbox>

                @if (hoursForm.get('hasBreak')?.value) {
                <div class="form-row break-times">
                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>بداية الاستراحة</mat-label>
                    <input
                      matInput
                      type="time"
                      formControlName="breakStartTime"
                    />
                    <mat-icon matPrefix>local_cafe</mat-icon>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>نهاية الاستراحة</mat-label>
                    <input
                      matInput
                      type="time"
                      formControlName="breakEndTime"
                    />
                    <mat-icon matPrefix>local_cafe</mat-icon>
                  </mat-form-field>
                </div>
                }
              </div>

              @if (availableMinutes() !== null) {
              <mat-card class="preview-card">
                <mat-card-content>
                  <div class="preview-info">
                    <mat-icon>info</mat-icon>
                    <div class="preview-details">
                      <p class="preview-label">وقت العمل المتاح:</p>
                      <p class="preview-value">
                        {{ availableMinutes() }} دقيقة
                      </p>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
              }
            </form>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_forward</mat-icon>
                <span>السابق</span>
              </button>
              <button
                mat-raised-button
                color="primary"
                matStepperNext
                [disabled]="hoursForm.invalid"
              >
                <span>التالي</span>
                <mat-icon>arrow_back</mat-icon>
              </button>
            </div>
          </div>
        </mat-step>

        <!-- Step 4: Duration Configuration -->
        <mat-step [stepControl]="durationForm" label="تكوين المدة">
          <div class="step-content">
            <h2 class="step-title">
              <mat-icon>timer</mat-icon>
              تكوين مدة المواعيد
            </h2>

            <form [formGroup]="durationForm">
              <!-- Duration Configuration Type -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>نوع التكوين</mat-label>
                <mat-select formControlName="durationConfigType" required>
                  @for (type of durationConfigTypes; track type.value) {
                  <mat-option [value]="type.value">
                    {{ type.label }}
                  </mat-option>
                  }
                </mat-select>
                <mat-icon matPrefix>settings</mat-icon>
                <mat-hint>اختر كيفية تحديد مدة كل موعد</mat-hint>
              </mat-form-field>

              <!-- DIRECT Configuration -->
              @if (durationForm.get('durationConfigType')?.value === 'DIRECT') {
              <div class="duration-config-section">
                <h3>
                  <mat-icon>timer</mat-icon>
                  تحديد المدة مباشرة
                </h3>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>مدة كل موعد (دقائق)</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="durationMinutes"
                    min="5"
                    max="240"
                    step="5"
                    required
                  />
                  <mat-icon matPrefix>access_time</mat-icon>
                  <mat-hint>أدخل المدة بالدقائق (5-240)</mat-hint>
                  @if
                  (durationForm.get('durationMinutes')?.hasError('required')) {
                  <mat-error>المدة مطلوبة</mat-error>
                  } @if (durationForm.get('durationMinutes')?.hasError('min')) {
                  <mat-error>المدة يجب أن تكون 5 دقائق على الأقل</mat-error>
                  } @if (durationForm.get('durationMinutes')?.hasError('max')) {
                  <mat-error>المدة يجب ألا تتجاوز 240 دقيقة</mat-error>
                  }
                </mat-form-field>

                <!-- Preview: Expected Tokens -->
                @if (expectedTokens() !== null && availableMinutes() !== null) {
                <mat-card class="preview-card">
                  <mat-card-content>
                    <div class="preview-info">
                      <mat-icon>info</mat-icon>
                      <div class="preview-details">
                        <p class="preview-label">
                          عدد المواعيد المتوقع في اليوم:
                        </p>
                        <p class="preview-value">{{ expectedTokens() }} موعد</p>
                        <p class="preview-hint">
                          ({{ availableMinutes() }} دقيقة متاحة ÷
                          {{
                            durationForm.get("durationMinutes")?.value
                          }}
                          دقيقة)
                        </p>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>
                }
              </div>
              }

              <!-- TOKEN_BASED Configuration -->
              @if (durationForm.get('durationConfigType')?.value ===
              'TOKEN_BASED') {
              <div class="duration-config-section">
                <h3>
                  <mat-icon>calculate</mat-icon>
                  حساب المدة من عدد المواعيد
                </h3>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>عدد المواعيد المستهدف في اليوم</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="targetTokensPerDay"
                    min="1"
                    max="100"
                    required
                  />
                  <mat-icon matPrefix>confirmation_number</mat-icon>
                  <mat-hint
                    >أدخل عدد المواعيد التي يجب أن يستقبلها الطبيب
                    يومياً</mat-hint
                  >
                  @if
                  (durationForm.get('targetTokensPerDay')?.hasError('required'))
                  {
                  <mat-error>عدد المواعيد مطلوب</mat-error>
                  } @if
                  (durationForm.get('targetTokensPerDay')?.hasError('min')) {
                  <mat-error>العدد يجب أن يكون 1 على الأقل</mat-error>
                  } @if
                  (durationForm.get('targetTokensPerDay')?.hasError('max')) {
                  <mat-error>العدد يجب ألا يتجاوز 100</mat-error>
                  }
                </mat-form-field>

                <!-- Preview: Calculated Duration -->
                @if (calculatedDuration() !== null && availableMinutes() !==
                null) {
                <mat-card class="preview-card success">
                  <mat-card-content>
                    <div class="preview-info">
                      <mat-icon>check_circle</mat-icon>
                      <div class="preview-details">
                        <p class="preview-label">مدة كل موعد المحسوبة:</p>
                        <p class="preview-value large">
                          {{ calculatedDuration() }} دقيقة
                        </p>
                        <p class="preview-hint">
                          ({{ availableMinutes() }} دقيقة متاحة ÷
                          {{
                            durationForm.get("targetTokensPerDay")?.value
                          }}
                          موعد)
                        </p>
                      </div>
                    </div>
                  </mat-card-content>
                </mat-card>
                } @if (availableMinutes() === null) {
                <mat-card class="preview-card warning">
                  <mat-card-content>
                    <div class="preview-info">
                      <mat-icon>warning</mat-icon>
                      <p>يرجى إكمال ساعات العمل أولاً لحساب المدة</p>
                    </div>
                  </mat-card-content>
                </mat-card>
                }
              </div>
              }
            </form>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_forward</mat-icon>
                <span>السابق</span>
              </button>
              <button
                mat-raised-button
                color="primary"
                matStepperNext
                [disabled]="durationForm.invalid"
              >
                <span>التالي</span>
                <mat-icon>arrow_back</mat-icon>
              </button>
            </div>
          </div>
        </mat-step>

        <!-- Step 5: Settings -->
        <mat-step [stepControl]="settingsForm" label="الإعدادات">
          <div class="step-content">
            <h2 class="step-title">
              <mat-icon>settings</mat-icon>
              إعدادات إضافية
            </h2>

            <form [formGroup]="settingsForm">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>نوع الجدول</mat-label>
                <mat-select formControlName="scheduleType" required>
                  @for (type of scheduleTypes; track type.value) {
                  <mat-option [value]="type.value">
                    {{ type.label }}
                  </mat-option>
                  }
                </mat-select>
                <mat-icon matPrefix>category</mat-icon>
              </mat-form-field>

              <div class="form-row">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>تاريخ البداية</mat-label>
                  <input
                    matInput
                    [matDatepicker]="pickerStart"
                    formControlName="effectiveDate"
                  />
                  <mat-icon matPrefix>calendar_today</mat-icon>
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="pickerStart"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #pickerStart></mat-datepicker>
                  <mat-hint>اختياري - اترك فارغاً للبدء فوراً</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>تاريخ الانتهاء</mat-label>
                  <input
                    matInput
                    [matDatepicker]="pickerEnd"
                    formControlName="endDate"
                  />
                  <mat-icon matPrefix>calendar_today</mat-icon>
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="pickerEnd"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #pickerEnd></mat-datepicker>
                  <mat-hint>اختياري - للجداول المؤقتة</mat-hint>
                </mat-form-field>
              </div>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>ملاحظات</mat-label>
                <textarea
                  matInput
                  formControlName="notes"
                  rows="3"
                  placeholder="أي ملاحظات إضافية عن هذا الجدول"
                ></textarea>
                <mat-icon matPrefix>note</mat-icon>
              </mat-form-field>
            </form>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_forward</mat-icon>
                <span>السابق</span>
              </button>
              <button
                mat-raised-button
                color="primary"
                (click)="onSubmit()"
                [disabled]="submitting()"
              >
                @if (submitting()) {
                <mat-spinner diameter="20"></mat-spinner>
                } @else {
                <mat-icon>{{ isEditMode() ? "save" : "add" }}</mat-icon>
                }
                <span>{{ submitButtonText() }}</span>
              </button>
            </div>
          </div>
        </mat-step>
      </mat-horizontal-stepper>
      }
    </div>
  </app-sidebar>
</div>
